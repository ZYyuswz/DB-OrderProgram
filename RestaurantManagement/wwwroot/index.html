<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐饮管理系统 - 商家端</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar">
        <h1>餐饮管理系统</h1>
        <div class="nav-links">
            <a href="index.html" class="active">首页</a>
            <a href="tables.html">桌台管理</a>
            <a href="orders.html">订单管理</a>
            <a href="menu.html">菜单管理</a>
            <a href="staff.html">员工管理</a>
            <a href="inventory.html">库存管理</a>
        </div>
    </nav>

    <div class="container">
        <div class="main-content">
            <h2>欢迎使用餐饮管理系统</h2>
            <p>请选择相应的功能模块进行管理操作。</p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-top: 2rem;">
                <!-- 桌台管理卡片 -->
                <div class="card">
                    <h3>🍽️ 桌台管理</h3>
                    <p>实时查看桌台状态，管理开台、清台操作</p>
                    <div style="margin-top: 1rem;">
                        <span class="status-badge status-available">空闲: <span id="available-tables">-</span></span>
                        <span class="status-badge status-occupied">占用: <span id="occupied-tables">-</span></span>
                        <span class="status-badge status-cleaning">清洁中: <span id="cleaning-tables">-</span></span>
                    </div>
                    <div style="margin-top: 1rem;">
                        <a href="tables.html" class="btn btn-primary">进入管理</a>
                    </div>
                </div>

                <!-- 订单管理卡片 -->
                <div class="card">
                    <h3>📋 订单管理</h3>
                    <p>查看订单详情，处理加菜、结账等操作</p>
                    <div style="margin-top: 1rem;">
                        <p>今日订单数: <strong id="today-orders">-</strong></p>
                        <p>今日营业额: <strong id="today-revenue">-</strong></p>
                    </div>
                    <div style="margin-top: 1rem;">
                        <a href="orders.html" class="btn btn-primary">进入管理</a>
                    </div>
                </div>

                <!-- 菜单管理卡片 -->
                <div class="card">
                    <h3>🍜 菜单管理</h3>
                    <p>管理菜品分类、菜品信息和价格</p>
                    <div style="margin-top: 1rem;">
                        <p>菜品总数: <strong id="total-dishes">-</strong></p>
                        <p>可售菜品: <strong id="available-dishes">-</strong></p>
                    </div>
                    <div style="margin-top: 1rem;">
                        <a href="menu.html" class="btn btn-primary">进入管理</a>
                    </div>
                </div>

                <!-- 员工管理卡片 -->
                <div class="card">
                    <h3>👥 员工管理</h3>
                    <p>管理员工信息、排班和考勤记录</p>
                    <div style="margin-top: 1rem;">
                        <p>在职员工: <strong id="active-staff">-</strong></p>
                        <p>今日出勤: <strong id="today-attendance">-</strong></p>
                    </div>
                    <div style="margin-top: 1rem;">
                        <a href="staff.html" class="btn btn-primary">进入管理</a>
                    </div>
                </div>

                <!-- 库存管理卡片 -->
                <div class="card">
                    <h3>📦 库存管理</h3>
                    <p>监控原材料库存，管理采购和入库</p>
                    <div style="margin-top: 1rem;">
                        <span class="status-badge status-available">库存正常: <span id="normal-stock">-</span></span>
                        <span class="status-badge status-occupied">库存不足: <span id="low-stock">-</span></span>
                    </div>
                    <div style="margin-top: 1rem;">
                        <a href="inventory.html" class="btn btn-primary">进入管理</a>
                    </div>
                </div>

                <!-- 系统状态卡片 -->
                <div class="card">
                    <h3>⚙️ 系统状态</h3>
                    <p>查看系统运行状态和Oracle数据库连接</p>
                    <div style="margin-top: 1rem;">
                        <p>Oracle数据库: <span id="db-status" class="status-badge">检测中...</span></p>
                        <p>系统时间: <span id="system-time">-</span></p>
                        <p>数据库用户: <span id="db-user">XCY</span></p>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button onclick="checkSystemStatus()" class="btn btn-secondary">刷新状态</button>
                        <button onclick="showDatabaseInfo()" class="btn btn-info" style="margin-left: 0.5rem;">数据库信息</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // 页面加载时获取统计数据
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            updateSystemTime();
            setInterval(updateSystemTime, 1000); // 每秒更新时间
        });

        async function loadDashboardData() {
            try {
                // 获取桌台统计
                const tables = await API.get('/tables');
                if (tables) {
                    updateTableStats(tables);
                }

                // 获取今日订单统计
                await loadTodayOrderStats();

                // 获取菜品统计
                const dishes = await API.get('/menu/dishes');
                if (dishes) {
                    updateDishStats(dishes);
                }

                // 获取员工统计
                const staff = await API.get('/staff');
                if (staff) {
                    updateStaffStats(staff);
                }

                // 获取库存统计
                const materials = await API.get('/inventory');
                if (materials) {
                    updateInventoryStats(materials);
                }

                // 检查数据库连接状态
                checkSystemStatus();

            } catch (error) {
                console.error('加载仪表板数据时出错:', error);
                Utils.showNotification('加载数据失败，请检查网络连接', 'error');
            }
        }

        function updateTableStats(tables) {
            const availableCount = tables.filter(t => t.status === '空闲').length;
            const occupiedCount = tables.filter(t => t.status === '占用').length;
            const cleaningCount = tables.filter(t => t.status === '清洁中').length;

            document.getElementById('available-tables').textContent = availableCount;
            document.getElementById('occupied-tables').textContent = occupiedCount;
            document.getElementById('cleaning-tables').textContent = cleaningCount;
        }

        async function loadTodayOrderStats() {
            try {
                const orders = await API.get('/orders');
                if (orders) {
                    const today = new Date().toDateString();
                    const todayOrders = orders.filter(o => 
                        new Date(o.orderTime).toDateString() === today
                    );
                    
                    const todayRevenue = todayOrders
                        .filter(o => o.orderStatus === '已结账')
                        .reduce((sum, o) => sum + o.totalAmount, 0);

                    document.getElementById('today-orders').textContent = todayOrders.length;
                    document.getElementById('today-revenue').textContent = Utils.formatCurrency(todayRevenue);
                }
            } catch (error) {
                console.error('获取今日订单统计失败:', error);
            }
        }

        function updateDishStats(dishes) {
            const totalDishes = dishes.length;
            const availableDishes = dishes.filter(d => d.isAvailable).length;

            document.getElementById('total-dishes').textContent = totalDishes;
            document.getElementById('available-dishes').textContent = availableDishes;
        }

        function updateStaffStats(staff) {
            const activeStaff = staff.filter(s => s.status === '在职').length;
            document.getElementById('active-staff').textContent = activeStaff;

            // TODO: 获取今日出勤统计
            document.getElementById('today-attendance').textContent = '-';
        }

        function updateInventoryStats(materials) {
            const normalStock = materials.filter(m => !m.isLowStock).length;
            const lowStock = materials.filter(m => m.isLowStock).length;

            document.getElementById('normal-stock').textContent = normalStock;
            document.getElementById('low-stock').textContent = lowStock;
        }

        async function checkSystemStatus() {
            const statusElement = document.getElementById('db-status');
            statusElement.innerHTML = '<div class="loading"></div> 检测中...';
            statusElement.className = 'status-badge';

            try {
                const result = await API.get('/database/test-connection');
                if (result && result.success) {
                    statusElement.textContent = '连接正常';
                    statusElement.className = 'status-badge status-available';
                    Utils.showNotification('Oracle数据库连接正常', 'success');
                } else {
                    statusElement.textContent = '连接异常';
                    statusElement.className = 'status-badge status-danger';
                    Utils.showNotification('Oracle数据库连接异常', 'error');
                }
            } catch (error) {
                statusElement.textContent = '连接失败';
                statusElement.className = 'status-badge status-danger';
                Utils.showNotification('Oracle数据库连接失败', 'error');
                console.error('数据库连接测试失败:', error);
            }
        }

        async function showDatabaseInfo() {
            try {
                const result = await API.get('/database/info');
                if (result && result.success) {
                    const info = result.info;
                    alert(`Oracle数据库信息:
                    
版本: ${info.version}
当前用户: ${info.currentUser}
服务器时间: ${new Date(info.serverTime).toLocaleString('zh-CN')}
连接地址: ${info.connectionString}

本地时间: ${new Date().toLocaleString('zh-CN')}`);
                } else {
                    Utils.showNotification('获取数据库信息失败', 'error');
                }
            } catch (error) {
                Utils.showNotification('获取数据库信息失败', 'error');
                console.error('获取数据库信息失败:', error);
            }
        }

        function updateSystemTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('system-time').textContent = timeString;
        }
    </script>
</body>
</html>
