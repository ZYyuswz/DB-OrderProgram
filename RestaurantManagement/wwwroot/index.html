<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤é¥®ç®¡ç†ç³»ç»Ÿ - å•†å®¶ç«¯</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* æƒé™å—é™æ—¶çš„æ ·å¼ */
        .permission-restricted {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }
        
        .permission-restricted::after {
            content: 'ğŸ”’ æƒé™ä¸è¶³';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.8rem;
            z-index: 10;
        }

        /* ç”¨æˆ·è§’è‰²å¾½ç« æ ·å¼ */
        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            color: white;
            margin-left: 0.5rem;
        }

        .role-admin {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .role-manager {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .role-cashier {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>é¤é¥®ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="nav-links">
            <a href="index.html" class="active">é¦–é¡µ</a>
            <a href="tables.html" data-permission="tables">æ¡Œå°ç®¡ç†</a>
            <a href="orders.html" data-permission="orders">è®¢å•ç®¡ç†</a>
            <a href="menu.html" data-permission="menu">èœå•ç®¡ç†</a>
            <a href="staff.html" data-permission="staff">å‘˜å·¥ç®¡ç†</a>
            <a href="inventory.html" data-permission="inventory">åº“å­˜ç®¡ç†</a>
        </div>
    </nav>

    <div class="container">
        <div class="main-content">
            <div id="welcomeMessage">
                <h2>æ¬¢è¿ä½¿ç”¨é¤é¥®ç®¡ç†ç³»ç»Ÿ</h2>
                <p>è¯·é€‰æ‹©ç›¸åº”çš„åŠŸèƒ½æ¨¡å—è¿›è¡Œç®¡ç†æ“ä½œã€‚</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-top: 2rem;">
                <!-- æ¡Œå°ç®¡ç†å¡ç‰‡ -->
                <div class="card" data-permission="tables">
                    <h3>ğŸ½ï¸ æ¡Œå°ç®¡ç†</h3>
                    <p>å®æ—¶æŸ¥çœ‹æ¡Œå°çŠ¶æ€ï¼Œç®¡ç†å¼€å°ã€æ¸…å°æ“ä½œ</p>
                    <div style="margin-top: 1rem;">
                        <span class="status-badge status-available">ç©ºé—²: <span id="available-tables">-</span></span>
                        <span class="status-badge status-occupied">å ç”¨: <span id="occupied-tables">-</span></span>
                        <span class="status-badge status-cleaning">æ¸…æ´ä¸­: <span id="cleaning-tables">-</span></span>
                    </div>
                    <div style="margin-top: 1rem;">
                        <a href="tables.html" class="btn btn-primary">è¿›å…¥ç®¡ç†</a>
                    </div>
                </div>

                <!-- è®¢å•ç®¡ç†å¡ç‰‡ -->
                <div class="card" data-permission="orders">
                    <h3>ğŸ“‹ è®¢å•ç®¡ç†</h3>
                    <p>æŸ¥çœ‹è®¢å•è¯¦æƒ…ï¼Œå¤„ç†åŠ èœã€ç»“è´¦ç­‰æ“ä½œ</p>
                    <div style="margin-top: 1rem;">
                        <p>ä»Šæ—¥è®¢å•æ•°: <strong id="today-orders">-</strong></p>
                        <p>ä»Šæ—¥è¥ä¸šé¢: <strong id="today-revenue">-</strong></p>
                    </div>
                    <div style="margin-top: 1rem;">
                        <a href="orders.html" class="btn btn-primary">è¿›å…¥ç®¡ç†</a>
                    </div>
                </div>

                <!-- èœå•ç®¡ç†å¡ç‰‡ -->
                <div class="card" data-permission="menu">
                    <h3>ğŸœ èœå•ç®¡ç†</h3>
                    <p>ç®¡ç†èœå“åˆ†ç±»ã€èœå“ä¿¡æ¯å’Œä»·æ ¼</p>
                    <div style="margin-top: 1rem;">
                        <p>èœå“æ€»æ•°: <strong id="total-dishes">-</strong></p>
                        <p>å¯å”®èœå“: <strong id="available-dishes">-</strong></p>
                    </div>
                    <div style="margin-top: 1rem;">
                        <a href="menu.html" class="btn btn-primary">è¿›å…¥ç®¡ç†</a>
                    </div>
                </div>

                <!-- å‘˜å·¥ç®¡ç†å¡ç‰‡ -->
                <div class="card" data-permission="staff">
                    <h3>ğŸ‘¥ å‘˜å·¥ç®¡ç†</h3>
                    <p>ç®¡ç†å‘˜å·¥ä¿¡æ¯ã€æ’ç­å’Œè€ƒå‹¤è®°å½•</p>
                    <div style="margin-top: 1rem;">
                        <p>åœ¨èŒå‘˜å·¥: <strong id="active-staff">-</strong></p>
                        <p>ä»Šæ—¥å‡ºå‹¤: <strong id="today-attendance">-</strong></p>
                    </div>
                    <div style="margin-top: 1rem;">
                        <a href="staff.html" class="btn btn-primary">è¿›å…¥ç®¡ç†</a>
                    </div>
                </div>

                <!-- åº“å­˜ç®¡ç†å¡ç‰‡ -->
                <div class="card" data-permission="inventory">
                    <h3>ğŸ“¦ åº“å­˜ç®¡ç†</h3>
                    <p>ç›‘æ§åŸææ–™åº“å­˜ï¼Œç®¡ç†é‡‡è´­å’Œå…¥åº“</p>
                    <div style="margin-top: 1rem;">
                        <span class="status-badge status-available">åº“å­˜æ­£å¸¸: <span id="normal-stock">-</span></span>
                        <span class="status-badge status-occupied">åº“å­˜ä¸è¶³: <span id="low-stock">-</span></span>
                    </div>
                    <div style="margin-top: 1rem;">
                        <a href="inventory.html" class="btn btn-primary">è¿›å…¥ç®¡ç†</a>
                    </div>
                </div>

                <!-- ç³»ç»ŸçŠ¶æ€å¡ç‰‡ - æ‰€æœ‰è§’è‰²éƒ½å¯ä»¥çœ‹åˆ° -->
                <div class="card">
                    <h3>âš™ï¸ ç³»ç»ŸçŠ¶æ€</h3>
                    <p>æŸ¥çœ‹ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’ŒOracleæ•°æ®åº“è¿æ¥</p>
                    <div style="margin-top: 1rem;">
                        <p>Oracleæ•°æ®åº“: <span id="db-status" class="status-badge">æ£€æµ‹ä¸­...</span></p>
                        <p>ç³»ç»Ÿæ—¶é—´: <span id="system-time">-</span></p>
                        <p>æ•°æ®åº“ç”¨æˆ·: <span id="db-user">XCY</span></p>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button onclick="checkSystemStatus()" class="btn btn-secondary">åˆ·æ–°çŠ¶æ€</button>
                        <button onclick="showDatabaseInfo()" class="btn btn-info" style="margin-left: 0.5rem;" data-permission="staff">æ•°æ®åº“ä¿¡æ¯</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // é¡µé¢åŠ è½½æ—¶è·å–ç»Ÿè®¡æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®ä¸ªæ€§åŒ–æ¬¢è¿ä¿¡æ¯
            setWelcomeMessage();
            
            loadDashboardData();
            updateSystemTime();
            setInterval(updateSystemTime, 1000); // æ¯ç§’æ›´æ–°æ—¶é—´
        });

        // è®¾ç½®ä¸ªæ€§åŒ–æ¬¢è¿ä¿¡æ¯
        function setWelcomeMessage() {
            const user = Auth.getCurrentUser();
            if (!user) return;

            const welcomeElement = document.getElementById('welcomeMessage');
            let roleDescription = '';
            let availableFeatures = '';
            let roleClass = '';

            switch(user.role) {
                case 'è¶…çº§ç®¡ç†å‘˜':
                    roleDescription = 'æ‚¨æ‹¥æœ‰ç³»ç»Ÿçš„å®Œæ•´ç®¡ç†æƒé™';
                    availableFeatures = 'å¯ä»¥ç®¡ç†æ‰€æœ‰åŠŸèƒ½æ¨¡å—ï¼šå‘˜å·¥ç®¡ç†ã€åº“å­˜ç®¡ç†ã€èœå•ç®¡ç†ã€æ¡Œå°ç®¡ç†ã€è®¢å•ç®¡ç†ç­‰ã€‚';
                    roleClass = 'role-admin';
                    break;
                case 'åº—é•¿':
                    roleDescription = 'æ‚¨æ‹¥æœ‰æ—¥å¸¸ç»è¥ç®¡ç†æƒé™';
                    availableFeatures = 'å¯ä»¥ç®¡ç†ï¼šå‘˜å·¥ä¿¡æ¯ã€åº“å­˜é‡‡è´­ã€èœå•è®¾ç½®ã€æ¡Œå°çŠ¶æ€ã€è®¢å•å¤„ç†ç­‰åŠŸèƒ½ã€‚';
                    roleClass = 'role-manager';
                    break;
                case 'æ”¶é“¶å‘˜':
                    roleDescription = 'æ‚¨æ‹¥æœ‰å‰å°æ“ä½œæƒé™';
                    availableFeatures = 'å¯ä»¥è¿›è¡Œï¼šæ¡Œå°ç®¡ç†ã€è®¢å•å¤„ç†ã€åŸºç¡€æ•°æ®æŸ¥çœ‹ç­‰æ“ä½œã€‚';
                    roleClass = 'role-cashier';
                    break;
                default:
                    roleDescription = 'æ¬¢è¿ä½¿ç”¨é¤é¥®ç®¡ç†ç³»ç»Ÿ';
                    availableFeatures = 'è¯·é€‰æ‹©ç›¸åº”çš„åŠŸèƒ½æ¨¡å—è¿›è¡Œç®¡ç†æ“ä½œã€‚';
                    roleClass = 'role-admin';
            }

            welcomeElement.innerHTML = `
                <h2>æ¬¢è¿ä½¿ç”¨é¤é¥®ç®¡ç†ç³»ç»Ÿï¼Œ${user.username}ï¼<span class="role-badge ${roleClass}">${user.role}</span></h2>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                    <p style="margin: 0; font-size: 1.1rem; font-weight: 500;">
                        <span style="font-size: 1.2rem;">ğŸ‘‹</span> ${roleDescription}
                    </p>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.95rem;">
                        ${availableFeatures}
                    </p>
                </div>
            `;
        }

        async function loadDashboardData() {
            try {
                const user = Auth.getCurrentUser();
                if (!user) return;

                // è·å–æ¡Œå°ç»Ÿè®¡ - æ‰€æœ‰è§’è‰²éƒ½æœ‰æ¡Œå°æƒé™
                if (Auth.hasPermission('tables')) {
                    const tables = await API.get('/tables');
                    if (tables) {
                        updateTableStats(tables);
                    }
                }

                // è·å–ä»Šæ—¥è®¢å•ç»Ÿè®¡ - æ‰€æœ‰è§’è‰²éƒ½æœ‰è®¢å•æƒé™
                if (Auth.hasPermission('orders')) {
                    await loadTodayOrderStats();
                }

                // è·å–èœå“ç»Ÿè®¡ - åªæœ‰æœ‰èœå•æƒé™çš„ç”¨æˆ·
                if (Auth.hasPermission('menu')) {
                    const dishes = await API.get('/menu/dishes');
                    if (dishes) {
                        updateDishStats(dishes);
                    }
                }

                // è·å–å‘˜å·¥ç»Ÿè®¡ - åªæœ‰æœ‰å‘˜å·¥æƒé™çš„ç”¨æˆ·
                if (Auth.hasPermission('staff')) {
                    const staff = await API.get('/staff');
                    if (staff) {
                        updateStaffStats(staff);
                    }
                }

                // è·å–åº“å­˜ç»Ÿè®¡ - åªæœ‰æœ‰åº“å­˜æƒé™çš„ç”¨æˆ·
                if (Auth.hasPermission('inventory')) {
                    const materials = await API.get('/inventory');
                    if (materials) {
                        updateInventoryStats(materials);
                    }
                }

                // æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€ - æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥çœ‹åˆ°
                checkSystemStatus();

            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨æ¿æ•°æ®æ—¶å‡ºé”™:', error);
                Utils.showNotification('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
        }

        function updateTableStats(tables) {
            const availableCount = tables.filter(t => t.Status === 'ç©ºé—²').length;
            const occupiedCount = tables.filter(t => t.Status === 'å ç”¨').length;
            const cleaningCount = tables.filter(t => t.Status === 'æ¸…æ´ä¸­').length;
            document.getElementById('available-tables').textContent = availableCount;
            document.getElementById('occupied-tables').textContent = occupiedCount;
            document.getElementById('cleaning-tables').textContent = cleaningCount;
        }

        async function loadTodayOrderStats() {
            try {
                const orders = await API.get('/orders');
                if (orders) {
                    const today = new Date().toDateString();
                    const todayOrders = orders.filter(o => 
                        new Date(o.orderTime).toDateString() === today
                    );
                    
                    const todayRevenue = todayOrders
                        .filter(o => o.orderStatus === 'å·²ç»“è´¦')
                        .reduce((sum, o) => sum + o.totalAmount, 0);

                    document.getElementById('today-orders').textContent = todayOrders.length;
                    document.getElementById('today-revenue').textContent = Utils.formatCurrency(todayRevenue);
                }
            } catch (error) {
                console.error('è·å–ä»Šæ—¥è®¢å•ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        function updateDishStats(dishes) {
            const totalDishes = dishes.length;
            const availableDishes = dishes.filter(d => d.isAvailable).length;

            document.getElementById('total-dishes').textContent = totalDishes;
            document.getElementById('available-dishes').textContent = availableDishes;
        }

        function updateStaffStats(staff) {
            const activeStaff = staff.filter(s => s.status === 'åœ¨èŒ').length;
            document.getElementById('active-staff').textContent = activeStaff;

            // TODO: è·å–ä»Šæ—¥å‡ºå‹¤ç»Ÿè®¡
            document.getElementById('today-attendance').textContent = '-';
        }

        function updateInventoryStats(materials) {
            const normalStock = materials.filter(m => !m.isLowStock).length;
            const lowStock = materials.filter(m => m.isLowStock).length;

            document.getElementById('normal-stock').textContent = normalStock;
            document.getElementById('low-stock').textContent = lowStock;
        }

        async function checkSystemStatus() {
            const statusElement = document.getElementById('db-status');
            statusElement.innerHTML = '<div class="loading"></div> æ£€æµ‹ä¸­...';
            statusElement.className = 'status-badge';

            try {
                const result = await API.get('/database/test-connection');
                if (result && result.success) {
                    statusElement.textContent = 'è¿æ¥æ­£å¸¸';
                    statusElement.className = 'status-badge status-available';
                    Utils.showNotification('Oracleæ•°æ®åº“è¿æ¥æ­£å¸¸', 'success');
                } else {
                    statusElement.textContent = 'è¿æ¥å¼‚å¸¸';
                    statusElement.className = 'status-badge status-danger';
                    Utils.showNotification('Oracleæ•°æ®åº“è¿æ¥å¼‚å¸¸', 'error');
                }
            } catch (error) {
                statusElement.textContent = 'è¿æ¥å¤±è´¥';
                statusElement.className = 'status-badge status-danger';
                Utils.showNotification('Oracleæ•°æ®åº“è¿æ¥å¤±è´¥', 'error');
                console.error('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥:', error);
            }
        }

        async function showDatabaseInfo() {
            // æ£€æŸ¥æƒé™ - åªæœ‰ç®¡ç†å‘˜å’Œåº—é•¿å¯ä»¥æŸ¥çœ‹è¯¦ç»†æ•°æ®åº“ä¿¡æ¯
            if (!Auth.hasPermission('staff') && !Auth.hasPermission('all')) {
                Utils.showNotification('æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹æ•°æ®åº“è¯¦ç»†ä¿¡æ¯', 'error');
                return;
            }

            try {
                const result = await API.get('/database/info');
                if (result && result.success) {
                    const info = result.info;
                    alert(`Oracleæ•°æ®åº“ä¿¡æ¯:
                    
ç‰ˆæœ¬: ${info.version}
å½“å‰ç”¨æˆ·: ${info.currentUser}
æœåŠ¡å™¨æ—¶é—´: ${new Date(info.serverTime).toLocaleString('zh-CN')}
è¿æ¥åœ°å€: ${info.connectionString}

æœ¬åœ°æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`);
                } else {
                    Utils.showNotification('è·å–æ•°æ®åº“ä¿¡æ¯å¤±è´¥', 'error');
                }
            } catch (error) {
                Utils.showNotification('è·å–æ•°æ®åº“ä¿¡æ¯å¤±è´¥', 'error');
                console.error('è·å–æ•°æ®åº“ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        function updateSystemTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('system-time').textContent = timeString;
        }
    </script>
</body>
</html>
