<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•ç®¡ç† - é¤é¥®ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* è®¢å•è¯¦æƒ…æ¨¡æ€æ¡†æ ·å¼å¢å¼º */
        .table-responsive {
            -webkit-overflow-scrolling: touch;
        }
        
        .table-responsive::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* ç¡®ä¿æ¨¡æ€æ¡†å†…å®¹ä¸ä¼šè¢«æˆªæ–­ */
        .modal-content {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            max-height: calc(90vh - 120px);
        }
        
        /* ç²˜æ€§è¡¨å¤´æ ·å¼ */
        .table thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa !important;
            z-index: 10;
        }
        
        /* æœç´¢å»ºè®®ä¸‹æ‹‰æ¡†æ ·å¼ */
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .suggestion-item {
            padding: 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-main {
            font-weight: 500;
            color: #333;
        }
        
        .suggestion-detail {
            font-size: 0.85rem;
            color: #666;
        }
        
        /* é«˜äº®æœç´¢æ–‡æœ¬ */
        .highlight {
            background-color: #fff3cd;
            font-weight: bold;
        }
        
        /* æœç´¢ç»Ÿè®¡æ ·å¼ */
        #searchStats {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* è¡¨æ ¼æ’åºæ ·å¼ */
        .table th.sortable {
            position: relative;
            transition: background-color 0.2s ease;
        }
        
        .table th.sortable:hover {
            background-color: #e9ecef !important;
        }
        
        .sort-indicator {
            font-size: 0.8rem;
            font-weight: normal;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>é¤é¥®ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="nav-links">
            <a href="index.html">é¦–é¡µ</a>
            <a href="tables.html">æ¡Œå°ç®¡ç†</a>
            <a href="orders.html" class="active">è®¢å•ç®¡ç†</a>
            <a href="menu.html">èœå•ç®¡ç†</a>
            <a href="staff.html">å‘˜å·¥ç®¡ç†</a>
            <a href="inventory.html">åº“å­˜ç®¡ç†</a>
        </div>
    </nav>

    <div class="container">
        <div class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>è®¢å•ç®¡ç†</h2>
                <div>
                    <button onclick="refreshOrders()" class="btn btn-secondary">åˆ·æ–°æ•°æ®</button>
                    <button onclick="exportOrders()" class="btn btn-primary">å¯¼å‡ºæŠ¥è¡¨</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-orders">0</div>
                    <div class="stat-label">æ€»è®¢å•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="today-orders">0</div>
                    <div class="stat-label">ä»Šæ—¥è®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-orders">0</div>
                    <div class="stat-label">è¿›è¡Œä¸­è®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="today-revenue">Â¥0</div>
                    <div class="stat-label">ä»Šæ—¥è¥ä¸šé¢</div>
                </div>
            </div>

            <!-- æœç´¢å’Œè¿‡æ»¤å™¨ -->
            <div class="card">
                <h3>è®¢å•æŸ¥è¯¢</h3>
                <div class="search-filters">
                    <div class="form-group">
                        <label for="dateRange">æ—¥æœŸèŒƒå›´:</label>
                        <select id="dateRange" class="form-control" onchange="filterOrders()">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="today">ä»Šå¤©</option>
                            <option value="yesterday">æ˜¨å¤©</option>
                            <option value="week">æœ¬å‘¨</option>
                            <option value="month">æœ¬æœˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="statusFilter">è®¢å•çŠ¶æ€:</label>
                        <select id="statusFilter" class="form-control" onchange="filterOrders()">
                            <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="å¾…å¤„ç†">å¾…å¤„ç†</option>
                            <option value="åˆ¶ä½œä¸­">åˆ¶ä½œä¸­</option>
                            <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                            <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                            <option value="å·²ç»“è´¦">å·²ç»“è´¦</option>
                            <option value="å·²å–æ¶ˆ">å·²å–æ¶ˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tableFilter">æ¡Œå°å·:</label>
                        <div style="position: relative;">
                            <input type="text" id="tableFilter" class="form-control" placeholder="è¾“å…¥æ¡Œå°å· (æ”¯æŒæ¨¡ç³Šæœç´¢)" onkeyup="filterOrders()" oninput="showTableSuggestions()">
                            <div id="tableSuggestions" class="suggestions-dropdown" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="orderSearch">è®¢å•å·æœç´¢:</label>
                        <div style="position: relative;">
                            <input type="text" id="orderSearch" class="form-control" placeholder="è¾“å…¥è®¢å•å· (æ”¯æŒæ¨¡ç³Šæœç´¢)" onkeyup="filterOrders()" oninput="showOrderSuggestions()">
                            <div id="orderSuggestions" class="suggestions-dropdown" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="form-group" style="display: flex; align-items: end; gap: 0.5rem;">
                        <button onclick="clearAllFilters()" class="btn btn-secondary" style="height: fit-content;">æ¸…ç©ºç­›é€‰</button>
                        <button onclick="quickSearch()" class="btn btn-primary" style="height: fit-content;">å¿«é€Ÿæœç´¢</button>
                    </div>
                </div>
                
                <!-- æœç´¢ç»“æœç»Ÿè®¡ -->
                <div id="searchStats" style="margin-top: 1rem; padding: 0.5rem; background-color: #e7f3ff; border-radius: 0.25rem; display: none;">
                    <small id="searchStatsText" style="color: #0056b3;"></small>
                </div>
            </div>

            <!-- è®¢å•åˆ—è¡¨ -->
            <div class="card">
                <h3>è®¢å•åˆ—è¡¨</h3>
                <div style="overflow-x: auto;">
                    <table class="table" id="ordersTable">
                        <thead>
                            <tr>
                                <th style="cursor: pointer; user-select: none;" onclick="sortOrders('orderID')" title="ç‚¹å‡»æ’åº">
                                    è®¢å•å· 
                                    <span id="sort-orderID" style="margin-left: 5px;">
                                        <span style="color: #007bff;">â–¼</span>
                                    </span>
                                </th>
                                <th style="cursor: pointer; user-select: none;" onclick="sortOrders('tableID')" title="ç‚¹å‡»æ’åº">
                                    æ¡Œå°å· 
                                    <span id="sort-tableID" style="margin-left: 5px; color: #ccc;">â‡…</span>
                                </th>
                                <th style="cursor: pointer; user-select: none;" onclick="sortOrders('orderTime')" title="ç‚¹å‡»æ’åº">
                                    ä¸‹å•æ—¶é—´ 
                                    <span id="sort-orderTime" style="margin-left: 5px; color: #ccc;">â‡…</span>
                                </th>
                                <th>æœåŠ¡å‘˜</th>
                                <th style="cursor: pointer; user-select: none;" onclick="sortOrders('orderStatus')" title="ç‚¹å‡»æ’åº">
                                    è®¢å•çŠ¶æ€ 
                                    <span id="sort-orderStatus" style="margin-left: 5px; color: #ccc;">â‡…</span>
                                </th>
                                <th style="cursor: pointer; user-select: none;" onclick="sortOrders('totalAmount')" title="ç‚¹å‡»æ’åº">
                                    æ€»é‡‘é¢ 
                                    <span id="sort-totalAmount" style="margin-left: 5px; color: #ccc;">â‡…</span>
                                </th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- è®¢å•æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>

                <!-- åˆ†é¡µ -->
                <div class="pagination" id="pagination">
                    <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="orderDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="orderDetailTitle">è®¢å•è¯¦æƒ…</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="orderDetailBody">
                <!-- è®¢å•è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
            </div>
            <div class="modal-footer">
                <button onclick="Utils.hideModal('orderDetailModal')" class="btn btn-secondary">å…³é—­</button>
                <button id="printOrderBtn" onclick="printOrder()" class="btn btn-primary">æ‰“å°å°ç¥¨</button>
            </div>
        </div>
    </div>

    <!-- åŠ èœæ¨¡æ€æ¡† -->
    <div id="addDishModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä¸ºè®¢å•åŠ èœ</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="dishSelect">é€‰æ‹©èœå“:</label>
                    <select id="dishSelect" class="form-control" required>
                        <option value="">è¯·é€‰æ‹©èœå“</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dishQuantity">æ•°é‡:</label>
                    <input type="number" id="dishQuantity" class="form-control" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="specialRequests">ç‰¹æ®Šè¦æ±‚:</label>
                    <textarea id="specialRequests" class="form-control" rows="3" placeholder="å¦‚ï¼šä¸è¦è¾£ã€å¤šæ”¾é¦™èœç­‰"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="Utils.hideModal('addDishModal')" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="confirmAddDish()" class="btn btn-primary">ç¡®è®¤åŠ èœ</button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let allOrders = [];
        let filteredOrders = [];
        let currentPage = 1;
        const pageSize = 10;
        let currentOrderId = null;
        let dishes = [];
        let sortConfig = { field: 'orderID', direction: 'desc' }; // é»˜è®¤æŒ‰è®¢å•å·é™åºæ’åº

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
            loadDishes();
            setupEventListeners();
            updateSortIndicators(); // åˆå§‹åŒ–æ’åºæŒ‡ç¤ºå™¨
        });

        function setupEventListeners() {
            // æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.onclick = function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                };
            });
        }

        async function loadOrders() {
            try {
                allOrders = await API.get('/orders');
                filteredOrders = [...allOrders];
                applySorting(); // åº”ç”¨æ’åº
                renderOrdersTable();
                updateStatistics();
            } catch (error) {
                console.error('åŠ è½½è®¢å•æ•°æ®å¤±è´¥:', error);
                Utils.showNotification('åŠ è½½è®¢å•æ•°æ®å¤±è´¥', 'error');
            }
        }

        async function loadDishes() {
            try {
                const dishData = await API.get('/menu/dishes');
                dishes = dishData.filter(d => d.isAvailable);
                populateDishSelect();
            } catch (error) {
                console.error('åŠ è½½èœå“æ•°æ®å¤±è´¥:', error);
            }
        }

        function populateDishSelect() {
            const select = document.getElementById('dishSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©èœå“</option>';
            
            dishes.forEach(dish => {
                const option = document.createElement('option');
                option.value = dish.dishID;
                option.textContent = `${dish.dishName} - ${Utils.formatCurrency(dish.price)}`;
                option.dataset.price = dish.price;
                select.appendChild(option);
            });
        }

        function renderOrdersTable() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageOrders = filteredOrders.slice(startIndex, endIndex);

            if (pageOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">æš‚æ— è®¢å•æ•°æ®</td></tr>';
                return;
            }

            pageOrders.forEach(order => {
                const row = document.createElement('tr');
                const statusInfo = Utils.getStatusInfo(order.OrderStatus, 'order');
                
                row.innerHTML = `
                    <td>${order.OrderID}</td>
                    <td>æ¡Œå°${order.TableID || '-'}</td>
                    <td>${Utils.formatDateTime(order.OrderTime)}</td>
                    <td>${getStaffName(order.StaffID)}</td>
                    <td><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></td>
                    <td>${Utils.formatCurrency(order.TotalPrice || 0)}</td>
                    <td>
                        <button onclick="viewOrderDetails(${order.OrderID})" class="btn btn-primary" style="margin-right: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">è¯¦æƒ…</button>
                        ${(order.OrderStatus === 'è¿›è¡Œä¸­' || order.OrderStatus === 'åˆ¶ä½œä¸­') ? `
                            <button onclick="showAddDishModal(${order.OrderID})" class="btn btn-secondary" style="margin-right: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">åŠ èœ</button>
                            <button onclick="checkoutOrder(${order.OrderID})" class="btn btn-success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">ç»“è´¦</button>
                        ` : ''}
                        ${(order.OrderStatus === 'è¿›è¡Œä¸­' || order.OrderStatus === 'åˆ¶ä½œä¸­') ? `
                            <button onclick="cancelOrder(${order.OrderID})" class="btn btn-danger" style="margin-left: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">å–æ¶ˆ</button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });

            renderPagination();
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredOrders.length / pageSize);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            paginationHTML += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
            
            // é¡µç æŒ‰é’®
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="active">${i}</button>`;
                } else {
                    paginationHTML += `<button onclick="changePage(${i})">${i}</button>`;
                }
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            paginationHTML += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
            
            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredOrders.length / pageSize);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderOrdersTable();
        }

        function filterOrders() {
            const dateRange = document.getElementById('dateRange').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const tableFilter = document.getElementById('tableFilter').value.trim();
            const orderSearch = document.getElementById('orderSearch').value.trim();

            filteredOrders = allOrders.filter(order => {
                // æ—¥æœŸè¿‡æ»¤
                const orderDate = new Date(order.orderTime || order.OrderTime);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let dateMatch = true;
                if (dateRange === 'today') {
                    const orderDateOnly = new Date(orderDate);
                    orderDateOnly.setHours(0, 0, 0, 0);
                    dateMatch = orderDateOnly.getTime() === today.getTime();
                } else if (dateRange === 'yesterday') {
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    const orderDateOnly = new Date(orderDate);
                    orderDateOnly.setHours(0, 0, 0, 0);
                    dateMatch = orderDateOnly.getTime() === yesterday.getTime();
                } else if (dateRange === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    dateMatch = orderDate >= weekAgo;
                } else if (dateRange === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    dateMatch = orderDate >= monthAgo;
                }

                // çŠ¶æ€è¿‡æ»¤
                const orderStatus = order.orderStatus || order.OrderStatus;
                const statusMatch = statusFilter === 'all' || orderStatus === statusFilter;

                // æ¡Œå°è¿‡æ»¤ - å¢å¼ºæ¨¡ç³Šæœç´¢
                const tableId = order.tableID || order.TableID;
                let tableMatch = true;
                if (tableFilter) {
                    const tableStr = tableId ? tableId.toString() : '';
                    // æ”¯æŒå®Œå…¨åŒ¹é…å’Œéƒ¨åˆ†åŒ¹é…
                    tableMatch = tableStr.includes(tableFilter) || 
                               tableStr.toLowerCase().includes(tableFilter.toLowerCase()) ||
                               `æ¡Œå°${tableStr}`.includes(tableFilter) ||
                               `table${tableStr}`.toLowerCase().includes(tableFilter.toLowerCase());
                }

                // è®¢å•å·æœç´¢ - å¢å¼ºæ¨¡ç³Šæœç´¢
                const orderId = order.orderID || order.OrderID;
                let orderMatch = true;
                if (orderSearch) {
                    const orderStr = orderId.toString();
                    // æ”¯æŒå®Œå…¨åŒ¹é…ã€éƒ¨åˆ†åŒ¹é…å’Œå¸¦#å‰ç¼€çš„æœç´¢
                    orderMatch = orderStr.includes(orderSearch) ||
                               orderStr.toLowerCase().includes(orderSearch.toLowerCase()) ||
                               `#${orderStr}`.includes(orderSearch) ||
                               orderSearch.replace('#', '') === orderStr;
                }

                return dateMatch && statusMatch && tableMatch && orderMatch;
            });

            currentPage = 1;
            applySorting(); // é‡æ–°åº”ç”¨æ’åº
            renderOrdersTable();
            updateSearchStats();
            
            // éšè—å»ºè®®ä¸‹æ‹‰æ¡†
            hideAllSuggestions();
        }

        // æ’åºåŠŸèƒ½
        function sortOrders(field) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ’åºå­—æ®µï¼Œåˆ™åˆ‡æ¢æ’åºæ–¹å‘
            if (sortConfig.field === field) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // å¦‚æœç‚¹å‡»çš„æ˜¯æ–°å­—æ®µï¼Œé»˜è®¤é™åºæ’åº
                sortConfig.field = field;
                sortConfig.direction = 'desc';
            }
            
            applySorting();
            updateSortIndicators();
            renderOrdersTable();
            
            // æ˜¾ç¤ºæ’åºæç¤º
            const fieldNames = {
                'orderID': 'è®¢å•å·',
                'tableID': 'æ¡Œå°å·', 
                'orderTime': 'ä¸‹å•æ—¶é—´',
                'orderStatus': 'è®¢å•çŠ¶æ€',
                'totalAmount': 'æ€»é‡‘é¢'
            };
            const directionText = sortConfig.direction === 'asc' ? 'å‡åº' : 'é™åº';
            Utils.showNotification(`å·²æŒ‰${fieldNames[field]}${directionText}æ’åº`, 'info');
        }

        // åº”ç”¨æ’åº
        function applySorting() {
            filteredOrders.sort((a, b) => {
                let aValue, bValue;
                
                switch (sortConfig.field) {
                    case 'orderID':
                        aValue = a.orderID || a.OrderID || 0;
                        bValue = b.orderID || b.OrderID || 0;
                        break;
                    case 'tableID':
                        aValue = a.tableID || a.TableID || 0;
                        bValue = b.tableID || b.TableID || 0;
                        break;
                    case 'orderTime':
                        aValue = new Date(a.orderTime || a.OrderTime);
                        bValue = new Date(b.orderTime || b.OrderTime);
                        break;
                    case 'orderStatus':
                        aValue = a.orderStatus || a.OrderStatus || '';
                        bValue = b.orderStatus || b.OrderStatus || '';
                        break;
                    case 'totalAmount':
                        aValue = a.totalAmount || a.TotalAmount || a.totalPrice || a.TotalPrice || 0;
                        bValue = b.totalAmount || b.TotalAmount || b.totalPrice || b.TotalPrice || 0;
                        break;
                    default:
                        return 0;
                }
                
                if (aValue < bValue) {
                    return sortConfig.direction === 'asc' ? -1 : 1;
                }
                if (aValue > bValue) {
                    return sortConfig.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
        }

        // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
        function updateSortIndicators() {
            // æ¸…é™¤æ‰€æœ‰æ’åºæŒ‡ç¤ºå™¨
            const indicators = ['orderID', 'tableID', 'orderTime', 'orderStatus', 'totalAmount'];
            indicators.forEach(field => {
                const indicator = document.getElementById(`sort-${field}`);
                if (indicator) {
                    if (field === sortConfig.field) {
                        // å½“å‰æ’åºå­—æ®µæ˜¾ç¤ºæ–¹å‘
                        indicator.innerHTML = sortConfig.direction === 'asc' ? 
                            '<span style="color: #007bff;">â–²</span>' : 
                            '<span style="color: #007bff;">â–¼</span>';
                    } else {
                        // å…¶ä»–å­—æ®µæ˜¾ç¤ºé»˜è®¤çŠ¶æ€
                        indicator.innerHTML = '<span style="color: #ccc;">â‡…</span>';
                    }
                }
            });
        }

        // æ˜¾ç¤ºæ¡Œå°å·æœç´¢å»ºè®®
        function showTableSuggestions() {
            const input = document.getElementById('tableFilter');
            const suggestionsDiv = document.getElementById('tableSuggestions');
            const query = input.value.trim().toLowerCase();
            
            if (query.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            // è·å–æ‰€æœ‰å”¯ä¸€çš„æ¡Œå°å·
            const uniqueTables = [...new Set(allOrders
                .map(o => o.tableID || o.TableID)
                .filter(id => id)
                .sort((a, b) => a - b)
            )];

            // è¿‡æ»¤åŒ¹é…çš„æ¡Œå°å·
            const matchingTables = uniqueTables.filter(tableId => {
                const tableStr = tableId.toString();
                return tableStr.includes(query) || 
                       `æ¡Œå°${tableStr}`.toLowerCase().includes(query) ||
                       `table${tableStr}`.toLowerCase().includes(query);
            });

            if (matchingTables.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            // ç”Ÿæˆå»ºè®®é¡¹
            let suggestionsHTML = '';
            matchingTables.slice(0, 8).forEach(tableId => {
                const tableOrders = allOrders.filter(o => (o.tableID || o.TableID) === tableId);
                const recentOrder = tableOrders.sort((a, b) => new Date(b.orderTime || b.OrderTime) - new Date(a.orderTime || a.OrderTime))[0];
                const statusInfo = Utils.getStatusInfo(recentOrder.orderStatus || recentOrder.OrderStatus, 'order');
                
                suggestionsHTML += `
                    <div class="suggestion-item" onclick="selectTableSuggestion('${tableId}')">
                        <div class="suggestion-main">æ¡Œå°${highlightText(tableId.toString(), query)}</div>
                        <div class="suggestion-detail">
                            ${tableOrders.length}ä¸ªè®¢å• | 
                            <span class="status-badge ${statusInfo.class}" style="font-size: 0.7rem; padding: 0.1rem 0.3rem;">${statusInfo.text}</span>
                        </div>
                    </div>
                `;
            });

            suggestionsDiv.innerHTML = suggestionsHTML;
            suggestionsDiv.style.display = 'block';
        }

        // æ˜¾ç¤ºè®¢å•å·æœç´¢å»ºè®®
        function showOrderSuggestions() {
            const input = document.getElementById('orderSearch');
            const suggestionsDiv = document.getElementById('orderSuggestions');
            const query = input.value.trim().toLowerCase().replace('#', '');
            
            if (query.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            // è¿‡æ»¤åŒ¹é…çš„è®¢å•
            const matchingOrders = allOrders.filter(order => {
                const orderId = (order.orderID || order.OrderID).toString();
                return orderId.includes(query);
            }).sort((a, b) => (b.orderID || b.OrderID) - (a.orderID || a.OrderID));

            if (matchingOrders.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            // ç”Ÿæˆå»ºè®®é¡¹
            let suggestionsHTML = '';
            matchingOrders.slice(0, 8).forEach(order => {
                const orderId = order.orderID || order.OrderID;
                const tableId = order.tableID || order.TableID;
                const orderTime = new Date(order.orderTime || order.OrderTime);
                const statusInfo = Utils.getStatusInfo(order.orderStatus || order.OrderStatus, 'order');
                
                suggestionsHTML += `
                    <div class="suggestion-item" onclick="selectOrderSuggestion('${orderId}')">
                        <div class="suggestion-main">#${highlightText(orderId.toString(), query)}</div>
                        <div class="suggestion-detail">
                            æ¡Œå°${tableId || '-'} | ${orderTime.toLocaleDateString()} | 
                            <span class="status-badge ${statusInfo.class}" style="font-size: 0.7rem; padding: 0.1rem 0.3rem;">${statusInfo.text}</span>
                        </div>
                    </div>
                `;
            });

            suggestionsDiv.innerHTML = suggestionsHTML;
            suggestionsDiv.style.display = 'block';
        }

        // é€‰æ‹©æ¡Œå°å»ºè®®
        function selectTableSuggestion(tableId) {
            document.getElementById('tableFilter').value = tableId;
            document.getElementById('tableSuggestions').style.display = 'none';
            filterOrders();
        }

        // é€‰æ‹©è®¢å•å»ºè®®
        function selectOrderSuggestion(orderId) {
            document.getElementById('orderSearch').value = orderId;
            document.getElementById('orderSuggestions').style.display = 'none';
            filterOrders();
        }

        // é«˜äº®æœç´¢æ–‡æœ¬
        function highlightText(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // éšè—æ‰€æœ‰å»ºè®®ä¸‹æ‹‰æ¡†
        function hideAllSuggestions() {
            document.getElementById('tableSuggestions').style.display = 'none';
            document.getElementById('orderSuggestions').style.display = 'none';
        }

        // æ›´æ–°æœç´¢ç»Ÿè®¡
        function updateSearchStats() {
            const statsDiv = document.getElementById('searchStats');
            const statsText = document.getElementById('searchStatsText');
            
            const totalCount = allOrders.length;
            const filteredCount = filteredOrders.length;
            
            if (filteredCount === totalCount) {
                statsDiv.style.display = 'none';
            } else {
                const dateRange = document.getElementById('dateRange').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const tableFilter = document.getElementById('tableFilter').value.trim();
                const orderSearch = document.getElementById('orderSearch').value.trim();
                
                let filterDesc = [];
                if (dateRange !== 'all') filterDesc.push(`æ—¶é—´: ${getDateRangeText(dateRange)}`);
                if (statusFilter !== 'all') filterDesc.push(`çŠ¶æ€: ${statusFilter}`);
                if (tableFilter) filterDesc.push(`æ¡Œå°: ${tableFilter}`);
                if (orderSearch) filterDesc.push(`è®¢å•å·: ${orderSearch}`);
                
                statsText.innerHTML = `
                    <i class="icon">ğŸ”</i> 
                    ç­›é€‰ç»“æœ: æ‰¾åˆ° <strong>${filteredCount}</strong> æ¡è®¢å• (å…± ${totalCount} æ¡)
                    ${filterDesc.length > 0 ? `<br>ç­›é€‰æ¡ä»¶: ${filterDesc.join(' | ')}` : ''}
                `;
                statsDiv.style.display = 'block';
            }
        }

        // è·å–æ—¥æœŸèŒƒå›´æ–‡æœ¬
        function getDateRangeText(range) {
            const rangeMap = {
                'today': 'ä»Šå¤©',
                'yesterday': 'æ˜¨å¤©', 
                'week': 'æœ¬å‘¨',
                'month': 'æœ¬æœˆ',
                'all': 'å…¨éƒ¨'
            };
            return rangeMap[range] || range;
        }

        // æ¸…ç©ºæ‰€æœ‰ç­›é€‰æ¡ä»¶
        function clearAllFilters() {
            document.getElementById('dateRange').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('tableFilter').value = '';
            document.getElementById('orderSearch').value = '';
            
            // é‡ç½®æ’åºä¸ºé»˜è®¤çŠ¶æ€
            sortConfig = { field: 'orderID', direction: 'desc' };
            updateSortIndicators();
            
            hideAllSuggestions();
            filterOrders();
            
            Utils.showNotification('ç­›é€‰æ¡ä»¶å’Œæ’åºå·²æ¸…ç©º', 'info');
        }

        // å¿«é€Ÿæœç´¢åŠŸèƒ½
        function quickSearch() {
            const query = prompt('è¯·è¾“å…¥æœç´¢å†…å®¹ (æ”¯æŒè®¢å•å·ã€æ¡Œå°å·):');
            if (!query) return;
            
            const cleanQuery = query.trim().replace('#', '');
            
            // å…ˆå°è¯•æŒ‰è®¢å•å·æœç´¢
            const orderMatch = allOrders.find(o => 
                (o.orderID || o.OrderID).toString() === cleanQuery
            );
            
            if (orderMatch) {
                // æ‰¾åˆ°è®¢å•ï¼Œç›´æ¥æ‰“å¼€è¯¦æƒ…
                viewOrderDetails(orderMatch.orderID || orderMatch.OrderID);
                return;
            }
            
            // å†å°è¯•æŒ‰æ¡Œå°å·æœç´¢
            const tableMatches = allOrders.filter(o => 
                (o.tableID || o.TableID) && (o.tableID || o.TableID).toString() === cleanQuery
            );
            
            if (tableMatches.length > 0) {
                // æ‰¾åˆ°æ¡Œå°ï¼Œè®¾ç½®ç­›é€‰æ¡ä»¶
                document.getElementById('tableFilter').value = cleanQuery;
                filterOrders();
                Utils.showNotification(`æ‰¾åˆ°æ¡Œå°${cleanQuery}çš„${tableMatches.length}ä¸ªè®¢å•`, 'success');
                return;
            }
            
            // æ¨¡ç³Šæœç´¢
            document.getElementById('orderSearch').value = query;
            document.getElementById('tableFilter').value = query;
            filterOrders();
            
            if (filteredOrders.length === 0) {
                Utils.showNotification('æœªæ‰¾åˆ°åŒ¹é…çš„è®¢å•', 'warning');
            } else {
                Utils.showNotification(`æ‰¾åˆ°${filteredOrders.length}ä¸ªåŒ¹é…çš„è®¢å•`, 'success');
            }
        }

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—å»ºè®®æ¡†
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.form-group')) {
                hideAllSuggestions();
            }
        });

        function updateStatistics() {
            const totalOrders = allOrders.length;
            const today = new Date().toDateString();
            const todayOrders = allOrders.filter(o => new Date(o.orderTime || o.OrderTime).toDateString() === today);
            const activeOrders = allOrders.filter(o => {
                const status = o.orderStatus || o.OrderStatus;
                return status === 'è¿›è¡Œä¸­' || status === 'åˆ¶ä½œä¸­' || status === 'å¾…å¤„ç†';
            });
            const todayRevenue = todayOrders
                .filter(o => {
                    const status = o.orderStatus || o.OrderStatus;
                    return status === 'å·²ç»“è´¦';
                })
                .reduce((sum, o) => sum + (o.totalAmount || o.TotalAmount || o.totalPrice || o.TotalPrice || 0), 0);

            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('today-orders').textContent = todayOrders.length;
            document.getElementById('active-orders').textContent = activeOrders.length;
            document.getElementById('today-revenue').textContent = Utils.formatCurrency(todayRevenue);
        }

        function getStaffName(staffId) {
            // TODO: ä»å‘˜å·¥æ•°æ®ä¸­è·å–å‘˜å·¥å§“å
            return staffId ? `å‘˜å·¥${staffId}` : '-';
        }

        async function viewOrderDetails(orderId) {
            try {
                console.log(`[Frontend] è·å–è®¢å•è¯¦æƒ…: OrderID=${orderId}`);
                
                // è·å–åŸºæœ¬è®¢å•ä¿¡æ¯å’Œè¯¦æƒ…
                const [orderResponse, detailsResponse] = await Promise.all([
                    API.get(`/orders/${orderId}`),
                    API.get(`/orders/${orderId}/details`)
                ]);
                
                if (!orderResponse) {
                    Utils.showNotification('è®¢å•ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                const order = orderResponse;
                const details = detailsResponse.details || [];
                const statistics = detailsResponse.statistics || {
                    itemCount: details.length,
                    totalItems: details.reduce((sum, d) => sum + (d.quantity || d.Quantity || 0), 0),
                    totalAmount: details.reduce((sum, d) => sum + (d.subtotal || d.Subtotal || 0), 0)
                };
                
                document.getElementById('orderDetailTitle').textContent = `è®¢å•è¯¦æƒ… - #${orderId}`;
                
                const statusInfo = Utils.getStatusInfo(order.orderStatus || order.OrderStatus, 'order');
                const canModify = ['å¾…å¤„ç†', 'åˆ¶ä½œä¸­'].includes(order.orderStatus || order.OrderStatus);
                const canCheckout = ['å¾…å¤„ç†', 'åˆ¶ä½œä¸­', 'å·²å®Œæˆ'].includes(order.orderStatus || order.OrderStatus);
                
                let detailsHTML = `
                    <!-- è®¢å•åŸºæœ¬ä¿¡æ¯ -->
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f8f9fa; border-radius: 0.5rem;">
                        <h5 style="margin: 0 0 1rem 0; color: #495057;">
                            <i class="fas fa-receipt"></i> è®¢å•åŸºæœ¬ä¿¡æ¯
                        </h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div><strong>è®¢å•å·:</strong> #${order.orderID || order.OrderID}</div>
                            <div><strong>æ¡Œå°ä¿¡æ¯:</strong> æ¡Œå°${order.tableID || order.TableID || '-'}</div>
                            <div><strong>ä¸‹å•æ—¶é—´:</strong> ${Utils.formatDateTime(order.orderTime || order.OrderTime)}</div>
                            <div><strong>æœåŠ¡å‘˜:</strong> ${getStaffName(order.staffID || order.StaffID)}</div>
                            <div><strong>è®¢å•çŠ¶æ€:</strong> <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></div>
                            <div><strong>æ€»é‡‘é¢:</strong> <span style="color: #e74c3c; font-size: 1.2rem; font-weight: bold;">${Utils.formatCurrency(order.totalPrice || order.TotalPrice || statistics.totalAmount)}</span></div>
                        </div>
                        ${(order.notes || order.Notes) ? `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;"><strong>å¤‡æ³¨:</strong> ${order.notes || order.Notes}</div>` : ''}
                    </div>

                    <!-- è®¢å•ç»Ÿè®¡ä¿¡æ¯ -->
                    <div style="margin-bottom: 1rem; padding: 1rem; background-color: #e7f3ff; border-radius: 0.5rem; border-left: 4px solid #007bff;">
                        <h6 style="margin: 0 0 0.5rem 0; color: #0056b3;">
                            <i class="icon">ğŸ“Š</i> è®¢å•ç»Ÿè®¡
                        </h6>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.9rem;">
                            <div><strong>èœå“ç§ç±»:</strong> ${statistics.itemCount} ç§</div>
                            <div><strong>å•†å“æ€»æ•°:</strong> ${statistics.totalItems} ä»¶</div>
                            <div><strong>è®¢å•æ€»é¢:</strong> ${Utils.formatCurrency(statistics.totalAmount)}</div>
                            <div><strong>å¹³å‡å•ä»·:</strong> ${Utils.formatCurrency(statistics.itemCount > 0 ? statistics.totalAmount / statistics.itemCount : 0)}</div>
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                    <div class="order-actions" style="margin-bottom: 1.5rem; text-align: center; padding: 1rem; background-color: #f1f3f4; border-radius: 0.5rem;">
                        ${canModify ? `<button onclick="showAddDishModal(${orderId})" class="btn btn-primary" style="margin: 0 0.5rem;"><i class="icon">+</i> åŠ èœ</button>` : ''}
                        ${canCheckout ? `<button onclick="checkoutOrder(${orderId})" class="btn btn-success" style="margin: 0 0.5rem;"><i class="icon">ğŸ’³</i> ç»“è´¦</button>` : ''}
                        <button onclick="printOrderReceipt(${orderId})" class="btn btn-secondary" style="margin: 0 0.5rem;"><i class="icon">ğŸ–¨ï¸</i> æ‰“å°å°ç¥¨</button>
                        ${canModify ? `<button onclick="updateOrderStatus(${orderId})" class="btn btn-warning" style="margin: 0 0.5rem;"><i class="icon">ğŸ“</i> æ›´æ–°çŠ¶æ€</button>` : ''}
                        <button onclick="refreshOrderDetails(${orderId})" class="btn btn-info" style="margin: 0 0.5rem;"><i class="icon">ğŸ”„</i> åˆ·æ–°</button>
                    </div>

                    <h4 style="margin-bottom: 1rem; border-bottom: 2px solid #007bff; padding-bottom: 0.5rem; color: #007bff;">
                        <i class="icon">ğŸ½ï¸</i> èœå“æ˜ç»† (${statistics.itemCount}ç§èœå“ï¼Œ${statistics.totalItems}ä»¶)
                    </h4>
                    
                    <!-- èœå“æ˜ç»†è¡¨æ ¼ -->
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem; margin-bottom: 1rem;">
                        <table class="table" style="margin-bottom: 0; font-size: 0.9rem;">
                            <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <tr>
                                    <th style="border-top: none; padding: 0.75rem 0.5rem;">èœå“ä¿¡æ¯</th>
                                    <th style="width: 80px; border-top: none; text-align: center; padding: 0.75rem 0.5rem;">æ•°é‡</th>
                                    <th style="width: 100px; border-top: none; text-align: right; padding: 0.75rem 0.5rem;">å•ä»·</th>
                                    <th style="width: 100px; border-top: none; text-align: right; padding: 0.75rem 0.5rem;">å°è®¡</th>
                                    <th style="border-top: none; padding: 0.75rem 0.5rem;">ç‰¹æ®Šè¦æ±‚</th>
                                    ${canModify ? '<th style="width: 80px; border-top: none; text-align: center; padding: 0.75rem 0.5rem;">æ“ä½œ</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${details.length > 0 ? details.map(d => `
                                    <tr>
                                        <td style="padding: 0.75rem 0.5rem;">
                                            <div>
                                                <strong style="color: #495057;">${d.dishName || d.DishName || 'æœªçŸ¥èœå“'}</strong>
                                                ${(d.categoryName || d.CategoryName) ? `<br><small style="color: #6c757d;"><i class="icon">ğŸ·ï¸</i> ${d.categoryName || d.CategoryName}</small>` : ''}
                                                ${(d.dishDescription || d.DishDescription) ? `<br><small style="color: #6c757d;">${d.dishDescription || d.DishDescription}</small>` : ''}
                                            </div>
                                        </td>
                                        <td style="text-align: center; font-weight: bold; color: #007bff; padding: 0.75rem 0.5rem;">${d.quantity || d.Quantity || 0}</td>
                                        <td style="text-align: right; padding: 0.75rem 0.5rem;">${Utils.formatCurrency(d.unitPrice || d.UnitPrice || 0)}</td>
                                        <td style="text-align: right; font-weight: bold; color: #e74c3c; padding: 0.75rem 0.5rem;">${Utils.formatCurrency(d.subtotal || d.Subtotal || 0)}</td>
                                        <td style="padding: 0.75rem 0.5rem;">
                                            ${(d.specialRequests || d.SpecialRequests) ? `<span style="background-color: #fff3cd; padding: 0.2rem 0.4rem; border-radius: 0.2rem; font-size: 0.8rem;">${d.specialRequests || d.SpecialRequests}</span>` : '<span style="color: #6c757d;">-</span>'}
                                        </td>
                                        ${canModify ? `<td style="text-align: center; padding: 0.75rem 0.5rem;"><button onclick="removeOrderDetail(${d.orderDetailID || d.OrderDetailID})" class="btn btn-sm btn-danger">åˆ é™¤</button></td>` : ''}
                                    </tr>
                                `).join('') : `
                                    <tr>
                                        <td colspan="${canModify ? '6' : '5'}" style="text-align: center; color: #6c757d; padding: 2rem;">
                                            æš‚æ— èœå“è®°å½•
                                        </td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- æ€»è®¡ä¿¡æ¯ -->
                    <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 1rem; text-align: right;">
                        <h5 style="margin: 0; color: #e74c3c; font-size: 1.2rem;">
                            <strong>è®¢å•æ€»è®¡: ${Utils.formatCurrency(statistics.totalAmount)}</strong>
                        </h5>
                    </div>
                `;

                document.getElementById('orderDetailBody').innerHTML = detailsHTML;
                
                // æ›´æ–°æ¨¡æ€æ¡†æŒ‰é’®
                const modalFooter = document.querySelector('#orderDetailModal .modal-footer');
                modalFooter.innerHTML = `
                    <button onclick="Utils.hideModal('orderDetailModal')" class="btn btn-secondary">å…³é—­</button>
                    <button onclick="printOrderReceipt(${orderId})" class="btn btn-primary"><i class="icon">ğŸ–¨ï¸</i> æ‰“å°å°ç¥¨</button>
                `;
                
                Utils.showModal('orderDetailModal');
                
                console.log(`[Frontend] è®¢å•è¯¦æƒ…æ˜¾ç¤ºå®Œæˆ: OrderID=${orderId}, èœå“æ•°é‡=${statistics.itemCount}`);
            } catch (error) {
                console.error('è·å–è®¢å•è¯¦æƒ…å¤±è´¥:', error);
                Utils.showNotification('è·å–è®¢å•è¯¦æƒ…å¤±è´¥', 'error');
            }
        }

        // åˆ·æ–°è®¢å•è¯¦æƒ…
        async function refreshOrderDetails(orderId) {
            await viewOrderDetails(orderId);
            Utils.showNotification('è®¢å•è¯¦æƒ…å·²åˆ·æ–°', 'success');
        }

        function showAddDishModal(orderId) {
            currentOrderId = orderId;
            document.getElementById('dishQuantity').value = 1;
            document.getElementById('specialRequests').value = '';
            document.getElementById('dishSelect').value = '';
            Utils.showModal('addDishModal');
        }

        async function confirmAddDish() {
            const dishId = document.getElementById('dishSelect').value;
            const quantity = parseInt(document.getElementById('dishQuantity').value);
            const specialRequests = document.getElementById('specialRequests').value;

            if (!dishId || !quantity) {
                Utils.showNotification('è¯·é€‰æ‹©èœå“å¹¶è¾“å…¥æ•°é‡', 'warning');
                return;
            }

            try {
                const selectedOption = document.querySelector(`#dishSelect option[value="${dishId}"]`);
                const unitPrice = parseFloat(selectedOption.dataset.price);

                const orderDetail = {
                    dishID: parseInt(dishId),
                    quantity: quantity,
                    unitPrice: unitPrice,
                    specialRequests: specialRequests || null
                };

                await API.post(`/orders/${currentOrderId}/details`, orderDetail);
                
                Utils.showNotification('åŠ èœæˆåŠŸ', 'success');
                Utils.hideModal('addDishModal');
                
                // åˆ·æ–°è®¢å•åˆ—è¡¨
                await loadOrders();

            } catch (error) {
                console.error('åŠ èœå¤±è´¥:', error);
                Utils.showNotification('åŠ èœå¤±è´¥', 'error');
            }
        }

        async function checkoutOrder(orderId) {
            if (!Utils.showConfirm('ç¡®è®¤è¦ä¸ºæ­¤è®¢å•ç»“è´¦å—ï¼Ÿ\nç»“è´¦åæ¡Œå°çŠ¶æ€å°†å˜ä¸ºæ¸…æ´ä¸­ã€‚')) {
                return;
            }

            try {
                Utils.showNotification('æ­£åœ¨å¤„ç†ç»“è´¦...', 'info');
                
                const response = await API.put(`/orders/${orderId}/checkout`);
                
                Utils.showNotification('ç»“è´¦æˆåŠŸï¼', 'success');
                Utils.hideModal('orderDetailModal');
                await loadOrders();
                
                // å¯é€‰ï¼šæ˜¾ç¤ºç»“è´¦æˆåŠŸçš„è¯¦ç»†ä¿¡æ¯
                setTimeout(() => {
                    Utils.showNotification('æ¡Œå°çŠ¶æ€å·²æ›´æ–°ä¸ºæ¸…æ´ä¸­', 'info');
                }, 1500);
                
            } catch (error) {
                console.error('ç»“è´¦å¤±è´¥:', error);
                let errorMessage = 'ç»“è´¦å¤±è´¥';
                if (error.response && error.response.message) {
                    errorMessage = error.response.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                Utils.showNotification(errorMessage, 'error');
            }
        }

        async function printOrderReceipt(orderId) {
            try {
                Utils.showNotification('æ­£åœ¨ç”Ÿæˆå°ç¥¨...', 'info');
                
                // è·å–è®¢å•å°ç¥¨æ•°æ®
                const receiptData = await API.get(`/orders/${orderId}/receipt`);
                
                // æ ¼å¼åŒ–å°ç¥¨å†…å®¹
                const printContent = generateReceiptHTML(receiptData);
                
                // æ‰“å¼€æ‰“å°çª—å£
                const printWindow = window.open('', '_blank', 'width=400,height=600');
                printWindow.document.write(printContent);
                printWindow.document.close();
                
                // è‡ªåŠ¨è§¦å‘æ‰“å°å¯¹è¯æ¡†
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                }, 500);
                
                // è°ƒç”¨åç«¯æ‰“å°API
                await API.post(`/orders/${orderId}/print`);
                
                Utils.showNotification('å°ç¥¨å·²ç”Ÿæˆ', 'success');
                
            } catch (error) {
                console.error('æ‰“å°å¤±è´¥:', error);
                Utils.showNotification('æ‰“å°å¤±è´¥', 'error');
            }
        }

        function generateReceiptHTML(receiptData) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>è®¢å•å°ç¥¨ #${receiptData.orderId}</title>
                    <meta charset="UTF-8">
                    <style>
                        body { 
                            font-family: 'Courier New', monospace; 
                            font-size: 12px; 
                            line-height: 1.4;
                            margin: 0; 
                            padding: 20px;
                            width: 350px;
                        }
                        .header { 
                            text-align: center; 
                            border-bottom: 2px solid #000; 
                            padding-bottom: 10px; 
                            margin-bottom: 15px; 
                        }
                        .title { 
                            font-size: 18px; 
                            font-weight: bold; 
                            margin-bottom: 5px; 
                        }
                        .order-info { 
                            margin-bottom: 15px; 
                        }
                        .order-info div { 
                            margin-bottom: 3px; 
                        }
                        .items-table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-bottom: 15px; 
                        }
                        .items-table th, .items-table td { 
                            padding: 3px; 
                            text-align: left; 
                            font-size: 11px;
                        }
                        .items-table th { 
                            border-bottom: 1px solid #000; 
                            font-weight: bold; 
                        }
                        .total-section { 
                            border-top: 2px solid #000; 
                            padding-top: 10px; 
                            text-align: right; 
                        }
                        .total-amount { 
                            font-size: 16px; 
                            font-weight: bold; 
                        }
                        .footer { 
                            text-align: center; 
                            margin-top: 20px; 
                            border-top: 1px solid #000; 
                            padding-top: 10px; 
                            font-size: 10px; 
                        }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="title">é¤å…å°ç¥¨</div>
                        <div>Restaurant Receipt</div>
                    </div>
                    
                    <div class="order-info">
                        <div><strong>è®¢å•å·:</strong> #${receiptData.orderId}</div>
                        <div><strong>æ¡Œå°å·:</strong> ${receiptData.tableId ? 'æ¡Œå°' + receiptData.tableId : '-'}</div>
                        <div><strong>ä¸‹å•æ—¶é—´:</strong> ${new Date(receiptData.orderTime).toLocaleString('zh-CN')}</div>
                        <div><strong>æ‰“å°æ—¶é—´:</strong> ${new Date(receiptData.printTime).toLocaleString('zh-CN')}</div>
                    </div>
                    
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th style="width: 50%;">èœå“</th>
                                <th style="width: 15%; text-align: center;">æ•°é‡</th>
                                <th style="width: 20%; text-align: right;">å•ä»·</th>
                                <th style="width: 15%; text-align: right;">å°è®¡</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${receiptData.items.map(item => `
                                <tr>
                                    <td>${item.dishName}</td>
                                    <td style="text-align: center;">${item.quantity}</td>
                                    <td style="text-align: right;">Â¥${item.unitPrice.toFixed(2)}</td>
                                    <td style="text-align: right;">Â¥${item.subtotal.toFixed(2)}</td>
                                </tr>
                                ${item.specialRequests ? `<tr><td colspan="4" style="font-size: 9px; color: #666;">å¤‡æ³¨: ${item.specialRequests}</td></tr>` : ''}
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="total-section">
                        <div>å…± ${receiptData.items.length} é¡¹å•†å“</div>
                        <div class="total-amount">åˆè®¡: Â¥${receiptData.totalAmount.toFixed(2)}</div>
                    </div>
                    
                    <div class="footer">
                        <div>è°¢è°¢æƒ é¡¾ï¼Œæ¬¢è¿å†æ¬¡å…‰ä¸´ï¼</div>
                        <div>Thank you for your visit!</div>
                    </div>
                </body>
                </html>
            `;
        }

        async function updateOrderStatus(orderId) {
            const statusOptions = [
                { value: 'å¾…å¤„ç†', text: 'å¾…å¤„ç†' },
                { value: 'åˆ¶ä½œä¸­', text: 'åˆ¶ä½œä¸­' },
                { value: 'å·²å®Œæˆ', text: 'å·²å®Œæˆ' },
                { value: 'å·²ç»“è´¦', text: 'å·²ç»“è´¦' },
                { value: 'å·²å–æ¶ˆ', text: 'å·²å–æ¶ˆ' }
            ];

            let selectHTML = statusOptions.map(option => 
                `<option value="${option.value}">${option.text}</option>`
            ).join('');

            const newStatus = prompt(`è¯·é€‰æ‹©æ–°çš„è®¢å•çŠ¶æ€ï¼š\n\n${statusOptions.map((opt, idx) => `${idx + 1}. ${opt.text}`).join('\n')}\n\nè¯·è¾“å…¥å¯¹åº”çš„æ•°å­—æˆ–ç›´æ¥è¾“å…¥çŠ¶æ€å:`);
            
            if (!newStatus) return;

            let actualStatus = newStatus;
            const numericChoice = parseInt(newStatus);
            if (numericChoice >= 1 && numericChoice <= statusOptions.length) {
                actualStatus = statusOptions[numericChoice - 1].value;
            }

            try {
                await API.put(`/orders/${orderId}/status`, { status: actualStatus });
                Utils.showNotification(`è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸ºï¼š${actualStatus}`, 'success');
                Utils.hideModal('orderDetailModal');
                await loadOrders();
            } catch (error) {
                console.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', error);
                Utils.showNotification('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥', 'error');
            }
        }

        async function removeOrderDetail(detailId) {
            if (!Utils.showConfirm('ç¡®è®¤è¦åˆ é™¤è¿™ä¸ªèœå“å—ï¼Ÿ')) {
                return;
            }

            try {
                await API.delete(`/orders/details/${detailId}`);
                Utils.showNotification('èœå“å·²åˆ é™¤', 'success');
                // é‡æ–°åŠ è½½è®¢å•è¯¦æƒ…
                const currentOrderId = document.getElementById('orderDetailTitle').textContent.match(/#(\d+)/)?.[1];
                if (currentOrderId) {
                    await viewOrderDetails(parseInt(currentOrderId));
                }
            } catch (error) {
                console.error('åˆ é™¤èœå“å¤±è´¥:', error);
                Utils.showNotification('åˆ é™¤èœå“å¤±è´¥', 'error');
            }
        }

        async function cancelOrder(orderId) {
            if (!Utils.showConfirm('ç¡®è®¤è¦å–æ¶ˆæ­¤è®¢å•å—ï¼Ÿ\nå–æ¶ˆåæ— æ³•æ¢å¤ï¼')) {
                return;
            }

            try {
                await API.put(`/orders/${orderId}/cancel`);
                Utils.showNotification('è®¢å•å·²å–æ¶ˆ', 'success');
                Utils.hideModal('orderDetailModal');
                await loadOrders();
            } catch (error) {
                console.error('å–æ¶ˆè®¢å•å¤±è´¥:', error);
                Utils.showNotification('å–æ¶ˆè®¢å•å¤±è´¥', 'error');
            }
        }

        function printOrder() {
            const printContent = document.getElementById('orderDetailBody').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>è®¢å•è¯¦æƒ…</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 12px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .status-badge { padding: 2px 6px; border-radius: 3px; }
                        .btn { display: none; } /* éšè—æŒ‰é’® */
                        .order-actions { display: none; } /* éšè—æ“ä½œåŒºåŸŸ */
                    </style>
                </head>
                <body>
                    <h2 style="text-align: center;">è®¢å•è¯¦æƒ…</h2>
                    ${printContent}
                    <div style="text-align: center; margin-top: 20px;">
                        <p>æ‰“å°æ—¶é—´: ${new Date().toLocaleString('zh-CN')}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // åˆ·æ–°è®¢å•æ•°æ®
        async function refreshOrders() {
            Utils.showNotification('æ­£åœ¨åˆ·æ–°...', 'info');
            await loadOrders();
            Utils.showNotification('æ•°æ®å·²åˆ·æ–°', 'success');
        }

        // å¯¼å‡ºè®¢å•æŠ¥è¡¨
        function exportOrders() {
            Utils.showNotification('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }
    </script>
</body>
</html>

        async function refreshOrders() {
            Utils.showNotification('æ­£åœ¨åˆ·æ–°...', 'info');
            await loadOrders();
            Utils.showNotification('åˆ·æ–°å®Œæˆ', 'success');
        }

        function exportOrders() {
            Utils.showNotification('å¯¼å‡ºåŠŸèƒ½å¾…å®ç°', 'info');
        }
    </script>
</body>
</html>
