<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•ç®¡ç† - é¤é¥®ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar">
        <h1>é¤é¥®ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="nav-links">
            <a href="index.html">é¦–é¡µ</a>
            <a href="tables.html">æ¡Œå°ç®¡ç†</a>
            <a href="orders.html" class="active">è®¢å•ç®¡ç†</a>
            <a href="menu.html">èœå•ç®¡ç†</a>
            <a href="staff.html">å‘˜å·¥ç®¡ç†</a>
            <a href="inventory.html">åº“å­˜ç®¡ç†</a>
        </div>
    </nav>

    <div class="container">
        <div class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>è®¢å•ç®¡ç†</h2>
                <div>
                    <button onclick="refreshOrders()" class="btn btn-secondary">åˆ·æ–°æ•°æ®</button>
                    <button onclick="exportOrders()" class="btn btn-primary">å¯¼å‡ºæŠ¥è¡¨</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-orders">0</div>
                    <div class="stat-label">æ€»è®¢å•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="today-orders">0</div>
                    <div class="stat-label">ä»Šæ—¥è®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-orders">0</div>
                    <div class="stat-label">è¿›è¡Œä¸­è®¢å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="today-revenue">Â¥0</div>
                    <div class="stat-label">ä»Šæ—¥è¥ä¸šé¢</div>
                </div>
            </div>

            <!-- æœç´¢å’Œè¿‡æ»¤å™¨ -->
            <div class="card">
                <h3>è®¢å•æŸ¥è¯¢</h3>
                <div class="search-filters">
                    <div class="form-group">
                        <label for="dateRange">æ—¥æœŸèŒƒå›´:</label>
                        <select id="dateRange" class="form-control" onchange="filterOrders()">
                            <option value="today">ä»Šå¤©</option>
                            <option value="yesterday">æ˜¨å¤©</option>
                            <option value="week">æœ¬å‘¨</option>
                            <option value="month">æœ¬æœˆ</option>
                            <option value="all">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="statusFilter">è®¢å•çŠ¶æ€:</label>
                        <select id="statusFilter" class="form-control" onchange="filterOrders()">
                            <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                            <option value="å·²ç»“è´¦">å·²ç»“è´¦</option>
                            <option value="å·²å–æ¶ˆ">å·²å–æ¶ˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tableFilter">æ¡Œå°å·:</label>
                        <input type="text" id="tableFilter" class="form-control" placeholder="è¾“å…¥æ¡Œå°å·" onkeyup="filterOrders()">
                    </div>
                    <div class="form-group">
                        <label for="orderSearch">è®¢å•å·æœç´¢:</label>
                        <input type="text" id="orderSearch" class="form-control" placeholder="è¾“å…¥è®¢å•å·" onkeyup="filterOrders()">
                    </div>
                </div>
            </div>

            <!-- è®¢å•åˆ—è¡¨ -->
            <div class="card">
                <h3>è®¢å•åˆ—è¡¨</h3>
                <div style="overflow-x: auto;">
                    <table class="table" id="ordersTable">
                        <thead>
                            <tr>
                                <th>è®¢å•å·</th>
                                <th>æ¡Œå°å·</th>
                                <th>ä¸‹å•æ—¶é—´</th>
                                <th>æœåŠ¡å‘˜</th>
                                <th>è®¢å•çŠ¶æ€</th>
                                <th>æ€»é‡‘é¢</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- è®¢å•æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>

                <!-- åˆ†é¡µ -->
                <div class="pagination" id="pagination">
                    <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- è®¢å•è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="orderDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="orderDetailTitle">è®¢å•è¯¦æƒ…</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="orderDetailBody">
                <!-- è®¢å•è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
            </div>
            <div class="modal-footer">
                <button onclick="Utils.hideModal('orderDetailModal')" class="btn btn-secondary">å…³é—­</button>
                <button id="printOrderBtn" onclick="printOrder()" class="btn btn-primary">æ‰“å°å°ç¥¨</button>
            </div>
        </div>
    </div>

    <!-- åŠ èœæ¨¡æ€æ¡† -->
    <div id="addDishModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä¸ºè®¢å•åŠ èœ</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="dishSelect">é€‰æ‹©èœå“:</label>
                    <select id="dishSelect" class="form-control" required>
                        <option value="">è¯·é€‰æ‹©èœå“</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dishQuantity">æ•°é‡:</label>
                    <input type="number" id="dishQuantity" class="form-control" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="specialRequests">ç‰¹æ®Šè¦æ±‚:</label>
                    <textarea id="specialRequests" class="form-control" rows="3" placeholder="å¦‚ï¼šä¸è¦è¾£ã€å¤šæ”¾é¦™èœç­‰"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="Utils.hideModal('addDishModal')" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="confirmAddDish()" class="btn btn-primary">ç¡®è®¤åŠ èœ</button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let allOrders = [];
        let filteredOrders = [];
        let currentPage = 1;
        const pageSize = 10;
        let currentOrderId = null;
        let dishes = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
            loadDishes();
            setupEventListeners();
        });

        function setupEventListeners() {
            // æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.onclick = function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                };
            });
        }

        async function loadOrders() {
            try {
                allOrders = await API.get('/orders');
                filteredOrders = [...allOrders];
                renderOrdersTable();
                updateStatistics();
            } catch (error) {
                console.error('åŠ è½½è®¢å•æ•°æ®å¤±è´¥:', error);
                Utils.showNotification('åŠ è½½è®¢å•æ•°æ®å¤±è´¥', 'error');
            }
        }

        async function loadDishes() {
            try {
                const dishData = await API.get('/menu/dishes');
                dishes = dishData.filter(d => d.isAvailable);
                populateDishSelect();
            } catch (error) {
                console.error('åŠ è½½èœå“æ•°æ®å¤±è´¥:', error);
            }
        }

        function populateDishSelect() {
            const select = document.getElementById('dishSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©èœå“</option>';
            
            dishes.forEach(dish => {
                const option = document.createElement('option');
                option.value = dish.dishID;
                option.textContent = `${dish.dishName} - ${Utils.formatCurrency(dish.price)}`;
                option.dataset.price = dish.price;
                select.appendChild(option);
            });
        }

        function renderOrdersTable() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageOrders = filteredOrders.slice(startIndex, endIndex);

            if (pageOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">æš‚æ— è®¢å•æ•°æ®</td></tr>';
                return;
            }

            pageOrders.forEach(order => {
                const row = document.createElement('tr');
                const statusInfo = Utils.getStatusInfo(order.orderStatus, 'order');
                
                row.innerHTML = `
                    <td>${order.orderID}</td>
                    <td>æ¡Œå°${order.tableID || '-'}</td>
                    <td>${Utils.formatDateTime(order.orderTime)}</td>
                    <td>${getStaffName(order.staffID)}</td>
                    <td><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></td>
                    <td>${Utils.formatCurrency(order.totalAmount)}</td>
                    <td>
                        <button onclick="viewOrderDetails(${order.orderID})" class="btn btn-primary" style="margin-right: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">è¯¦æƒ…</button>
                        ${order.orderStatus === 'è¿›è¡Œä¸­' ? `
                            <button onclick="showAddDishModal(${order.orderID})" class="btn btn-secondary" style="margin-right: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">åŠ èœ</button>
                            <button onclick="checkoutOrder(${order.orderID})" class="btn btn-success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">ç»“è´¦</button>
                        ` : ''}
                        ${order.orderStatus === 'è¿›è¡Œä¸­' ? `
                            <button onclick="cancelOrder(${order.orderID})" class="btn btn-danger" style="margin-left: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">å–æ¶ˆ</button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });

            renderPagination();
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredOrders.length / pageSize);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            paginationHTML += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
            
            // é¡µç æŒ‰é’®
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="active">${i}</button>`;
                } else {
                    paginationHTML += `<button onclick="changePage(${i})">${i}</button>`;
                }
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            paginationHTML += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
            
            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredOrders.length / pageSize);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderOrdersTable();
        }

        function filterOrders() {
            const dateRange = document.getElementById('dateRange').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const tableFilter = document.getElementById('tableFilter').value.trim();
            const orderSearch = document.getElementById('orderSearch').value.trim();

            filteredOrders = allOrders.filter(order => {
                // æ—¥æœŸè¿‡æ»¤
                const orderDate = new Date(order.orderTime);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let dateMatch = true;
                if (dateRange === 'today') {
                    const orderDateOnly = new Date(orderDate);
                    orderDateOnly.setHours(0, 0, 0, 0);
                    dateMatch = orderDateOnly.getTime() === today.getTime();
                } else if (dateRange === 'yesterday') {
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    const orderDateOnly = new Date(orderDate);
                    orderDateOnly.setHours(0, 0, 0, 0);
                    dateMatch = orderDateOnly.getTime() === yesterday.getTime();
                } else if (dateRange === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    dateMatch = orderDate >= weekAgo;
                } else if (dateRange === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    dateMatch = orderDate >= monthAgo;
                }

                // çŠ¶æ€è¿‡æ»¤
                const statusMatch = statusFilter === 'all' || order.orderStatus === statusFilter;

                // æ¡Œå°è¿‡æ»¤
                const tableMatch = !tableFilter || (order.tableID && order.tableID.toString().includes(tableFilter));

                // è®¢å•å·æœç´¢
                const orderMatch = !orderSearch || order.orderID.toString().includes(orderSearch);

                return dateMatch && statusMatch && tableMatch && orderMatch;
            });

            currentPage = 1;
            renderOrdersTable();
        }

        function updateStatistics() {
            const totalOrders = allOrders.length;
            const today = new Date().toDateString();
            const todayOrders = allOrders.filter(o => new Date(o.orderTime).toDateString() === today);
            const activeOrders = allOrders.filter(o => o.orderStatus === 'è¿›è¡Œä¸­');
            const todayRevenue = todayOrders
                .filter(o => o.orderStatus === 'å·²ç»“è´¦')
                .reduce((sum, o) => sum + o.totalAmount, 0);

            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('today-orders').textContent = todayOrders.length;
            document.getElementById('active-orders').textContent = activeOrders.length;
            document.getElementById('today-revenue').textContent = Utils.formatCurrency(todayRevenue);
        }

        function getStaffName(staffId) {
            // TODO: ä»å‘˜å·¥æ•°æ®ä¸­è·å–å‘˜å·¥å§“å
            return staffId ? `å‘˜å·¥${staffId}` : '-';
        }

        async function viewOrderDetails(orderId) {
            try {
                console.log(`[Frontend] è·å–è®¢å•è¯¦æƒ…: OrderID=${orderId}`);
                
                // ä½¿ç”¨å¢å¼ºçš„è®¢å•è¯¦æƒ…API
                const response = await API.get(`/orders/${orderId}/enhanced-details`);
                
                if (!response) {
                    Utils.showNotification('è®¢å•ä¸å­˜åœ¨', 'error');
                    return;
                }
                
                const { Order: order, Details: details, Summary: summary, CategoryStats: categoryStats } = response;
                
                document.getElementById('orderDetailTitle').textContent = `è®¢å•è¯¦æƒ… - #${orderId}`;
                
                const statusInfo = Utils.getStatusInfo(order.OrderStatus, 'order');
                const canModify = ['å¾…å¤„ç†', 'åˆ¶ä½œä¸­'].includes(order.OrderStatus);
                const canCheckout = ['å¾…å¤„ç†', 'åˆ¶ä½œä¸­', 'å·²å®Œæˆ'].includes(order.OrderStatus);
                
                let detailsHTML = `
                    <!-- è®¢å•åŸºæœ¬ä¿¡æ¯ -->
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f8f9fa; border-radius: 0.5rem;">
                        <h5 style="margin: 0 0 1rem 0; color: #495057;">
                            <i class="fas fa-receipt"></i> è®¢å•åŸºæœ¬ä¿¡æ¯
                        </h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div><strong>è®¢å•å·:</strong> #${order.OrderID}</div>
                            <div><strong>æ¡Œå°ä¿¡æ¯:</strong> ${order.TableNumber ? `${order.TableNumber} (${order.TableArea}, ${order.TableCapacity}äººæ¡Œ)` : 'å¤–å–'}</div>
                            <div><strong>ä¸‹å•æ—¶é—´:</strong> ${Utils.formatDateTime(order.OrderTime)}</div>
                            <div><strong>æœåŠ¡å‘˜:</strong> ${order.StaffName ? `${order.StaffName} (${order.StaffPosition})` : '-'}</div>
                            <div><strong>è®¢å•çŠ¶æ€:</strong> <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></div>
                            <div><strong>æ€»é‡‘é¢:</strong> <span style="color: #e74c3c; font-size: 1.2rem; font-weight: bold;">${Utils.formatCurrency(order.TotalPrice || 0)}</span></div>
                        </div>
                        ${order.Notes ? `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;"><strong>å¤‡æ³¨:</strong> ${order.Notes}</div>` : ''}
                    </div>

                    <!-- è®¢å•ç»Ÿè®¡ä¿¡æ¯ -->
                    <div style="margin-bottom: 1rem; padding: 1rem; background-color: #e7f3ff; border-radius: 0.5rem; border-left: 4px solid #007bff;">
                        <h6 style="margin: 0 0 0.5rem 0; color: #0056b3;">
                            <i class="icon">ğŸ“Š</i> è®¢å•ç»Ÿè®¡
                        </h6>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.9rem;">
                            <div><strong>èœå“ç§ç±»:</strong> ${summary.ItemCount} ç§</div>
                            <div><strong>å•†å“æ€»æ•°:</strong> ${summary.TotalItems} ä»¶</div>
                            <div><strong>åˆ†ç±»æ•°é‡:</strong> ${summary.CategoryCount} ç±»</div>
                            <div><strong>å¹³å‡å•ä»·:</strong> ${Utils.formatCurrency(summary.AvgItemPrice)}</div>
                            ${summary.MostExpensiveItem ? `<div><strong>æœ€è´µèœå“:</strong> ${summary.MostExpensiveItem.DishName} (${Utils.formatCurrency(summary.MostExpensiveItem.Subtotal)})</div>` : ''}
                            ${summary.MostOrderedItem ? `<div><strong>æœ€å¤šæ•°é‡:</strong> ${summary.MostOrderedItem.DishName} (${summary.MostOrderedItem.Quantity}ä»½)</div>` : ''}
                        </div>
                    </div>

                    <!-- åˆ†ç±»ç»Ÿè®¡ -->
                    ${categoryStats && categoryStats.length > 0 ? `
                    <div style="margin-bottom: 1rem; padding: 1rem; background-color: #fff3cd; border-radius: 0.5rem; border-left: 4px solid #ffc107;">
                        <h6 style="margin: 0 0 0.5rem 0; color: #856404;">
                            <i class="icon">ğŸ“‹</i> åˆ†ç±»ç»Ÿè®¡
                        </h6>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.85rem;">
                            ${categoryStats.map(cat => `
                                <div style="padding: 0.5rem; background-color: white; border-radius: 0.25rem;">
                                    <strong>${cat.CategoryName}:</strong> ${cat.ItemCount}ç§ | ${cat.TotalQuantity}ä»½ | ${Utils.formatCurrency(cat.TotalAmount)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                    <div class="order-actions" style="margin-bottom: 1.5rem; text-align: center; padding: 1rem; background-color: #f1f3f4; border-radius: 0.5rem;">
                        ${canModify ? `<button onclick="showAddDishModal(${orderId})" class="btn btn-primary" style="margin: 0 0.5rem;"><i class="icon">+</i> åŠ èœ</button>` : ''}
                        ${canCheckout ? `<button onclick="checkoutOrder(${orderId})" class="btn btn-success" style="margin: 0 0.5rem;"><i class="icon">ğŸ’³</i> ç»“è´¦</button>` : ''}
                        <button onclick="printOrderReceipt(${orderId})" class="btn btn-secondary" style="margin: 0 0.5rem;"><i class="icon">ğŸ–¨ï¸</i> æ‰“å°å°ç¥¨</button>
                        ${canModify ? `<button onclick="updateOrderStatus(${orderId})" class="btn btn-warning" style="margin: 0 0.5rem;"><i class="icon">ğŸ“</i> æ›´æ–°çŠ¶æ€</button>` : ''}
                        <button onclick="refreshOrderDetails(${orderId})" class="btn btn-info" style="margin: 0 0.5rem;"><i class="icon">ğŸ”„</i> åˆ·æ–°</button>
                    </div>

                    <h4 style="margin-bottom: 1rem; border-bottom: 2px solid #007bff; padding-bottom: 0.5rem; color: #007bff;">
                        <i class="icon">ğŸ½ï¸</i> èœå“æ˜ç»† (${summary.ItemCount}ç§èœå“ï¼Œ${summary.TotalItems}ä»¶)
                    </h4>
                    
                    <!-- èœå“æ˜ç»†è¡¨æ ¼ -->
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem;">
                        <table class="table" style="margin-bottom: 0; font-size: 0.9rem;">
                            <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">
                                <tr>
                                    <th style="border-top: none;">èœå“ä¿¡æ¯</th>
                                    <th style="width: 80px; border-top: none; text-align: center;">æ•°é‡</th>
                                    <th style="width: 100px; border-top: none; text-align: right;">å•ä»·</th>
                                    <th style="width: 100px; border-top: none; text-align: right;">å°è®¡</th>
                                    <th style="border-top: none;">ç‰¹æ®Šè¦æ±‚</th>
                                    ${canModify ? '<th style="width: 80px; border-top: none; text-align: center;">æ“ä½œ</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${details.map(d => `
                                    <tr>
                                        <td>
                                            <div>
                                                <strong style="color: #495057;">${d.DishName}</strong>
                                                ${d.CategoryName ? `<br><small style="color: #6c757d;"><i class="icon">ğŸ·ï¸</i> ${d.CategoryName}</small>` : ''}
                                                ${d.DishDescription ? `<br><small style="color: #6c757d;">${d.DishDescription}</small>` : ''}
                                            </div>
                                        </td>
                                        <td style="text-align: center; font-weight: bold; color: #007bff;">${d.Quantity}</td>
                                        <td style="text-align: right;">${Utils.formatCurrency(d.UnitPrice)}</td>
                                        <td style="text-align: right; font-weight: bold; color: #e74c3c;">${Utils.formatCurrency(d.Subtotal)}</td>
                                        <td>
                                            ${d.SpecialRequests ? `<span style="background-color: #fff3cd; padding: 0.2rem 0.4rem; border-radius: 0.2rem; font-size: 0.8rem;">${d.SpecialRequests}</span>` : '<span style="color: #6c757d;">-</span>'}
                                        </td>
                                        ${canModify ? `<td style="text-align: center;"><button onclick="removeOrderDetail(${d.OrderDetailID})" class="btn btn-sm btn-danger">åˆ é™¤</button></td>` : ''}
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr style="font-weight: bold; background-color: #f8f9fa; font-size: 1.1rem;">
                                    <td colspan="${canModify ? '5' : '4'}" style="text-align: right; border-top: 2px solid #007bff;">æ€»è®¡:</td>
                                    <td style="text-align: right; color: #e74c3c; border-top: 2px solid #007bff;">${Utils.formatCurrency(summary.TotalAmount)}</td>
                                    ${canModify ? '<td></td>' : ''}
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;

                document.getElementById('orderDetailBody').innerHTML = detailsHTML;
                
                // æ›´æ–°æ¨¡æ€æ¡†æŒ‰é’®
                const modalFooter = document.querySelector('#orderDetailModal .modal-footer');
                modalFooter.innerHTML = `
                    <button onclick="Utils.hideModal('orderDetailModal')" class="btn btn-secondary">å…³é—­</button>
                    <button onclick="printOrderReceipt(${orderId})" class="btn btn-primary"><i class="icon">ğŸ–¨ï¸</i> æ‰“å°å°ç¥¨</button>
                `;
                
                Utils.showModal('orderDetailModal');
                
                console.log(`[Frontend] è®¢å•è¯¦æƒ…æ˜¾ç¤ºå®Œæˆ: OrderID=${orderId}, èœå“æ•°é‡=${summary.ItemCount}`);
            } catch (error) {
                console.error('è·å–è®¢å•è¯¦æƒ…å¤±è´¥:', error);
                Utils.showNotification('è·å–è®¢å•è¯¦æƒ…å¤±è´¥', 'error');
            }
        }

        // åˆ·æ–°è®¢å•è¯¦æƒ…
        async function refreshOrderDetails(orderId) {
            await viewOrderDetails(orderId);
            Utils.showNotification('è®¢å•è¯¦æƒ…å·²åˆ·æ–°', 'success');
        }

        function showAddDishModal(orderId) {
            currentOrderId = orderId;
            document.getElementById('dishQuantity').value = 1;
            document.getElementById('specialRequests').value = '';
            document.getElementById('dishSelect').value = '';
            Utils.showModal('addDishModal');
        }

        async function confirmAddDish() {
            const dishId = document.getElementById('dishSelect').value;
            const quantity = parseInt(document.getElementById('dishQuantity').value);
            const specialRequests = document.getElementById('specialRequests').value;

            if (!dishId || !quantity) {
                Utils.showNotification('è¯·é€‰æ‹©èœå“å¹¶è¾“å…¥æ•°é‡', 'warning');
                return;
            }

            try {
                const selectedOption = document.querySelector(`#dishSelect option[value="${dishId}"]`);
                const unitPrice = parseFloat(selectedOption.dataset.price);

                const orderDetail = {
                    dishID: parseInt(dishId),
                    quantity: quantity,
                    unitPrice: unitPrice,
                    specialRequests: specialRequests || null
                };

                await API.post(`/orders/${currentOrderId}/details`, orderDetail);
                
                Utils.showNotification('åŠ èœæˆåŠŸ', 'success');
                Utils.hideModal('addDishModal');
                
                // åˆ·æ–°è®¢å•åˆ—è¡¨
                await loadOrders();

            } catch (error) {
                console.error('åŠ èœå¤±è´¥:', error);
                Utils.showNotification('åŠ èœå¤±è´¥', 'error');
            }
        }

        async function checkoutOrder(orderId) {
            if (!Utils.showConfirm('ç¡®è®¤è¦ä¸ºæ­¤è®¢å•ç»“è´¦å—ï¼Ÿ\nç»“è´¦åæ¡Œå°çŠ¶æ€å°†å˜ä¸ºæ¸…æ´ä¸­ã€‚')) {
                return;
            }

            try {
                Utils.showNotification('æ­£åœ¨å¤„ç†ç»“è´¦...', 'info');
                
                const response = await API.put(`/orders/${orderId}/checkout`);
                
                Utils.showNotification('ç»“è´¦æˆåŠŸï¼', 'success');
                Utils.hideModal('orderDetailModal');
                await loadOrders();
                
                // å¯é€‰ï¼šæ˜¾ç¤ºç»“è´¦æˆåŠŸçš„è¯¦ç»†ä¿¡æ¯
                setTimeout(() => {
                    Utils.showNotification('æ¡Œå°çŠ¶æ€å·²æ›´æ–°ä¸ºæ¸…æ´ä¸­', 'info');
                }, 1500);
                
            } catch (error) {
                console.error('ç»“è´¦å¤±è´¥:', error);
                let errorMessage = 'ç»“è´¦å¤±è´¥';
                if (error.response && error.response.message) {
                    errorMessage = error.response.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                Utils.showNotification(errorMessage, 'error');
            }
        }

        async function printOrderReceipt(orderId) {
            try {
                Utils.showNotification('æ­£åœ¨ç”Ÿæˆå°ç¥¨...', 'info');
                
                // è·å–è®¢å•å°ç¥¨æ•°æ®
                const receiptData = await API.get(`/orders/${orderId}/receipt`);
                
                // æ ¼å¼åŒ–å°ç¥¨å†…å®¹
                const printContent = generateReceiptHTML(receiptData);
                
                // æ‰“å¼€æ‰“å°çª—å£
                const printWindow = window.open('', '_blank', 'width=400,height=600');
                printWindow.document.write(printContent);
                printWindow.document.close();
                
                // è‡ªåŠ¨è§¦å‘æ‰“å°å¯¹è¯æ¡†
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                }, 500);
                
                // è°ƒç”¨åç«¯æ‰“å°API
                await API.post(`/orders/${orderId}/print`);
                
                Utils.showNotification('å°ç¥¨å·²ç”Ÿæˆ', 'success');
                
            } catch (error) {
                console.error('æ‰“å°å¤±è´¥:', error);
                Utils.showNotification('æ‰“å°å¤±è´¥', 'error');
            }
        }

        function generateReceiptHTML(receiptData) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>è®¢å•å°ç¥¨ #${receiptData.orderId}</title>
                    <meta charset="UTF-8">
                    <style>
                        body { 
                            font-family: 'Courier New', monospace; 
                            font-size: 12px; 
                            line-height: 1.4;
                            margin: 0; 
                            padding: 20px;
                            width: 350px;
                        }
                        .header { 
                            text-align: center; 
                            border-bottom: 2px solid #000; 
                            padding-bottom: 10px; 
                            margin-bottom: 15px; 
                        }
                        .title { 
                            font-size: 18px; 
                            font-weight: bold; 
                            margin-bottom: 5px; 
                        }
                        .order-info { 
                            margin-bottom: 15px; 
                        }
                        .order-info div { 
                            margin-bottom: 3px; 
                        }
                        .items-table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-bottom: 15px; 
                        }
                        .items-table th, .items-table td { 
                            padding: 3px; 
                            text-align: left; 
                            font-size: 11px;
                        }
                        .items-table th { 
                            border-bottom: 1px solid #000; 
                            font-weight: bold; 
                        }
                        .total-section { 
                            border-top: 2px solid #000; 
                            padding-top: 10px; 
                            text-align: right; 
                        }
                        .total-amount { 
                            font-size: 16px; 
                            font-weight: bold; 
                        }
                        .footer { 
                            text-align: center; 
                            margin-top: 20px; 
                            border-top: 1px solid #000; 
                            padding-top: 10px; 
                            font-size: 10px; 
                        }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="title">é¤å…å°ç¥¨</div>
                        <div>Restaurant Receipt</div>
                    </div>
                    
                    <div class="order-info">
                        <div><strong>è®¢å•å·:</strong> #${receiptData.orderId}</div>
                        <div><strong>æ¡Œå°å·:</strong> ${receiptData.tableId ? 'æ¡Œå°' + receiptData.tableId : '-'}</div>
                        <div><strong>ä¸‹å•æ—¶é—´:</strong> ${new Date(receiptData.orderTime).toLocaleString('zh-CN')}</div>
                        <div><strong>æ‰“å°æ—¶é—´:</strong> ${new Date(receiptData.printTime).toLocaleString('zh-CN')}</div>
                    </div>
                    
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th style="width: 50%;">èœå“</th>
                                <th style="width: 15%; text-align: center;">æ•°é‡</th>
                                <th style="width: 20%; text-align: right;">å•ä»·</th>
                                <th style="width: 15%; text-align: right;">å°è®¡</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${receiptData.items.map(item => `
                                <tr>
                                    <td>${item.dishName}</td>
                                    <td style="text-align: center;">${item.quantity}</td>
                                    <td style="text-align: right;">Â¥${item.unitPrice.toFixed(2)}</td>
                                    <td style="text-align: right;">Â¥${item.subtotal.toFixed(2)}</td>
                                </tr>
                                ${item.specialRequests ? `<tr><td colspan="4" style="font-size: 9px; color: #666;">å¤‡æ³¨: ${item.specialRequests}</td></tr>` : ''}
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="total-section">
                        <div>å…± ${receiptData.items.length} é¡¹å•†å“</div>
                        <div class="total-amount">åˆè®¡: Â¥${receiptData.totalAmount.toFixed(2)}</div>
                    </div>
                    
                    <div class="footer">
                        <div>è°¢è°¢æƒ é¡¾ï¼Œæ¬¢è¿å†æ¬¡å…‰ä¸´ï¼</div>
                        <div>Thank you for your visit!</div>
                    </div>
                </body>
                </html>
            `;
        }

        async function updateOrderStatus(orderId) {
            const statusOptions = [
                { value: 'å¾…å¤„ç†', text: 'å¾…å¤„ç†' },
                { value: 'åˆ¶ä½œä¸­', text: 'åˆ¶ä½œä¸­' },
                { value: 'å·²å®Œæˆ', text: 'å·²å®Œæˆ' },
                { value: 'å·²ç»“è´¦', text: 'å·²ç»“è´¦' },
                { value: 'å·²å–æ¶ˆ', text: 'å·²å–æ¶ˆ' }
            ];

            let selectHTML = statusOptions.map(option => 
                `<option value="${option.value}">${option.text}</option>`
            ).join('');

            const newStatus = prompt(`è¯·é€‰æ‹©æ–°çš„è®¢å•çŠ¶æ€ï¼š\n\n${statusOptions.map((opt, idx) => `${idx + 1}. ${opt.text}`).join('\n')}\n\nè¯·è¾“å…¥å¯¹åº”çš„æ•°å­—æˆ–ç›´æ¥è¾“å…¥çŠ¶æ€å:`);
            
            if (!newStatus) return;

            let actualStatus = newStatus;
            const numericChoice = parseInt(newStatus);
            if (numericChoice >= 1 && numericChoice <= statusOptions.length) {
                actualStatus = statusOptions[numericChoice - 1].value;
            }

            try {
                await API.put(`/orders/${orderId}/status`, { status: actualStatus });
                Utils.showNotification(`è®¢å•çŠ¶æ€å·²æ›´æ–°ä¸ºï¼š${actualStatus}`, 'success');
                Utils.hideModal('orderDetailModal');
                await loadOrders();
            } catch (error) {
                console.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', error);
                Utils.showNotification('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥', 'error');
            }
        }

        async function removeOrderDetail(detailId) {
            if (!Utils.showConfirm('ç¡®è®¤è¦åˆ é™¤è¿™ä¸ªèœå“å—ï¼Ÿ')) {
                return;
            }

            try {
                await API.delete(`/orders/details/${detailId}`);
                Utils.showNotification('èœå“å·²åˆ é™¤', 'success');
                // é‡æ–°åŠ è½½è®¢å•è¯¦æƒ…
                const currentOrderId = document.getElementById('orderDetailTitle').textContent.match(/#(\d+)/)?.[1];
                if (currentOrderId) {
                    await viewOrderDetails(parseInt(currentOrderId));
                }
            } catch (error) {
                console.error('åˆ é™¤èœå“å¤±è´¥:', error);
                Utils.showNotification('åˆ é™¤èœå“å¤±è´¥', 'error');
            }
        }

        async function cancelOrder(orderId) {
            if (!Utils.showConfirm('ç¡®è®¤è¦å–æ¶ˆæ­¤è®¢å•å—ï¼Ÿ\nå–æ¶ˆåæ— æ³•æ¢å¤ï¼')) {
                return;
            }

            try {
                await API.put(`/orders/${orderId}/cancel`);
                Utils.showNotification('è®¢å•å·²å–æ¶ˆ', 'success');
                Utils.hideModal('orderDetailModal');
                await loadOrders();
            } catch (error) {
                console.error('å–æ¶ˆè®¢å•å¤±è´¥:', error);
                Utils.showNotification('å–æ¶ˆè®¢å•å¤±è´¥', 'error');
            }
        }

        function printOrder() {
            const printContent = document.getElementById('orderDetailBody').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>è®¢å•è¯¦æƒ…</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 12px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .status-badge { padding: 2px 6px; border-radius: 3px; }
                        .btn { display: none; } /* éšè—æŒ‰é’® */
                        .order-actions { display: none; } /* éšè—æ“ä½œåŒºåŸŸ */
                    </style>
                </head>
                <body>
                    <h2 style="text-align: center;">è®¢å•è¯¦æƒ…</h2>
                    ${printContent}
                    <div style="text-align: center; margin-top: 20px;">
                        <p>æ‰“å°æ—¶é—´: ${new Date().toLocaleString('zh-CN')}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // åˆ·æ–°è®¢å•æ•°æ®
        async function refreshOrders() {
            Utils.showNotification('æ­£åœ¨åˆ·æ–°...', 'info');
            await loadOrders();
            Utils.showNotification('æ•°æ®å·²åˆ·æ–°', 'success');
        }

        // å¯¼å‡ºè®¢å•æŠ¥è¡¨
        function exportOrders() {
            Utils.showNotification('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }
    </script>
</body>
</html>

        async function refreshOrders() {
            Utils.showNotification('æ­£åœ¨åˆ·æ–°...', 'info');
            await loadOrders();
            Utils.showNotification('åˆ·æ–°å®Œæˆ', 'success');
        }

        function exportOrders() {
            Utils.showNotification('å¯¼å‡ºåŠŸèƒ½å¾…å®ç°', 'info');
        }
    </script>
</body>
</html>
