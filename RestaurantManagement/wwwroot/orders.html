<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单管理 - 餐饮管理系统</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar">
        <h1>餐饮管理系统</h1>
        <div class="nav-links">
            <a href="index.html">首页</a>
            <a href="tables.html">桌台管理</a>
            <a href="orders.html" class="active">订单管理</a>
            <a href="menu.html">菜单管理</a>
            <a href="staff.html">员工管理</a>
            <a href="inventory.html">库存管理</a>
        </div>
    </nav>

    <div class="container">
        <div class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>订单管理</h2>
                <div>
                    <button onclick="refreshOrders()" class="btn btn-secondary">刷新数据</button>
                    <button onclick="exportOrders()" class="btn btn-primary">导出报表</button>
                </div>
            </div>

            <!-- 统计卡片 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-orders">0</div>
                    <div class="stat-label">总订单数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="today-orders">0</div>
                    <div class="stat-label">今日订单</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-orders">0</div>
                    <div class="stat-label">进行中订单</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="today-revenue">¥0</div>
                    <div class="stat-label">今日营业额</div>
                </div>
            </div>

            <!-- 搜索和过滤器 -->
            <div class="card">
                <h3>订单查询</h3>
                <div class="search-filters">
                    <div class="form-group">
                        <label for="dateRange">日期范围:</label>
                        <select id="dateRange" class="form-control" onchange="filterOrders()">
                            <option value="today">今天</option>
                            <option value="yesterday">昨天</option>
                            <option value="week">本周</option>
                            <option value="month">本月</option>
                            <option value="all">全部</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="statusFilter">订单状态:</label>
                        <select id="statusFilter" class="form-control" onchange="filterOrders()">
                            <option value="all">全部状态</option>
                            <option value="进行中">进行中</option>
                            <option value="已结账">已结账</option>
                            <option value="已取消">已取消</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tableFilter">桌台号:</label>
                        <input type="text" id="tableFilter" class="form-control" placeholder="输入桌台号" onkeyup="filterOrders()">
                    </div>
                    <div class="form-group">
                        <label for="orderSearch">订单号搜索:</label>
                        <input type="text" id="orderSearch" class="form-control" placeholder="输入订单号" onkeyup="filterOrders()">
                    </div>
                </div>
            </div>

            <!-- 订单列表 -->
            <div class="card">
                <h3>订单列表</h3>
                <div style="overflow-x: auto;">
                    <table class="table" id="ordersTable">
                        <thead>
                            <tr>
                                <th>订单号</th>
                                <th>桌台号</th>
                                <th>下单时间</th>
                                <th>服务员</th>
                                <th>订单状态</th>
                                <th>总金额</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- 订单数据将通过JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <div class="pagination" id="pagination">
                    <!-- 分页按钮将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 订单详情模态框 -->
    <div id="orderDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="orderDetailTitle">订单详情</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="orderDetailBody">
                <!-- 订单详情内容将通过JavaScript动态填充 -->
            </div>
            <div class="modal-footer">
                <button onclick="Utils.hideModal('orderDetailModal')" class="btn btn-secondary">关闭</button>
                <button id="printOrderBtn" onclick="printOrder()" class="btn btn-primary">打印小票</button>
            </div>
        </div>
    </div>

    <!-- 加菜模态框 -->
    <div id="addDishModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>为订单加菜</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="dishSelect">选择菜品:</label>
                    <select id="dishSelect" class="form-control" required>
                        <option value="">请选择菜品</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dishQuantity">数量:</label>
                    <input type="number" id="dishQuantity" class="form-control" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label for="specialRequests">特殊要求:</label>
                    <textarea id="specialRequests" class="form-control" rows="3" placeholder="如：不要辣、多放香菜等"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="Utils.hideModal('addDishModal')" class="btn btn-secondary">取消</button>
                <button onclick="confirmAddDish()" class="btn btn-primary">确认加菜</button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let allOrders = [];
        let filteredOrders = [];
        let currentPage = 1;
        const pageSize = 10;
        let currentOrderId = null;
        let dishes = [];

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
            loadDishes();
            setupEventListeners();
        });

        function setupEventListeners() {
            // 模态框关闭事件
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.onclick = function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                };
            });
        }

        async function loadOrders() {
            try {
                allOrders = await API.get('/orders');
                filteredOrders = [...allOrders];
                renderOrdersTable();
                updateStatistics();
            } catch (error) {
                console.error('加载订单数据失败:', error);
                Utils.showNotification('加载订单数据失败', 'error');
            }
        }

        async function loadDishes() {
            try {
                const dishData = await API.get('/menu/dishes');
                dishes = dishData.filter(d => d.isAvailable);
                populateDishSelect();
            } catch (error) {
                console.error('加载菜品数据失败:', error);
            }
        }

        function populateDishSelect() {
            const select = document.getElementById('dishSelect');
            select.innerHTML = '<option value="">请选择菜品</option>';
            
            dishes.forEach(dish => {
                const option = document.createElement('option');
                option.value = dish.dishID;
                option.textContent = `${dish.dishName} - ${Utils.formatCurrency(dish.price)}`;
                option.dataset.price = dish.price;
                select.appendChild(option);
            });
        }

        function renderOrdersTable() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const pageOrders = filteredOrders.slice(startIndex, endIndex);

            if (pageOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">暂无订单数据</td></tr>';
                return;
            }

            pageOrders.forEach(order => {
                const row = document.createElement('tr');
                const statusInfo = Utils.getStatusInfo(order.orderStatus, 'order');
                
                row.innerHTML = `
                    <td>${order.orderID}</td>
                    <td>桌台${order.tableID || '-'}</td>
                    <td>${Utils.formatDateTime(order.orderTime)}</td>
                    <td>${getStaffName(order.staffID)}</td>
                    <td><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></td>
                    <td>${Utils.formatCurrency(order.totalAmount)}</td>
                    <td>
                        <button onclick="viewOrderDetails(${order.orderID})" class="btn btn-primary" style="margin-right: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">详情</button>
                        ${order.orderStatus === '进行中' ? `
                            <button onclick="showAddDishModal(${order.orderID})" class="btn btn-secondary" style="margin-right: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">加菜</button>
                            <button onclick="checkoutOrder(${order.orderID})" class="btn btn-success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">结账</button>
                        ` : ''}
                        ${order.orderStatus === '进行中' ? `
                            <button onclick="cancelOrder(${order.orderID})" class="btn btn-danger" style="margin-left: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">取消</button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });

            renderPagination();
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredOrders.length / pageSize);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // 上一页按钮
            paginationHTML += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>上一页</button>`;
            
            // 页码按钮
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="active">${i}</button>`;
                } else {
                    paginationHTML += `<button onclick="changePage(${i})">${i}</button>`;
                }
            }
            
            // 下一页按钮
            paginationHTML += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>下一页</button>`;
            
            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredOrders.length / pageSize);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderOrdersTable();
        }

        function filterOrders() {
            const dateRange = document.getElementById('dateRange').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const tableFilter = document.getElementById('tableFilter').value.trim();
            const orderSearch = document.getElementById('orderSearch').value.trim();

            filteredOrders = allOrders.filter(order => {
                // 日期过滤
                const orderDate = new Date(order.orderTime);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let dateMatch = true;
                if (dateRange === 'today') {
                    const orderDateOnly = new Date(orderDate);
                    orderDateOnly.setHours(0, 0, 0, 0);
                    dateMatch = orderDateOnly.getTime() === today.getTime();
                } else if (dateRange === 'yesterday') {
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    const orderDateOnly = new Date(orderDate);
                    orderDateOnly.setHours(0, 0, 0, 0);
                    dateMatch = orderDateOnly.getTime() === yesterday.getTime();
                } else if (dateRange === 'week') {
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    dateMatch = orderDate >= weekAgo;
                } else if (dateRange === 'month') {
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    dateMatch = orderDate >= monthAgo;
                }

                // 状态过滤
                const statusMatch = statusFilter === 'all' || order.orderStatus === statusFilter;

                // 桌台过滤
                const tableMatch = !tableFilter || (order.tableID && order.tableID.toString().includes(tableFilter));

                // 订单号搜索
                const orderMatch = !orderSearch || order.orderID.toString().includes(orderSearch);

                return dateMatch && statusMatch && tableMatch && orderMatch;
            });

            currentPage = 1;
            renderOrdersTable();
        }

        function updateStatistics() {
            const totalOrders = allOrders.length;
            const today = new Date().toDateString();
            const todayOrders = allOrders.filter(o => new Date(o.orderTime).toDateString() === today);
            const activeOrders = allOrders.filter(o => o.orderStatus === '进行中');
            const todayRevenue = todayOrders
                .filter(o => o.orderStatus === '已结账')
                .reduce((sum, o) => sum + o.totalAmount, 0);

            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('today-orders').textContent = todayOrders.length;
            document.getElementById('active-orders').textContent = activeOrders.length;
            document.getElementById('today-revenue').textContent = Utils.formatCurrency(todayRevenue);
        }

        function getStaffName(staffId) {
            // TODO: 从员工数据中获取员工姓名
            return staffId ? `员工${staffId}` : '-';
        }

        async function viewOrderDetails(orderId) {
            try {
                console.log(`[Frontend] 获取订单详情: OrderID=${orderId}`);
                
                // 使用增强的订单详情API
                const response = await API.get(`/orders/${orderId}/enhanced-details`);
                
                if (!response) {
                    Utils.showNotification('订单不存在', 'error');
                    return;
                }
                
                const { Order: order, Details: details, Summary: summary, CategoryStats: categoryStats } = response;
                
                document.getElementById('orderDetailTitle').textContent = `订单详情 - #${orderId}`;
                
                const statusInfo = Utils.getStatusInfo(order.OrderStatus, 'order');
                const canModify = ['待处理', '制作中'].includes(order.OrderStatus);
                const canCheckout = ['待处理', '制作中', '已完成'].includes(order.OrderStatus);
                
                let detailsHTML = `
                    <!-- 订单基本信息 -->
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f8f9fa; border-radius: 0.5rem;">
                        <h5 style="margin: 0 0 1rem 0; color: #495057;">
                            <i class="fas fa-receipt"></i> 订单基本信息
                        </h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div><strong>订单号:</strong> #${order.OrderID}</div>
                            <div><strong>桌台信息:</strong> ${order.TableNumber ? `${order.TableNumber} (${order.TableArea}, ${order.TableCapacity}人桌)` : '外卖'}</div>
                            <div><strong>下单时间:</strong> ${Utils.formatDateTime(order.OrderTime)}</div>
                            <div><strong>服务员:</strong> ${order.StaffName ? `${order.StaffName} (${order.StaffPosition})` : '-'}</div>
                            <div><strong>订单状态:</strong> <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></div>
                            <div><strong>总金额:</strong> <span style="color: #e74c3c; font-size: 1.2rem; font-weight: bold;">${Utils.formatCurrency(order.TotalPrice || 0)}</span></div>
                        </div>
                        ${order.Notes ? `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;"><strong>备注:</strong> ${order.Notes}</div>` : ''}
                    </div>

                    <!-- 订单统计信息 -->
                    <div style="margin-bottom: 1rem; padding: 1rem; background-color: #e7f3ff; border-radius: 0.5rem; border-left: 4px solid #007bff;">
                        <h6 style="margin: 0 0 0.5rem 0; color: #0056b3;">
                            <i class="icon">📊</i> 订单统计
                        </h6>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.9rem;">
                            <div><strong>菜品种类:</strong> ${summary.ItemCount} 种</div>
                            <div><strong>商品总数:</strong> ${summary.TotalItems} 件</div>
                            <div><strong>分类数量:</strong> ${summary.CategoryCount} 类</div>
                            <div><strong>平均单价:</strong> ${Utils.formatCurrency(summary.AvgItemPrice)}</div>
                            ${summary.MostExpensiveItem ? `<div><strong>最贵菜品:</strong> ${summary.MostExpensiveItem.DishName} (${Utils.formatCurrency(summary.MostExpensiveItem.Subtotal)})</div>` : ''}
                            ${summary.MostOrderedItem ? `<div><strong>最多数量:</strong> ${summary.MostOrderedItem.DishName} (${summary.MostOrderedItem.Quantity}份)</div>` : ''}
                        </div>
                    </div>

                    <!-- 分类统计 -->
                    ${categoryStats && categoryStats.length > 0 ? `
                    <div style="margin-bottom: 1rem; padding: 1rem; background-color: #fff3cd; border-radius: 0.5rem; border-left: 4px solid #ffc107;">
                        <h6 style="margin: 0 0 0.5rem 0; color: #856404;">
                            <i class="icon">📋</i> 分类统计
                        </h6>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.85rem;">
                            ${categoryStats.map(cat => `
                                <div style="padding: 0.5rem; background-color: white; border-radius: 0.25rem;">
                                    <strong>${cat.CategoryName}:</strong> ${cat.ItemCount}种 | ${cat.TotalQuantity}份 | ${Utils.formatCurrency(cat.TotalAmount)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- 操作按钮区域 -->
                    <div class="order-actions" style="margin-bottom: 1.5rem; text-align: center; padding: 1rem; background-color: #f1f3f4; border-radius: 0.5rem;">
                        ${canModify ? `<button onclick="showAddDishModal(${orderId})" class="btn btn-primary" style="margin: 0 0.5rem;"><i class="icon">+</i> 加菜</button>` : ''}
                        ${canCheckout ? `<button onclick="checkoutOrder(${orderId})" class="btn btn-success" style="margin: 0 0.5rem;"><i class="icon">💳</i> 结账</button>` : ''}
                        <button onclick="printOrderReceipt(${orderId})" class="btn btn-secondary" style="margin: 0 0.5rem;"><i class="icon">🖨️</i> 打印小票</button>
                        ${canModify ? `<button onclick="updateOrderStatus(${orderId})" class="btn btn-warning" style="margin: 0 0.5rem;"><i class="icon">📝</i> 更新状态</button>` : ''}
                        <button onclick="refreshOrderDetails(${orderId})" class="btn btn-info" style="margin: 0 0.5rem;"><i class="icon">🔄</i> 刷新</button>
                    </div>

                    <h4 style="margin-bottom: 1rem; border-bottom: 2px solid #007bff; padding-bottom: 0.5rem; color: #007bff;">
                        <i class="icon">🍽️</i> 菜品明细 (${summary.ItemCount}种菜品，${summary.TotalItems}件)
                    </h4>
                    
                    <!-- 菜品明细表格 -->
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem;">
                        <table class="table" style="margin-bottom: 0; font-size: 0.9rem;">
                            <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 1;">
                                <tr>
                                    <th style="border-top: none;">菜品信息</th>
                                    <th style="width: 80px; border-top: none; text-align: center;">数量</th>
                                    <th style="width: 100px; border-top: none; text-align: right;">单价</th>
                                    <th style="width: 100px; border-top: none; text-align: right;">小计</th>
                                    <th style="border-top: none;">特殊要求</th>
                                    ${canModify ? '<th style="width: 80px; border-top: none; text-align: center;">操作</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${details.map(d => `
                                    <tr>
                                        <td>
                                            <div>
                                                <strong style="color: #495057;">${d.DishName}</strong>
                                                ${d.CategoryName ? `<br><small style="color: #6c757d;"><i class="icon">🏷️</i> ${d.CategoryName}</small>` : ''}
                                                ${d.DishDescription ? `<br><small style="color: #6c757d;">${d.DishDescription}</small>` : ''}
                                            </div>
                                        </td>
                                        <td style="text-align: center; font-weight: bold; color: #007bff;">${d.Quantity}</td>
                                        <td style="text-align: right;">${Utils.formatCurrency(d.UnitPrice)}</td>
                                        <td style="text-align: right; font-weight: bold; color: #e74c3c;">${Utils.formatCurrency(d.Subtotal)}</td>
                                        <td>
                                            ${d.SpecialRequests ? `<span style="background-color: #fff3cd; padding: 0.2rem 0.4rem; border-radius: 0.2rem; font-size: 0.8rem;">${d.SpecialRequests}</span>` : '<span style="color: #6c757d;">-</span>'}
                                        </td>
                                        ${canModify ? `<td style="text-align: center;"><button onclick="removeOrderDetail(${d.OrderDetailID})" class="btn btn-sm btn-danger">删除</button></td>` : ''}
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr style="font-weight: bold; background-color: #f8f9fa; font-size: 1.1rem;">
                                    <td colspan="${canModify ? '5' : '4'}" style="text-align: right; border-top: 2px solid #007bff;">总计:</td>
                                    <td style="text-align: right; color: #e74c3c; border-top: 2px solid #007bff;">${Utils.formatCurrency(summary.TotalAmount)}</td>
                                    ${canModify ? '<td></td>' : ''}
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;

                document.getElementById('orderDetailBody').innerHTML = detailsHTML;
                
                // 更新模态框按钮
                const modalFooter = document.querySelector('#orderDetailModal .modal-footer');
                modalFooter.innerHTML = `
                    <button onclick="Utils.hideModal('orderDetailModal')" class="btn btn-secondary">关闭</button>
                    <button onclick="printOrderReceipt(${orderId})" class="btn btn-primary"><i class="icon">🖨️</i> 打印小票</button>
                `;
                
                Utils.showModal('orderDetailModal');
                
                console.log(`[Frontend] 订单详情显示完成: OrderID=${orderId}, 菜品数量=${summary.ItemCount}`);
            } catch (error) {
                console.error('获取订单详情失败:', error);
                Utils.showNotification('获取订单详情失败', 'error');
            }
        }

        // 刷新订单详情
        async function refreshOrderDetails(orderId) {
            await viewOrderDetails(orderId);
            Utils.showNotification('订单详情已刷新', 'success');
        }

        function showAddDishModal(orderId) {
            currentOrderId = orderId;
            document.getElementById('dishQuantity').value = 1;
            document.getElementById('specialRequests').value = '';
            document.getElementById('dishSelect').value = '';
            Utils.showModal('addDishModal');
        }

        async function confirmAddDish() {
            const dishId = document.getElementById('dishSelect').value;
            const quantity = parseInt(document.getElementById('dishQuantity').value);
            const specialRequests = document.getElementById('specialRequests').value;

            if (!dishId || !quantity) {
                Utils.showNotification('请选择菜品并输入数量', 'warning');
                return;
            }

            try {
                const selectedOption = document.querySelector(`#dishSelect option[value="${dishId}"]`);
                const unitPrice = parseFloat(selectedOption.dataset.price);

                const orderDetail = {
                    dishID: parseInt(dishId),
                    quantity: quantity,
                    unitPrice: unitPrice,
                    specialRequests: specialRequests || null
                };

                await API.post(`/orders/${currentOrderId}/details`, orderDetail);
                
                Utils.showNotification('加菜成功', 'success');
                Utils.hideModal('addDishModal');
                
                // 刷新订单列表
                await loadOrders();

            } catch (error) {
                console.error('加菜失败:', error);
                Utils.showNotification('加菜失败', 'error');
            }
        }

        async function checkoutOrder(orderId) {
            if (!Utils.showConfirm('确认要为此订单结账吗？\n结账后桌台状态将变为清洁中。')) {
                return;
            }

            try {
                Utils.showNotification('正在处理结账...', 'info');
                
                const response = await API.put(`/orders/${orderId}/checkout`);
                
                Utils.showNotification('结账成功！', 'success');
                Utils.hideModal('orderDetailModal');
                await loadOrders();
                
                // 可选：显示结账成功的详细信息
                setTimeout(() => {
                    Utils.showNotification('桌台状态已更新为清洁中', 'info');
                }, 1500);
                
            } catch (error) {
                console.error('结账失败:', error);
                let errorMessage = '结账失败';
                if (error.response && error.response.message) {
                    errorMessage = error.response.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                Utils.showNotification(errorMessage, 'error');
            }
        }

        async function printOrderReceipt(orderId) {
            try {
                Utils.showNotification('正在生成小票...', 'info');
                
                // 获取订单小票数据
                const receiptData = await API.get(`/orders/${orderId}/receipt`);
                
                // 格式化小票内容
                const printContent = generateReceiptHTML(receiptData);
                
                // 打开打印窗口
                const printWindow = window.open('', '_blank', 'width=400,height=600');
                printWindow.document.write(printContent);
                printWindow.document.close();
                
                // 自动触发打印对话框
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                }, 500);
                
                // 调用后端打印API
                await API.post(`/orders/${orderId}/print`);
                
                Utils.showNotification('小票已生成', 'success');
                
            } catch (error) {
                console.error('打印失败:', error);
                Utils.showNotification('打印失败', 'error');
            }
        }

        function generateReceiptHTML(receiptData) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>订单小票 #${receiptData.orderId}</title>
                    <meta charset="UTF-8">
                    <style>
                        body { 
                            font-family: 'Courier New', monospace; 
                            font-size: 12px; 
                            line-height: 1.4;
                            margin: 0; 
                            padding: 20px;
                            width: 350px;
                        }
                        .header { 
                            text-align: center; 
                            border-bottom: 2px solid #000; 
                            padding-bottom: 10px; 
                            margin-bottom: 15px; 
                        }
                        .title { 
                            font-size: 18px; 
                            font-weight: bold; 
                            margin-bottom: 5px; 
                        }
                        .order-info { 
                            margin-bottom: 15px; 
                        }
                        .order-info div { 
                            margin-bottom: 3px; 
                        }
                        .items-table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-bottom: 15px; 
                        }
                        .items-table th, .items-table td { 
                            padding: 3px; 
                            text-align: left; 
                            font-size: 11px;
                        }
                        .items-table th { 
                            border-bottom: 1px solid #000; 
                            font-weight: bold; 
                        }
                        .total-section { 
                            border-top: 2px solid #000; 
                            padding-top: 10px; 
                            text-align: right; 
                        }
                        .total-amount { 
                            font-size: 16px; 
                            font-weight: bold; 
                        }
                        .footer { 
                            text-align: center; 
                            margin-top: 20px; 
                            border-top: 1px solid #000; 
                            padding-top: 10px; 
                            font-size: 10px; 
                        }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="title">餐厅小票</div>
                        <div>Restaurant Receipt</div>
                    </div>
                    
                    <div class="order-info">
                        <div><strong>订单号:</strong> #${receiptData.orderId}</div>
                        <div><strong>桌台号:</strong> ${receiptData.tableId ? '桌台' + receiptData.tableId : '-'}</div>
                        <div><strong>下单时间:</strong> ${new Date(receiptData.orderTime).toLocaleString('zh-CN')}</div>
                        <div><strong>打印时间:</strong> ${new Date(receiptData.printTime).toLocaleString('zh-CN')}</div>
                    </div>
                    
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th style="width: 50%;">菜品</th>
                                <th style="width: 15%; text-align: center;">数量</th>
                                <th style="width: 20%; text-align: right;">单价</th>
                                <th style="width: 15%; text-align: right;">小计</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${receiptData.items.map(item => `
                                <tr>
                                    <td>${item.dishName}</td>
                                    <td style="text-align: center;">${item.quantity}</td>
                                    <td style="text-align: right;">¥${item.unitPrice.toFixed(2)}</td>
                                    <td style="text-align: right;">¥${item.subtotal.toFixed(2)}</td>
                                </tr>
                                ${item.specialRequests ? `<tr><td colspan="4" style="font-size: 9px; color: #666;">备注: ${item.specialRequests}</td></tr>` : ''}
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="total-section">
                        <div>共 ${receiptData.items.length} 项商品</div>
                        <div class="total-amount">合计: ¥${receiptData.totalAmount.toFixed(2)}</div>
                    </div>
                    
                    <div class="footer">
                        <div>谢谢惠顾，欢迎再次光临！</div>
                        <div>Thank you for your visit!</div>
                    </div>
                </body>
                </html>
            `;
        }

        async function updateOrderStatus(orderId) {
            const statusOptions = [
                { value: '待处理', text: '待处理' },
                { value: '制作中', text: '制作中' },
                { value: '已完成', text: '已完成' },
                { value: '已结账', text: '已结账' },
                { value: '已取消', text: '已取消' }
            ];

            let selectHTML = statusOptions.map(option => 
                `<option value="${option.value}">${option.text}</option>`
            ).join('');

            const newStatus = prompt(`请选择新的订单状态：\n\n${statusOptions.map((opt, idx) => `${idx + 1}. ${opt.text}`).join('\n')}\n\n请输入对应的数字或直接输入状态名:`);
            
            if (!newStatus) return;

            let actualStatus = newStatus;
            const numericChoice = parseInt(newStatus);
            if (numericChoice >= 1 && numericChoice <= statusOptions.length) {
                actualStatus = statusOptions[numericChoice - 1].value;
            }

            try {
                await API.put(`/orders/${orderId}/status`, { status: actualStatus });
                Utils.showNotification(`订单状态已更新为：${actualStatus}`, 'success');
                Utils.hideModal('orderDetailModal');
                await loadOrders();
            } catch (error) {
                console.error('更新订单状态失败:', error);
                Utils.showNotification('更新订单状态失败', 'error');
            }
        }

        async function removeOrderDetail(detailId) {
            if (!Utils.showConfirm('确认要删除这个菜品吗？')) {
                return;
            }

            try {
                await API.delete(`/orders/details/${detailId}`);
                Utils.showNotification('菜品已删除', 'success');
                // 重新加载订单详情
                const currentOrderId = document.getElementById('orderDetailTitle').textContent.match(/#(\d+)/)?.[1];
                if (currentOrderId) {
                    await viewOrderDetails(parseInt(currentOrderId));
                }
            } catch (error) {
                console.error('删除菜品失败:', error);
                Utils.showNotification('删除菜品失败', 'error');
            }
        }

        async function cancelOrder(orderId) {
            if (!Utils.showConfirm('确认要取消此订单吗？\n取消后无法恢复！')) {
                return;
            }

            try {
                await API.put(`/orders/${orderId}/cancel`);
                Utils.showNotification('订单已取消', 'success');
                Utils.hideModal('orderDetailModal');
                await loadOrders();
            } catch (error) {
                console.error('取消订单失败:', error);
                Utils.showNotification('取消订单失败', 'error');
            }
        }

        function printOrder() {
            const printContent = document.getElementById('orderDetailBody').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>订单详情</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 12px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .status-badge { padding: 2px 6px; border-radius: 3px; }
                        .btn { display: none; } /* 隐藏按钮 */
                        .order-actions { display: none; } /* 隐藏操作区域 */
                    </style>
                </head>
                <body>
                    <h2 style="text-align: center;">订单详情</h2>
                    ${printContent}
                    <div style="text-align: center; margin-top: 20px;">
                        <p>打印时间: ${new Date().toLocaleString('zh-CN')}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // 刷新订单数据
        async function refreshOrders() {
            Utils.showNotification('正在刷新...', 'info');
            await loadOrders();
            Utils.showNotification('数据已刷新', 'success');
        }

        // 导出订单报表
        function exportOrders() {
            Utils.showNotification('导出功能开发中...', 'info');
        }
    </script>
</body>
</html>

        async function refreshOrders() {
            Utils.showNotification('正在刷新...', 'info');
            await loadOrders();
            Utils.showNotification('刷新完成', 'success');
        }

        function exportOrders() {
            Utils.showNotification('导出功能待实现', 'info');
        }
    </script>
</body>
</html>
