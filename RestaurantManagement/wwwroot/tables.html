<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡Œå°ç®¡ç† - é¤é¥®ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* æ¡Œå°è¯¦æƒ…æ ·å¼å¢å¼º */
        .table-details-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .table-basic-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #495057;
        }
        
        .info-value {
            color: #212529;
        }
        
        .order-info-section {
            margin-bottom: 1.5rem;
        }
        
        .info-grid p {
            margin: 0.5rem 0;
            padding: 0.25rem 0;
        }
        
        .dishes-section {
            margin-bottom: 1rem;
        }
        
        .table-responsive {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        
        .total-row {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .empty-state {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .no-order-section {
            margin: 1rem 0;
        }
        
        .action-buttons .btn {
            margin: 0.25rem;
        }
        
        .error-state {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            color: #721c24;
        }
        
        /* è®¢å•çŠ¶æ€æ ·å¼ */
        .status-active { background-color: #28a745; color: white; }
        .status-success { background-color: #17a2b8; color: white; }
        .status-cancelled { background-color: #dc3545; color: white; }
        .status-finished { background-color: #6c757d; color: white; }
        .status-default { background-color: #ffc107; color: black; }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .action-buttons {
                text-align: center;
            }
            
            .action-buttons .btn {
                display: block;
                width: 100%;
                margin: 0.25rem 0;
            }
            
            .info-row {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
            }
            
            .table-responsive {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>é¤é¥®ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="nav-links">
            <a href="index.html">é¦–é¡µ</a>
            <a href="tables.html" class="active">æ¡Œå°ç®¡ç†</a>
            <a href="orders.html">è®¢å•ç®¡ç†</a>
            <a href="menu.html">èœå•ç®¡ç†</a>
            <a href="staff.html">å‘˜å·¥ç®¡ç†</a>
            <a href="inventory.html">åº“å­˜ç®¡ç†</a>
        </div>
    </nav>

    <div class="container">
        <div class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>æ¡Œå°ç®¡ç†</h2>
                <div>
                    <button onclick="refreshTables()" class="btn btn-secondary">åˆ·æ–°çŠ¶æ€</button>
                </div>
            </div>

            <!-- æ¡Œå°çŠ¶æ€ç»Ÿè®¡ -->
            <div class="card">
                <h3>æ¡Œå°çŠ¶æ€æ¦‚è§ˆ</h3>
                <div style="display: flex; gap: 2rem; margin-top: 1rem;">
                    <div>
                        <span class="status-badge status-available">ç©ºé—²: <span id="available-count">0</span></span>
                    </div>
                    <div>
                        <span class="status-badge status-occupied">å ç”¨: <span id="occupied-count">0</span></span>
                    </div>
                    <div>
                        <span class="status-badge status-reserved">é¢„è®¢: <span id="reserved-count">0</span></span>
                    </div>
                    <div>
                        <span class="status-badge status-cleaning">æ¸…æ´ä¸­: <span id="cleaning-count">0</span></span>
                    </div>
                </div>
            </div>

            <!-- æ¡Œå°ç½‘æ ¼ -->
            <div class="card">
                <h3>æ¡Œå°å¸ƒå±€</h3>
                <div id="table-grid" class="table-grid">
                    <!-- æ¡Œå°é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>

    <!-- æ¡Œå°è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="tableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">æ¡Œå°è¯¦æƒ…</h3>
                <span class="close">&times;</span>
            </div>
            <div id="modal-body">
                <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </div>

    <!-- å¼€å°æ¨¡æ€æ¡† -->
    <div id="openTableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å¼€å°</h3>
                <span class="close">&times;</span>
            </div>
            <form id="openTableForm">
                <div class="form-group">
                    <label for="staffSelect">æœåŠ¡å‘˜:</label>
                    <select id="staffSelect" class="form-control" required>
                        <option value="">è¯·é€‰æ‹©æœåŠ¡å‘˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="orderNotes">å¤‡æ³¨:</label>
                    <textarea id="orderNotes" class="form-control" rows="3"></textarea>
                </div>
                <div style="text-align: right; margin-top: 1rem;">
                    <button type="button" onclick="Utils.hideModal('openTableModal')" class="btn btn-secondary">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ç¡®è®¤å¼€å°</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç»“è´¦ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="checkoutConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px; margin: 10% auto;">
            <div class="modal-header">
                <h3>ç¡®è®¤ç»“è´¦</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 3rem; color: #28a745; margin-bottom: 1rem;">ğŸ’³</div>
                    <h4 style="color: #333; margin-bottom: 1rem;">ç¡®è®¤è¦ä¸ºæ­¤è®¢å•ç»“è´¦å—ï¼Ÿ</h4>
                    <p id="checkout-order-info" style="color: #666; margin-bottom: 1.5rem;">
                        <!-- è®¢å•ä¿¡æ¯å°†åŠ¨æ€å¡«å…… -->
                    </p>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="Utils.hideModal('checkoutConfirmModal')" class="btn btn-secondary">å–æ¶ˆ</button>
                        <button id="confirmCheckoutBtn" onclick="confirmCheckout()" class="btn btn-success">ç¡®è®¤ç»“è´¦</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let currentTableId = null;
        let tables = [];
        let staff = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadTables();
            loadStaff();
            setupEventListeners();
        });

        function setupEventListeners() {
            // å¼€å°è¡¨å•æäº¤
            document.getElementById('openTableForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleOpenTable();
            });
        }

        async function loadTables() {
            try {
                tables = await API.get('/tables');
                renderTables();
                updateStatusCounts();
            } catch (error) {
                console.error('åŠ è½½æ¡Œå°æ•°æ®å¤±è´¥:', error);
                Utils.showNotification('åŠ è½½æ¡Œå°æ•°æ®å¤±è´¥', 'error');
            }
        }

        async function loadStaff() {
            try {
                staff = await API.get('/staff');
                populateStaffSelect();
            } catch (error) {
                console.error('åŠ è½½å‘˜å·¥æ•°æ®å¤±è´¥:', error);
            }
        }

        function populateStaffSelect() {
            const select = document.getElementById('staffSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©æœåŠ¡å‘˜</option>';
            
            staff.filter(s => s.status === 'åœ¨èŒ').forEach(s => {
                const option = document.createElement('option');
                option.value = s.staffID;
                option.textContent = s.staffName;
                select.appendChild(option);
            });
        }

        function renderTables() {
            const grid = document.getElementById('table-grid');
            grid.innerHTML = '';

            tables.forEach(table => {
                const tableItem = document.createElement('div');
                // è·å–æ¡Œå°é¡¹çš„çŠ¶æ€ç±»ï¼ˆä¸å¸¦ status- å‰ç¼€ï¼‰
                const statusInfo = Utils.getStatusInfo(table.status, 'table');
                const tableStatusClass = statusInfo.class.replace('status-', ''); // ç§»é™¤ status- å‰ç¼€
                tableItem.className = `table-item ${tableStatusClass}`;
                tableItem.onclick = () => handleTableClick(table);

                tableItem.innerHTML = `
                    <div class="table-number">æ¡Œå° ${table.tableNumber}</div>
                    <div class="table-capacity">å®¹é‡: ${table.capacity}äºº</div>
                    <div class="status-badge ${statusInfo.class}">
                        ${statusInfo.text}
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
                        åŒºåŸŸ: ${table.area}
                    </div>
                `;

                grid.appendChild(tableItem);
            });
        }

        function updateStatusCounts() {
            const counts = {
                available: tables.filter(t => t.status === 'ç©ºé—²').length,
                occupied: tables.filter(t => t.status === 'å ç”¨').length,
                reserved: tables.filter(t => t.status === 'é¢„è®¢').length,
                cleaning: tables.filter(t => t.status === 'æ¸…æ´ä¸­').length
            };

            document.getElementById('available-count').textContent = counts.available;
            document.getElementById('occupied-count').textContent = counts.occupied;
            document.getElementById('reserved-count').textContent = counts.reserved;
            document.getElementById('cleaning-count').textContent = counts.cleaning;
        }

        async function handleTableClick(table) {
            currentTableId = table.tableID;
            
            if (table.status === 'ç©ºé—²') {
                showOpenTableModal(table);
            } else if (table.status === 'å ç”¨') {
                await showTableDetails(table);
            } else if (table.status === 'æ¸…æ´ä¸­') {
                showTableCleaningOptions(table);
            }
        }

        function showOpenTableModal(table) {
            document.getElementById('openTableModal').querySelector('h3').textContent = `å¼€å° - æ¡Œå°${table.tableNumber}`;
            Utils.showModal('openTableModal');
        }

        async function showTableDetails(table) {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('modal-title').textContent = `æ¡Œå°${table.tableNumber} - åŠ è½½ä¸­...`;
                document.getElementById('modal-body').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div class="loading-spinner"></div>
                        <p>æ­£åœ¨åŠ è½½è®¢å•ä¿¡æ¯...</p>
                    </div>
                `;
                Utils.showModal('tableModal');

                // è·å–å½“å‰è®¢å•ä¿¡æ¯ï¼Œå¢åŠ é”™è¯¯å¤„ç†
                let currentOrder = null;
                try {
                    const response = await fetch(`/api/tables/${table.tableID}/current-order`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        currentOrder = await response.json();
                        console.log('è·å–åˆ°çš„è®¢å•æ•°æ®:', currentOrder);
                    } else if (response.status === 404) {
                        // 404è¡¨ç¤ºæ²¡æœ‰è®¢å•ï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µ
                        currentOrder = null;
                    } else {
                        throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`);
                    }
                } catch (apiError) {
                    console.warn('è·å–è®¢å•APIè°ƒç”¨å¤±è´¥:', apiError);
                    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œç»§ç»­æ˜¾ç¤ºæ— è®¢å•çŠ¶æ€
                    currentOrder = null;
                }
                
                let orderDetails = '';
                let staffInfo = '';
                
                if (currentOrder) {
                    // è·å–è®¢å•è¯¦æƒ…å’ŒæœåŠ¡å‘˜ä¿¡æ¯
                    const [details, orderStaff] = await Promise.all([
                        API.get(`/orders/${currentOrder.orderID}/details`).catch(() => []),
                        currentOrder.staffID ? API.get(`/staff/${currentOrder.staffID}`).catch(() => null) : null
                    ]);

                    staffInfo = orderStaff ? `
                        <p><strong>è´Ÿè´£æœåŠ¡å‘˜:</strong> ${orderStaff.staffName}</p>
                    ` : '';

                    const totalAmount = details.reduce((sum, d) => {
                        return sum + d.Subtotal; // ä½¿ç”¨å¼ºç±»å‹å­—æ®µå
                    }, 0);
                    
                    orderDetails = `
                        <div class="order-info-section">
                            <h4 style="color: #28a745; margin-bottom: 1rem;">
                                <i class="icon-order"></i> å½“å‰è®¢å•ä¿¡æ¯
                            </h4>
                            <div class="info-grid">
                                <p><strong>è®¢å•å·:</strong> #${currentOrder.orderID}</p>
                                <p><strong>ä¸‹å•æ—¶é—´:</strong> ${Utils.formatDateTime(currentOrder.orderTime)}</p>
                                ${staffInfo}
                                <p><strong>è®¢å•çŠ¶æ€:</strong> <span class="status-badge ${getOrderStatusClass(currentOrder.orderStatus)}">${currentOrder.orderStatus}</span></p>
                                <p><strong>å¤‡æ³¨:</strong> ${currentOrder.notes || 'æ— '}</p>
                            </div>
                        </div>
                        
                        <div class="dishes-section">
                            <h5 style="margin: 1.5rem 0 1rem 0;">
                                <i class="icon-dish"></i> èœå“åˆ—è¡¨ (${details.length}é¡¹)
                            </h5>
                            ${details.length > 0 ? `
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>èœå“åç§°</th>
                                                <th>æ•°é‡</th>
                                                <th>å•ä»·</th>
                                                <th>å°è®¡</th>
                                                <th>ç‰¹æ®Šè¦æ±‚</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${details.map(d => `
                                                <tr>
                                                    <td><strong>${d.DishName}</strong></td>
                                                    <td class="text-center">${d.Quantity}</td>
                                                    <td class="text-right">${Utils.formatCurrency(d.UnitPrice)}</td>
                                                    <td class="text-right"><strong>${Utils.formatCurrency(d.Subtotal)}</strong></td>
                                                    <td class="text-muted">${d.SpecialRequests || '-'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                        <tfoot>
                                            <tr class="total-row">
                                                <td colspan="3"><strong>æ€»è®¡</strong></td>
                                                <td class="text-right"><strong style="color: #28a745; font-size: 1.1em;">${Utils.formatCurrency(totalAmount)}</strong></td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            ` : `
                                <div class="empty-state">
                                    <p style="color: #6c757d; text-align: center; padding: 2rem;">
                                        <i class="icon-empty"></i><br>
                                        æš‚æ— ç‚¹èœè®°å½•
                                    </p>
                                </div>
                            `}
                        </div>
                        
                        <div class="action-buttons" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="addDish(${currentOrder.orderID})" class="btn btn-primary">
                                    <i class="icon-add"></i> åŠ èœ
                                </button>
                                <button onclick="printOrder(${currentOrder.orderID})" class="btn btn-secondary">
                                    <i class="icon-print"></i> æ‰“å°
                                </button>
                                <button onclick="checkoutOrder(${currentOrder.orderID})" class="btn btn-success">
                                    <i class="icon-checkout"></i> ç»“è´¦ (${Utils.formatCurrency(totalAmount)})
                                </button>
                            </div>
                            <div style="margin-top: 1rem;">
                                <button onclick="Utils.hideModal('tableModal')" class="btn btn-light" style="width: 100%;">å…³é—­</button>
                            </div>
                        </div>
                    `;
                } else {
                    // æ²¡æœ‰è®¢å•æ—¶æ˜¾ç¤ºåˆ›å»ºè®¢å•ç•Œé¢
                    orderDetails = `
                        <div class="no-order-section">
                            <div style="text-align: center; padding: 2rem; background-color: #f8f9fa; border-radius: 8px; margin: 1rem 0;">
                                <div style="font-size: 3rem; color: #6c757d; margin-bottom: 1rem;">ğŸ½ï¸</div>
                                <h4 style="color: #6c757d; margin-bottom: 1rem;">è¯¥æ¡Œå°æš‚æ— è®¢å•</h4>
                                <p style="color: #868e96; margin-bottom: 2rem;">å®¢äººå·²å…¥åº§ï¼Œå¯ä»¥å¼€å§‹ç‚¹é¤äº†</p>
                                
                                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                    <button onclick="createNewOrder(${table.tableID})" class="btn btn-primary btn-lg">
                                        <i class="icon-add"></i> åˆ›å»ºè®¢å•
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                document.getElementById('modal-title').textContent = `æ¡Œå°${table.tableNumber}`;
                document.getElementById('modal-body').innerHTML = `
                    <div class="table-details-container">
                        ${orderDetails}
                    </div>
                `;

                Utils.showModal('tableModal');
            } catch (error) {
                console.error('è·å–æ¡Œå°è¯¦æƒ…å¤±è´¥:', error);
                document.getElementById('modal-title').textContent = `æ¡Œå°${table.tableNumber} - é”™è¯¯`;
                document.getElementById('modal-body').innerHTML = `
                    <div class="error-state" style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;">âš ï¸</div>
                        <h4 style="color: #dc3545;">åŠ è½½å¤±è´¥</h4>
                        <p style="color: #6c757d; margin: 1rem 0;">æ— æ³•è·å–æ¡Œå°è¯¦æƒ…ä¿¡æ¯</p>
                        <div>
                            <button onclick="showTableDetails({tableID: ${table.tableID}, tableNumber: '${table.tableNumber}', capacity: ${table.capacity}, area: '${table.area}', status: '${table.status}'})" class="btn btn-primary">é‡è¯•</button>
                            <button onclick="Utils.hideModal('tableModal')" class="btn btn-secondary">å…³é—­</button>
                        </div>
                    </div>
                `;
                Utils.showNotification('è·å–æ¡Œå°è¯¦æƒ…å¤±è´¥', 'error');
            }
        }

        // è·å–è®¢å•çŠ¶æ€å¯¹åº”çš„CSSç±»
        function getOrderStatusClass(status) {
            const statusMap = {
                'å¾…å¤„ç†': 'status-default',
                'åˆ¶ä½œä¸­': 'status-active',
                'å·²å®Œæˆ': 'status-success',
                'å·²ç»“è´¦': 'status-finished'
            };
            return statusMap[status] || 'status-default';
        }

        // æ‰“å°è®¢å•
        function printOrder(orderId) {
            // TODO: å®ç°æ‰“å°åŠŸèƒ½
            Utils.showNotification('æ‰“å°åŠŸèƒ½å¾…å®ç°', 'info');
        }

        function showTableCleaningOptions(table) {
            document.getElementById('modal-title').textContent = `æ¡Œå°${table.tableNumber} - æ¸…æ´ä¸­`;
            document.getElementById('modal-body').innerHTML = `
                <div>
                    <p><strong>æ¡Œå°å·:</strong> ${table.tableNumber}</p>
                    <p><strong>çŠ¶æ€:</strong> <span class="status-badge status-cleaning">æ¸…æ´ä¸­</span></p>
                    <p>è¯¥æ¡Œå°æ­£åœ¨æ¸…æ´ä¸­ï¼Œæ¸…æ´å®Œæˆåå¯è®¾ç½®ä¸ºç©ºé—²çŠ¶æ€ã€‚</p>
                    
                    <div style="margin-top: 1rem;">
                        <button onclick="finishCleaning(${table.tableID})" class="btn btn-success">å®Œæˆæ¸…æ´</button>
                        <button onclick="Utils.hideModal('tableModal')" class="btn btn-secondary">å…³é—­</button>
                    </div>
                </div>
            `;
            Utils.showModal('tableModal');
        }

        async function handleOpenTable() {
            if (!Utils.validateForm(document.getElementById('openTableForm'))) {
                Utils.showNotification('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'warning');
                return;
            }

            try {
                const staffId = document.getElementById('staffSelect').value;
                const notes = document.getElementById('orderNotes').value;

                console.log(`å¼€å°ï¼šå‡†å¤‡å¼€å¯æ¡Œå° ${currentTableId}`);
                console.log('å¼€å°URL:', `/api/tables/${currentTableId}/open`);
                console.log('å¼€å°å‚æ•°:', { staffId, notes });

                // ä½¿ç”¨ä¸“é—¨çš„å¼€å°API
                const openTableResult = await API.post(`/tables/${currentTableId}/open`, { 
                    staffId: staffId,
                    notes: notes 
                });
                console.log('å¼€å°APIè¿”å›ç»“æœ:', openTableResult);

                Utils.showNotification('å¼€å°æˆåŠŸ', 'success');
                Utils.hideModal('openTableModal');
                Utils.resetForm(document.getElementById('openTableForm'));
                
                // åˆ·æ–°æ¡Œå°çŠ¶æ€
                await loadTables();

            } catch (error) {
                console.error('å¼€å°å¤±è´¥:', error);
                console.error('å¼€å°é”™è¯¯è¯¦æƒ…:', error.response || error.message);
                console.error('å¼€å°é”™è¯¯çŠ¶æ€ç :', error.status);
                console.error('å¼€å°å®Œæ•´é”™è¯¯å¯¹è±¡:', error);
                Utils.showNotification('å¼€å°å¤±è´¥', 'error');
            }
        }

        let currentCheckoutOrderId = null;

        async function checkoutOrder(orderId) {
            try {
                // å…ˆè·å–è®¢å•ä¿¡æ¯ç”¨äºæ˜¾ç¤º
                const order = await API.get(`/orders/${orderId}`);
                if (!order) {
                    Utils.showNotification('è®¢å•ä¸å­˜åœ¨', 'error');
                    return;
                }

                // è·å–è®¢å•è¯¦æƒ…è®¡ç®—æ€»é‡‘é¢
                const details = await API.get(`/orders/${orderId}/details`).catch(() => []);
                const totalAmount = details.reduce((sum, d) => {
                    return sum + d.Subtotal;
                }, 0);

                // è®¾ç½®å½“å‰è¦ç»“è´¦çš„è®¢å•ID
                currentCheckoutOrderId = orderId;

                // å¡«å……ç¡®è®¤ä¿¡æ¯
                document.getElementById('checkout-order-info').innerHTML = `
                    <strong>è®¢å•å·:</strong> #${orderId}<br>
                    <strong>æ€»é‡‘é¢:</strong> <span style="color: #28a745; font-size: 1.2em;">${Utils.formatCurrency(totalAmount)}</span>
                `;

                // æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†
                Utils.showModal('checkoutConfirmModal');

            } catch (error) {
                console.error('è·å–è®¢å•ä¿¡æ¯å¤±è´¥:', error);
                Utils.showNotification('è·å–è®¢å•ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        async function confirmCheckout() {
            if (!currentCheckoutOrderId) {
                Utils.showNotification('è®¢å•ä¿¡æ¯å¼‚å¸¸', 'error');
                return;
            }

            try {
                Utils.showNotification('æ­£åœ¨å¤„ç†ç»“è´¦...', 'info');
                
                // éšè—ç¡®è®¤æ¨¡æ€æ¡†
                Utils.hideModal('checkoutConfirmModal');

                // å…ˆè·å–è®¢å•ä¿¡æ¯
                const order = await API.get(`/orders/${currentCheckoutOrderId}`);
                if (!order) {
                    throw new Error('è®¢å•ä¸å­˜åœ¨');
                }

                console.log('ç»“è´¦å‰è®¢å•çŠ¶æ€:', order.orderStatus);

                // æ‰§è¡Œç»“è´¦æ“ä½œ
                const checkoutResult = await API.put(`/orders/${currentCheckoutOrderId}/checkout`);
                console.log('ç»“è´¦APIè¿”å›ç»“æœ:', checkoutResult);

                // éªŒè¯è®¢å•çŠ¶æ€æ˜¯å¦å·²æ›´æ–°ä¸º"å·²ç»“è´¦"
                const updatedOrder = await API.get(`/orders/${currentCheckoutOrderId}`);
                console.log('ç»“è´¦åè®¢å•çŠ¶æ€:', updatedOrder?.orderStatus);

                if (updatedOrder && updatedOrder.orderStatus !== 'å·²ç»“è´¦') {
                    console.warn(`è®¢å•çŠ¶æ€æ›´æ–°å¼‚å¸¸: æœŸæœ›"å·²ç»“è´¦"ï¼Œå®é™…"${updatedOrder.orderStatus}"`);
                    // æ‰‹åŠ¨æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
                    try {
                        await API.put(`/orders/${currentCheckoutOrderId}/status`, { status: 'å·²ç»“è´¦' });
                        console.log('æ‰‹åŠ¨æ›´æ–°è®¢å•çŠ¶æ€ä¸º"å·²ç»“è´¦"');
                    } catch (statusUpdateError) {
                        console.error('æ‰‹åŠ¨æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', statusUpdateError);
                    }
                }
                
                // è®¾ç½®æ¡Œå°ä¸ºæ¸…æ´ä¸­çŠ¶æ€
                if (order.tableID) {
                    try {
                        console.log(`å‡†å¤‡å°†æ¡Œå° ${order.tableID} çŠ¶æ€æ›´æ–°ä¸ºæ¸…æ´ä¸­`);
                        console.log('æ¡Œå°çŠ¶æ€æ›´æ–°URL:', `/api/tables/${order.tableID}/status`);
                        console.log('æ¡Œå°çŠ¶æ€æ›´æ–°å‚æ•°:', { status: "æ¸…æ´ä¸­" });
                        
                        const tableUpdateResult = await API.put(`/tables/${order.tableID}/status`, { Status: "æ¸…æ´ä¸­" });
                        console.log('æ¡Œå°çŠ¶æ€æ›´æ–°APIè¿”å›ç»“æœ:', tableUpdateResult);
                        console.log('æ¡Œå°çŠ¶æ€å·²æ›´æ–°ä¸ºæ¸…æ´ä¸­');
                    } catch (tableError) {
                        console.error('æ›´æ–°æ¡Œå°çŠ¶æ€å¤±è´¥:', tableError);
                        console.error('é”™è¯¯è¯¦æƒ…:', tableError.response || tableError.message);
                        console.error('é”™è¯¯çŠ¶æ€ç :', tableError.status);
                        console.error('å®Œæ•´é”™è¯¯å¯¹è±¡:', tableError);
                        Utils.showNotification(`æ¡Œå°çŠ¶æ€æ›´æ–°å¤±è´¥: ${tableError.message || 'æœªçŸ¥é”™è¯¯'}`, 'warning');
                        // ä¸å½±å“ç»“è´¦æµç¨‹ï¼Œç»§ç»­æ‰§è¡Œ
                    }
                } else {
                    console.warn('è®¢å•æ²¡æœ‰å…³è”çš„æ¡Œå°IDï¼Œæ— æ³•æ›´æ–°æ¡Œå°çŠ¶æ€');
                }

                Utils.showNotification(`è®¢å• #${currentCheckoutOrderId} ç»“è´¦æˆåŠŸï¼`, 'success');
                Utils.hideModal('tableModal');
                
                // é‡ç½®å½“å‰ç»“è´¦è®¢å•ID
                currentCheckoutOrderId = null;
                
                // åˆ·æ–°æ¡Œå°çŠ¶æ€
                await loadTables();

            } catch (error) {
                console.error('ç»“è´¦å¤±è´¥:', error);
                let errorMessage = 'ç»“è´¦å¤±è´¥';
                
                if (error.response) {
                    console.error('APIé”™è¯¯è¯¦æƒ…:', error.response);
                    if (error.response.status === 404) {
                        errorMessage = 'è®¢å•ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤';
                    } else if (error.response.status === 400) {
                        errorMessage = 'è®¢å•çŠ¶æ€å¼‚å¸¸ï¼Œæ— æ³•ç»“è´¦';
                    } else {
                        errorMessage = `ç»“è´¦å¤±è´¥ (é”™è¯¯ç : ${error.response.status})`;
                    }
                } else if (error.message) {
                    errorMessage = `ç»“è´¦å¤±è´¥: ${error.message}`;
                }
                
                Utils.showNotification(errorMessage, 'error');
                
                // é‡ç½®å½“å‰ç»“è´¦è®¢å•ID
                currentCheckoutOrderId = null;
            }
        }

        async function finishCleaning(tableId) {
            try {
                Utils.showNotification('æ­£åœ¨å®Œæˆæ¸…æ´...', 'info');
                
                await API.put(`/tables/${tableId}/status`, { Status: "ç©ºé—²" });
                
                Utils.showNotification('æ¸…æ´å®Œæˆï¼Œæ¡Œå°å·²è®¾ä¸ºç©ºé—²', 'success');
                Utils.hideModal('tableModal');
                
                // åˆ·æ–°æ¡Œå°çŠ¶æ€
                await loadTables();

            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
                Utils.showNotification('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        function addDish(orderId) {
            // è·³è½¬åˆ°èœå•é¡µé¢ï¼Œä¼ é€’è®¢å•ID
            const currentTable = tables.find(t => t.tableID === currentTableId);
            const tableNumber = currentTable ? currentTable.tableNumber : '';
            
            // æ„å»ºè·³è½¬URLï¼ŒåŒ…å«è®¢å•IDå’Œæ¡Œå°ä¿¡æ¯
            const menuUrl = `menu.html?orderId=${orderId}&tableId=${currentTableId}&tableNumber=${tableNumber}&action=addDish`;
            
            // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æˆ–å½“å‰é¡µé¢è·³è½¬
            if (confirm('æ˜¯å¦åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ç‚¹èœé¡µé¢ï¼Ÿ\nç‚¹å‡»"ç¡®å®š"åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼Œç‚¹å‡»"å–æ¶ˆ"åœ¨å½“å‰é¡µé¢è·³è½¬ã€‚')) {
                window.open(menuUrl, '_blank');
            } else {
                window.location.href = menuUrl;
            }
        }

        async function createNewOrder(tableId) {
            try {
                // æ˜¾ç¤ºåˆ›å»ºä¸­çŠ¶æ€
                Utils.showNotification('æ­£åœ¨åˆ›å»ºè®¢å•...', 'info');

                // è·å–å‘˜å·¥åˆ—è¡¨ç”¨äºåˆ›å»ºè®¢å•
                if (staff.length === 0) {
                    await loadStaff();
                }

                // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯æˆ–ä½¿ç”¨é»˜è®¤å‘˜å·¥
                const currentUser = Auth.getCurrentUser();
                let selectedStaffId = null;

                if (currentUser && currentUser.staffID) {
                    selectedStaffId = currentUser.staffID;
                } else {
                    const availableStaff = staff.find(s => s.status === 'åœ¨èŒ');
                    if (availableStaff) {
                        selectedStaffId = availableStaff.staffID;
                    }
                }

                if (!selectedStaffId) {
                    Utils.showNotification('æ²¡æœ‰å¯ç”¨çš„æœåŠ¡å‘˜ï¼Œè¯·å…ˆæ·»åŠ å‘˜å·¥', 'warning');
                    return;
                }

                // åˆ›å»ºè®¢å•æ•°æ®
                const orderData = {
                    tableID: tableId,
                    customerID: null, // ç°åœºå®¢æˆ·ï¼Œæ— éœ€å®¢æˆ·ID
                    staffID: selectedStaffId,
                    orderTime: new Date().toISOString(),
                    totalAmount: 0, // åˆå§‹é‡‘é¢ä¸º0ï¼Œåç»­é€šè¿‡ç‚¹èœå¢åŠ 
                    orderStatus: 'å¾…å¤„ç†', // æ ¹æ®è¡¨è®¾è®¡æ–‡æ¡£ï¼Œæ–°è®¢å•çŠ¶æ€ä¸º"å¾…å¤„ç†"
                    notes: `æ¡Œå°${tables.find(t => t.tableID === tableId)?.tableNumber || tableId}å¼€å°`
                };

                console.log('åˆ›å»ºè®¢å•æ•°æ®:', orderData);

                // è°ƒç”¨APIåˆ›å»ºè®¢å•
                const result = await API.post('/orders', orderData);
                
                if (result && (result.orderID || result.id)) {
                    const orderId = result.orderID || result.id;
                    Utils.showNotification(`è®¢å•åˆ›å»ºæˆåŠŸï¼è®¢å•å·: #${orderId}`, 'success');
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    Utils.hideModal('tableModal');
                    
                    // åˆ·æ–°æ¡Œå°çŠ¶æ€ä»¥æ›´æ–°è®¢å•ä¿¡æ¯
                    await loadTables();
                    
                    // å¯é€‰ï¼šè‡ªåŠ¨è·³è½¬åˆ°ç‚¹èœé¡µé¢
                    // window.location.href = `menu.html?orderId=${orderId}&tableId=${tableId}`;
                } else {
                    throw new Error('åˆ›å»ºè®¢å•è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸');
                }

            } catch (error) {
                console.error('åˆ›å»ºè®¢å•å¤±è´¥:', error);
                let errorMessage = 'åˆ›å»ºè®¢å•å¤±è´¥';
                
                if (error.response) {
                    // APIè¿”å›çš„é”™è¯¯
                    if (error.response.status === 400) {
                        errorMessage = 'è®¢å•æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥';
                    } else if (error.response.status === 500) {
                        errorMessage = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                    } else {
                        errorMessage = `åˆ›å»ºè®¢å•å¤±è´¥ (é”™è¯¯ç : ${error.response.status})`;
                    }
                } else if (error.message) {
                    errorMessage = `åˆ›å»ºè®¢å•å¤±è´¥: ${error.message}`;
                }
                
                Utils.showNotification(errorMessage, 'error');
            }
        }

        async function refreshTables() {
            Utils.showNotification('æ­£åœ¨åˆ·æ–°...', 'info');
            await loadTables();
            Utils.showNotification('åˆ·æ–°å®Œæˆ', 'success');
        }
    </script>
</body>
</html>
