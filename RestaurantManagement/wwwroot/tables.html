<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê°åÂè∞ÁÆ°ÁêÜ - È§êÈ•ÆÁÆ°ÁêÜÁ≥ªÁªü</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Ê°åÂè∞ËØ¶ÊÉÖÊ†∑ÂºèÂ¢ûÂº∫ */
        .table-details-container {
            max-height: 70vh;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .table-basic-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid #e1f5fe;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            transition: background-color 0.2s ease;
        }
        
        .info-row:hover {
            background-color: rgba(0,0,0,0.02);
            border-radius: 6px;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .info-label::before {
            content: "‚Ä¢";
            color: #007bff;
            font-size: 1.2rem;
        }
        
        .info-value {
            color: #212529;
            font-weight: 500;
        }
        
        .order-info-section {
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #f1f8e9 0%, #f8fff8 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);
        }
        
        .order-info-section h4 {
            color: #28a745;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
        }
        
        .order-info-section h4::before {
            content: "üìã";
            font-size: 1.3rem;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .info-grid p {
            margin: 0.5rem 0;
            padding: 0.75rem;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.06);
            transition: all 0.2s ease;
        }
        
        .info-grid p:hover {
            background: rgba(255,255,255,0.9);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .dishes-section {
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #fff3e0 0%, #fffef7 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #ff9800;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
        }
        
        .dishes-section h5 {
            color: #f57f17;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }
        
        .dishes-section h5::before {
            content: "üçΩÔ∏è";
            font-size: 1.2rem;
        }
        
        .table-responsive {
            max-height: 350px;
            overflow-y: auto;
            border: none;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .table-responsive table {
            margin-bottom: 0;
        }
        
        .table-responsive thead th {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            font-weight: 600;
            border: none;
            padding: 1rem 0.75rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .table-responsive tbody tr {
            transition: background-color 0.2s ease;
        }
        
        .table-responsive tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .table-responsive tbody td {
            padding: 0.875rem 0.75rem;
            border-top: 1px solid #e9ecef;
            vertical-align: middle;
        }
        
        .total-row {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%) !important;
            font-weight: bold;
            color: #155724;
        }
        
        .total-row td {
            border-top: 2px solid #28a745 !important;
            padding: 1rem 0.75rem !important;
        }
        
        .empty-state {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
        }
        
        .empty-state::before {
            content: "üçΩÔ∏è";
            font-size: 3rem;
            display: block;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .no-order-section {
            margin: 1.5rem 0;
        }
        
        .action-buttons {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border-top: 1px solid #e9ecef;
            margin-top: 1.5rem;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
        }
        
        .action-buttons .btn {
            margin: 0.25rem;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .action-buttons .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .action-buttons .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
        }
        
        .action-buttons .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border: none;
        }
        
        .action-buttons .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            border: none;
        }
        
        .action-buttons .btn-light {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .error-state {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            color: #721c24;
        }
        
        /* ËÆ¢ÂçïÁä∂ÊÄÅÊ†∑Âºè */
        .status-active { 
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
            color: white; 
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }
        .status-success { 
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); 
            color: white; 
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
        }
        .status-cancelled { 
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
            color: white; 
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }
        .status-finished { 
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%); 
            color: white; 
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
        }
        .status-default { 
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); 
            color: #212529; 
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
        }
        
        /* Âä†ËΩΩÂä®Áîª */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        
        /* Ê®°ÊÄÅÊ°ÜÁæéÂåñ */
        .modal-content {
            border-radius: 16px;
            border: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-bottom: none;
            position: relative;
        }
        
        .modal-header h3 {
            margin: 0;
            font-weight: 700;
            font-size: 1.3rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .modal-header .close {
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 1.5rem;
            font-weight: 300;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        
        .modal-header .close:hover {
            opacity: 1;
        }
        
        #modal-body {
            padding: 0;
            background: #fafafa;
        }
        
        /* ÁæéÂåñË¥ßÂ∏ÅÊòæÁ§∫ */
        .currency {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        /* ÁæéÂåñË°®Ê†º */
        .table-responsive tbody td strong {
            color: #2c3e50;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-muted {
            color: #6c757d !important;
            font-style: italic;
        }
        
        /* ÁæéÂåñÂä†ËΩΩÁä∂ÊÄÅ */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        
        /* Â¢ûÂº∫ÂìçÂ∫îÂºè‰ΩìÈ™å */
        @media (max-width: 768px) {
            .modal-content {
                margin: 1rem;
                max-height: 95vh;
            }
            
            .table-details-container {
                padding: 1rem;
            }
            
            .order-info-section,
            .dishes-section {
                padding: 1rem;
            }
            
            .action-buttons {
                padding: 1rem;
            }
            
            .action-buttons .btn {
                display: block;
                width: 100%;
                margin: 0.25rem 0;
            }
        }
        
        /* Âä†ËèúÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .dish-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            padding: 1rem;
            min-height: 100px; /* Á°Æ‰øùÊúâÊúÄÂ∞èÈ´òÂ∫¶ */
        }
        
        .dish-item {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            background: white;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .dish-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.15);
            transform: translateY(-1px);
        }
        
        .dish-item.selected {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        
        .dish-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #212529;
            margin-bottom: 0.5rem;
        }
        
        .dish-description {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }
        
        .dish-price {
            color: #e74c3c;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
        }
        
        .dish-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }
        
        .quantity-btn:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }
        
        .quantity-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 0.25rem;
        }
        
        .selected-dish-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        
        .selected-dish-info {
            flex: 1;
        }
        
        .selected-dish-name {
            font-weight: 600;
            color: #212529;
        }
        
        .selected-dish-details {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .selected-dish-total {
            font-weight: 600;
            color: #28a745;
            margin-left: 1rem;
        }
        
        .remove-dish-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 0.5rem;
            font-size: 0.8rem;
        }
        
        .remove-dish-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>È§êÈ•ÆÁÆ°ÁêÜÁ≥ªÁªü</h1>
        <div class="nav-links">
            <a href="index.html">È¶ñÈ°µ</a>
            <a href="tables.html" class="active">Ê°åÂè∞ÁÆ°ÁêÜ</a>
            <a href="orders.html">ËÆ¢ÂçïÁÆ°ÁêÜ</a>
            <a href="menu.html">ËèúÂçïÁÆ°ÁêÜ</a>
            <a href="staff.html">ÂëòÂ∑•ÁÆ°ÁêÜ</a>
            <a href="inventory.html">Â∫ìÂ≠òÁÆ°ÁêÜ</a>
        </div>
    </nav>

    <div class="container">
        <div class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>Ê°åÂè∞ÁÆ°ÁêÜ</h2>
                <div>
                    <button onclick="refreshTables()" class="btn btn-secondary">Âà∑Êñ∞Áä∂ÊÄÅ</button>
                </div>
            </div>

            <!-- Ê°åÂè∞Áä∂ÊÄÅÁªüËÆ° -->
            <div class="card">
                <h3>Ê°åÂè∞Áä∂ÊÄÅÊ¶ÇËßà</h3>
                <div style="display: flex; gap: 2rem; margin-top: 1rem;">
                    <div>
                        <span class="status-badge status-available">Á©∫Èó≤: <span id="available-count">0</span></span>
                    </div>
                    <div>
                        <span class="status-badge status-occupied">Âç†Áî®: <span id="occupied-count">0</span></span>
                    </div>
                    <div>
                        <span class="status-badge status-reserved">È¢ÑËÆ¢: <span id="reserved-count">0</span></span>
                    </div>
                    <div>
                        <span class="status-badge status-cleaning">Ê∏ÖÊ¥Å‰∏≠: <span id="cleaning-count">0</span></span>
                    </div>
                </div>
            </div>

            <!-- Ê°åÂè∞ÁΩëÊ†º -->
            <div class="card">
                <h3>Ê°åÂè∞Â∏ÉÂ±Ä</h3>
                <div id="table-grid" class="table-grid">
                    <!-- Ê°åÂè∞È°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Ê°åÂè∞ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
    <div id="tableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Ê°åÂè∞ËØ¶ÊÉÖ</h3>
                <span class="close">&times;</span>
            </div>
            <div id="modal-body">
                <!-- ÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
            </div>
        </div>
    </div>

    <!-- ÂºÄÂè∞Ê®°ÊÄÅÊ°Ü -->
    <div id="openTableModal" class="modal">
        <div class="modal-content" style="
            max-width: 500px; 
            max-height: 90vh; 
            margin: 5vh auto;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        ">
            <div class="modal-header" style="
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
                color: white;
                flex-shrink: 0;
            ">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üè™ <span id="openTableTitle">ÂºÄÂè∞</span>
                </h3>
                <span class="close">&times;</span>
            </div>
            <div style="
                padding: 2rem; 
                background: linear-gradient(135deg, #f8fff8 0%, #ffffff 100%);
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
            ">>
                <form id="openTableForm">
                    <!-- Ê°åÂè∞‰ø°ÊÅØÂ±ïÁ§∫ -->
                    <div style="
                        background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
                        padding: 1.5rem;
                        border-radius: 12px;
                        margin-bottom: 2rem;
                        border: 1px solid #c3e6cb;
                        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);
                    ">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üçΩÔ∏è</div>
                            <h4 style="color: #28a745; margin: 0; font-weight: 700;" id="tableInfoDisplay">ÂáÜÂ§áÂºÄÂè∞</h4>
                            <p style="color: #6c757d; margin: 0.5rem 0 0 0; font-size: 0.9rem;">‰∏∫ÂÆ¢‰∫∫Êèê‰æõ‰ºòË¥®ÊúçÂä°</p>
                        </div>
                    </div>

                    <!-- Ë°®ÂçïÂ≠óÊÆµ -->
                    <div class="form-group" style="margin-bottom: 1.75rem;">
                        <label for="staffSelect" style="
                            display: block;
                            margin-bottom: 0.75rem;
                            font-weight: 600;
                            color: #495057;
                            font-size: 1rem;
                        ">üë®‚Äçüíº Ë¥üË¥£ÊúçÂä°Âëò:</label>
                        <select id="staffSelect" class="form-control" required style="
                            width: 100%;
                            padding: 0.875rem 1rem;
                            border: 2px solid #e9ecef;
                            border-radius: 8px;
                            font-size: 1rem;
                            transition: all 0.3s ease;
                            background: white;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        " onchange="this.style.borderColor = this.value ? '#28a745' : '#e9ecef'">
                            <option value="">ËØ∑ÈÄâÊã©ÊúçÂä°Âëò</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label for="orderNotes" style="
                            display: block;
                            margin-bottom: 0.75rem;
                            font-weight: 600;
                            color: #495057;
                            font-size: 1rem;
                        ">üìù ÂºÄÂè∞Â§áÊ≥®:</label>
                        <textarea id="orderNotes" class="form-control" rows="3" placeholder="ËØ∑ËæìÂÖ•ÂºÄÂè∞Â§áÊ≥®‰ø°ÊÅØÔºàÂèØÈÄâÔºâ" style="
                            width: 100%;
                            padding: 0.875rem 1rem;
                            border: 2px solid #e9ecef;
                            border-radius: 8px;
                            font-size: 1rem;
                            resize: vertical;
                            min-height: 80px;
                            transition: all 0.3s ease;
                            background: white;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        " onfocus="this.style.borderColor = '#28a745'; this.style.boxShadow = '0 4px 8px rgba(40, 167, 69, 0.15)'"
                           onblur="this.style.borderColor = '#e9ecef'; this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)'"></textarea>
                    </div>

                    <!-- ÊåâÈíÆÁªÑ -->
                    <div style="
                        display: flex;
                        gap: 1rem;
                        justify-content: center;
                        padding-top: 1rem;
                        border-top: 1px solid #e9ecef;
                    ">
                        <button type="button" onclick="Utils.hideModal('openTableModal')" class="btn btn-secondary" style="
                            padding: 0.75rem 1.5rem;
                            border-radius: 8px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            font-size: 0.9rem;
                            transition: all 0.3s ease;
                            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                            border: none;
                            color: white;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            ‚ùå ÂèñÊ∂à
                        </button>
                        <button type="submit" class="btn btn-primary" style="
                            padding: 0.75rem 2rem;
                            border-radius: 8px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            font-size: 0.9rem;
                            transition: all 0.3s ease;
                            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                            border: none;
                            color: white;
                            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(40, 167, 69, 0.3)'"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(40, 167, 69, 0.2)'">
                            ‚úÖ Á°ÆËÆ§ÂºÄÂè∞
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ÁªìË¥¶Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü -->
    <div id="checkoutConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 450px; margin: 10% auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üí≥ Á°ÆËÆ§ÁªìË¥¶
                </h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" style="padding: 0; background: linear-gradient(135deg, #f8fff8 0%, #ffffff 100%);">
                <div style="text-align: center; padding: 2rem;">
                    <!-- ÊàêÂäüÂõæÊ†á -->
                    <div style="
                        width: 80px;
                        height: 80px;
                        margin: 0 auto 1.5rem;
                        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 2.5rem;
                        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                        animation: pulse 1.5s ease-in-out infinite alternate;
                    ">üí≥</div>
                    
                    <h4 style="
                        color: #28a745; 
                        margin-bottom: 1.5rem;
                        font-size: 1.3rem;
                        font-weight: 700;
                    ">Á°ÆËÆ§Ë¶Å‰∏∫Ê≠§ËÆ¢ÂçïÁªìË¥¶ÂêóÔºü</h4>
                    
                    <div id="checkout-order-info" style="
                        color: #495057; 
                        margin-bottom: 2rem;
                        background: rgba(255,255,255,0.8);
                        padding: 1.5rem;
                        border-radius: 12px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                        font-size: 1.1rem;
                        line-height: 1.6;
                    ">
                        <!-- ËÆ¢Âçï‰ø°ÊÅØÂ∞ÜÂä®ÊÄÅÂ°´ÂÖÖ -->
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="Utils.hideModal('checkoutConfirmModal')" class="btn btn-secondary" style="
                            padding: 0.75rem 1.5rem;
                            border-radius: 8px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            font-size: 0.9rem;
                            transition: all 0.3s ease;
                            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                            border: none;
                            color: white;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            ‚ùå ÂèñÊ∂à
                        </button>
                        
                        <button id="confirmCheckoutBtn" onclick="confirmCheckout()" class="btn btn-success" style="
                            padding: 0.75rem 2rem;
                            border-radius: 8px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            font-size: 0.9rem;
                            transition: all 0.3s ease;
                            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                            border: none;
                            color: white;
                            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(40, 167, 69, 0.3)'"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(40, 167, 69, 0.2)'">
                            ‚úÖ Á°ÆËÆ§ÁªìË¥¶
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Âä†ËèúÊ®°ÊÄÅÊ°Ü -->
    <div id="addDishModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 id="addDishModalTitle">Âä†Ëèú</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 1rem;">
                <!-- ËÆ¢Âçï‰ø°ÊÅØÊëòË¶Å -->
                <div id="orderSummary" style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                    <!-- ËÆ¢ÂçïÊëòË¶ÅÂ∞ÜÂä®ÊÄÅÂ°´ÂÖÖ -->
                </div>
                
                <!-- ËèúÂìÅÂàÜÁ±ªÂíåÊêúÁ¥¢ -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="flex: 1;">
                            <label for="dishCategoryFilter">ËèúÂìÅÂàÜÁ±ª:</label>
                            <select id="dishCategoryFilter" class="form-control" onchange="filterDishes()">
                                <option value="">ÂÖ®ÈÉ®ÂàÜÁ±ª</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="dishSearchInput">ÊêúÁ¥¢ËèúÂìÅ:</label>
                            <input type="text" id="dishSearchInput" class="form-control" placeholder="ËæìÂÖ•ËèúÂìÅÂêçÁß∞ÊêúÁ¥¢" oninput="filterDishes()">
                        </div>
                    </div>
                </div>
                
                <!-- ËèúÂìÅÂàóË°® -->
                <div id="dishesGrid" style="max-height: 350px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.5rem; background: #f8f9fa; margin-bottom: 1rem;">
                    <!-- ËèúÂìÅÁΩëÊ†ºÂ∞ÜÂä®ÊÄÅÂ°´ÂÖÖ -->
                </div>
                
                <!-- Â∑≤ÈÄâËèúÂìÅ -->
                <div id="selectedDishesSection" style="display: none;">
                    <h5>Â∑≤ÈÄâËèúÂìÅ:</h5>
                    <div id="selectedDishesList" style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; max-height: 200px; overflow-y: auto;">
                        <!-- Â∑≤ÈÄâËèúÂìÅÂàóË°® -->
                    </div>
                    <div style="text-align: right; margin-bottom: 1rem;">
                        <strong>Êú¨Ê¨°Âä†ËèúÊÄªËÆ°: <span id="addDishTotal" style="color: #28a745; font-size: 1.2rem;">¬•0.00</span></strong>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="flex-shrink: 0;">
                <button onclick="Utils.hideModal('addDishModal')" class="btn btn-secondary">ÂèñÊ∂à</button>
                <button onclick="confirmAddSelectedDishes()" class="btn btn-primary" id="confirmAddDishBtn" disabled>Á°ÆËÆ§Âä†Ëèú</button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let currentTableId = null;
        let tables = [];
        let staff = [];
        let currentAddDishOrderId = null;
        let availableDishes = [];
        let dishCategories = [];
        let selectedDishes = new Map(); // ‰ΩøÁî®MapÂ≠òÂÇ®Â∑≤ÈÄâËèúÂìÅ {dishId: {dish, quantity, specialRequests}}

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            loadTables();
            loadStaff();
            loadDishesForAddDish();
            setupEventListeners();
        });

        function setupEventListeners() {
            // ÂºÄÂè∞Ë°®ÂçïÊèê‰∫§
            document.getElementById('openTableForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleOpenTable();
            });
        }

        async function loadTables() {
            try {
                tables = await API.get('/tables');
                renderTables();
                updateStatusCounts();
            } catch (error) {
                console.error('Âä†ËΩΩÊ°åÂè∞Êï∞ÊçÆÂ§±Ë¥•:', error);
                Utils.showNotification('Âä†ËΩΩÊ°åÂè∞Êï∞ÊçÆÂ§±Ë¥•', 'error');
            }
        }

        async function loadStaff() {
            try {
                staff = await API.get('/staff');
                populateStaffSelect();
            } catch (error) {
                console.error('Âä†ËΩΩÂëòÂ∑•Êï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        function populateStaffSelect() {
            const select = document.getElementById('staffSelect');
            select.innerHTML = '<option value="">ËØ∑ÈÄâÊã©ÊúçÂä°Âëò</option>';
            
            staff.filter(s => s.status === 'Âú®ËÅå').forEach(s => {
                const option = document.createElement('option');
                option.value = s.staffID;
                option.textContent = s.staffName;
                select.appendChild(option);
            });
        }

        function renderTables() {
            const grid = document.getElementById('table-grid');
            grid.innerHTML = '';

            tables.forEach(table => {
                const tableItem = document.createElement('div');
                // Ëé∑ÂèñÊ°åÂè∞È°πÁöÑÁä∂ÊÄÅÁ±ªÔºà‰∏çÂ∏¶ status- ÂâçÁºÄÔºâ
                const statusInfo = Utils.getStatusInfo(table.status, 'table');
                const tableStatusClass = statusInfo.class.replace('status-', ''); // ÁßªÈô§ status- ÂâçÁºÄ
                tableItem.className = `table-item ${tableStatusClass}`;
                tableItem.onclick = () => handleTableClick(table);

                tableItem.innerHTML = `
                    <div class="table-number">Ê°åÂè∞ ${table.tableNumber}</div>
                    <div class="table-capacity">ÂÆπÈáè: ${table.capacity}‰∫∫</div>
                    <div class="status-badge ${statusInfo.class}">
                        ${statusInfo.text}
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
                        Âå∫Âüü: ${table.area}
                    </div>
                `;

                grid.appendChild(tableItem);
            });
        }

        function updateStatusCounts() {
            const counts = {
                available: tables.filter(t => t.status === 'Á©∫Èó≤').length,
                occupied: tables.filter(t => t.status === 'Âç†Áî®').length,
                reserved: tables.filter(t => t.status === 'È¢ÑËÆ¢').length,
                cleaning: tables.filter(t => t.status === 'Ê∏ÖÊ¥Å‰∏≠').length
            };

            document.getElementById('available-count').textContent = counts.available;
            document.getElementById('occupied-count').textContent = counts.occupied;
            document.getElementById('reserved-count').textContent = counts.reserved;
            document.getElementById('cleaning-count').textContent = counts.cleaning;
        }

        async function handleTableClick(table) {
            currentTableId = table.tableID;
            
            if (table.status === 'Á©∫Èó≤') {
                showOpenTableModal(table);
            } else if (table.status === 'Âç†Áî®') {
                await showTableDetails(table);
            } else if (table.status === 'Ê∏ÖÊ¥Å‰∏≠') {
                showTableCleaningOptions(table);
            }
        }

        function showOpenTableModal(table) {
            // Êõ¥Êñ∞Ê®°ÊÄÅÊ°ÜÊ†áÈ¢òÂíåÊ°åÂè∞‰ø°ÊÅØ
            document.getElementById('openTableTitle').textContent = `ÂºÄÂè∞ - Ê°åÂè∞${table.tableNumber}`;
            document.getElementById('tableInfoDisplay').innerHTML = `
                Ê°åÂè∞${table.tableNumber} (${table.capacity}‰∫∫Ê°å)
                <br><small style="color: #6c757d; font-size: 0.8rem;">Âå∫Âüü: ${table.area}</small>
            `;
            
            // ÈáçÁΩÆË°®Âçï
            Utils.resetForm(document.getElementById('openTableForm'));
            
            Utils.showModal('openTableModal');
        }

        async function showTableDetails(table) {
            try {
                // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
                document.getElementById('modal-title').textContent = `Ê°åÂè∞${table.tableNumber} - Âä†ËΩΩ‰∏≠...`;
                document.getElementById('modal-body').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div class="loading-spinner"></div>
                        <p>Ê≠£Âú®Âä†ËΩΩËÆ¢Âçï‰ø°ÊÅØ...</p>
                    </div>
                `;
                Utils.showModal('tableModal');

                // Ëé∑ÂèñÂΩìÂâçËÆ¢Âçï‰ø°ÊÅØÔºåÂ¢ûÂä†ÈîôËØØÂ§ÑÁêÜ
                let currentOrder = null;
                try {
                    const response = await fetch(`/api/tables/${table.tableID}/current-order`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        currentOrder = await response.json();
                        console.log('Ëé∑ÂèñÂà∞ÁöÑËÆ¢ÂçïÊï∞ÊçÆ:', currentOrder);
                    } else if (response.status === 404) {
                        // 404Ë°®Á§∫Ê≤°ÊúâËÆ¢ÂçïÔºåËøôÊòØÊ≠£Â∏∏ÊÉÖÂÜµ
                        currentOrder = null;
                    } else {
                        throw new Error(`APIË∞ÉÁî®Â§±Ë¥•: ${response.status} ${response.statusText}`);
                    }
                } catch (apiError) {
                    console.warn('Ëé∑ÂèñËÆ¢ÂçïAPIË∞ÉÁî®Â§±Ë¥•:', apiError);
                    // Â¶ÇÊûúÊòØÁΩëÁªúÈîôËØØÊàñÊúçÂä°Âô®ÈîôËØØÔºåÁªßÁª≠ÊòæÁ§∫Êó†ËÆ¢ÂçïÁä∂ÊÄÅ
                    currentOrder = null;
                }
                
                let orderDetails = '';
                let staffInfo = '';
                
                if (currentOrder) {
                    // Ëé∑ÂèñËÆ¢ÂçïËØ¶ÊÉÖÂíåÊúçÂä°Âëò‰ø°ÊÅØ
                    const [detailsResponse, orderStaff] = await Promise.all([
                        API.get(`/orders/${currentOrder.orderID}/details`).catch(() => ({ details: [] })),
                        currentOrder.staffID ? API.get(`/staff/${currentOrder.staffID}`).catch(() => null) : null
                    ]);

                    staffInfo = orderStaff ? `
                        <p><strong>Ë¥üË¥£ÊúçÂä°Âëò:</strong> ${orderStaff.staffName}</p>
                    ` : '';

                    // Ê≠£Á°ÆËß£ÊûêÂêéÁ´ØËøîÂõûÁöÑÊï∞ÊçÆÁªìÊûÑ
                    console.log('ËÆ¢ÂçïËØ¶ÊÉÖÂìçÂ∫îÊï∞ÊçÆ:', detailsResponse);
                    console.log('ÂìçÂ∫îÊï∞ÊçÆÁ±ªÂûã:', typeof detailsResponse);
                    
                    // ÂêéÁ´ØËøîÂõûÁöÑÊòØ { details: [...], statistics: {...} } Ê†ºÂºè
                    let detailsArray = [];
                    if (detailsResponse && Array.isArray(detailsResponse.details)) {
                        detailsArray = detailsResponse.details;
                    } else if (Array.isArray(detailsResponse)) {
                        // ÂÖºÂÆπÁõ¥Êé•ËøîÂõûÊï∞ÁªÑÁöÑÊÉÖÂÜµ
                        detailsArray = detailsResponse;
                    }
                    
                    console.log('Ëß£ÊûêÂêéÁöÑËØ¶ÊÉÖÊï∞ÁªÑ:', detailsArray);
                    console.log('ËØ¶ÊÉÖÊï∞ÁªÑÈïøÂ∫¶:', detailsArray.length);
                    console.log('ÊòØÂê¶‰∏∫Êï∞ÁªÑ:', Array.isArray(detailsArray));
                    
                    // Ë∞ÉËØïÔºöÊü•ÁúãÁ¨¨‰∏ÄÊù°ËÆ∞ÂΩïÁöÑÊâÄÊúâÂ≠óÊÆµ
                    if (detailsArray.length > 0) {
                        console.log('Á¨¨‰∏ÄÊù°ËÆ∞ÂΩïÁöÑÊâÄÊúâÂ≠óÊÆµ:', Object.keys(detailsArray[0]));
                        console.log('Á¨¨‰∏ÄÊù°ËÆ∞ÂΩïÁöÑÂÆåÊï¥Êï∞ÊçÆ:', detailsArray[0]);
                    }
                    
                    // ËÆ°ÁÆóÊÄªÈáëÈ¢ùÔºå‰ºòÂÖà‰ΩøÁî®ÂêéÁ´ØÁªüËÆ°Êï∞ÊçÆ
                    const totalAmount = detailsResponse.statistics?.totalAmount || 
                        detailsArray.reduce((sum, d) => sum + (d.subtotal || d.Subtotal || 0), 0);
                    
                    orderDetails = `
                        <div class="order-info-section">
                            <h4 style="color: #28a745; margin-bottom: 1rem;">
                                <i class="icon-order"></i> ÂΩìÂâçËÆ¢Âçï‰ø°ÊÅØ
                            </h4>
                            <div class="info-grid">
                                <p><strong>ËÆ¢ÂçïÂè∑:</strong> #${currentOrder.orderID}</p>
                                <p><strong>‰∏ãÂçïÊó∂Èó¥:</strong> ${Utils.formatDateTime(currentOrder.orderTime)}</p>
                                ${staffInfo}
                                <p><strong>ËÆ¢ÂçïÁä∂ÊÄÅ:</strong> <span class="status-badge ${getOrderStatusClass(currentOrder.orderStatus)}">${currentOrder.orderStatus}</span></p>
                                <p><strong>Â§áÊ≥®:</strong> ${currentOrder.notes || 'Êó†'}</p>
                            </div>
                        </div>
                        
                        <div class="dishes-section">
                            <h5 style="margin: 1.5rem 0 1rem 0;">
                                <i class="icon-dish"></i> ËèúÂìÅÂàóË°® (${detailsArray.length}È°π)
                            </h5>
                            ${detailsArray.length > 0 ? `
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>ËèúÂìÅÂêçÁß∞</th>
                                                <th>Êï∞Èáè</th>
                                                <th>Âçï‰ª∑</th>
                                                <th>Â∞èËÆ°</th>
                                                <th>ÁâπÊÆäË¶ÅÊ±Ç</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${detailsArray.map(d => `
                                                <tr>
                                                    <td><strong>${d.dishName || d.DishName || 'Êú™Áü•ËèúÂìÅ'}</strong></td>
                                                    <td class="text-center">${d.quantity || d.Quantity || 0}</td>
                                                    <td class="text-right">${Utils.formatCurrency(d.unitPrice || d.UnitPrice || 0)}</td>
                                                    <td class="text-right"><strong>${Utils.formatCurrency(d.subtotal || d.Subtotal || 0)}</strong></td>
                                                    <td class="text-muted">${d.specialRequests || d.SpecialRequests || '-'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                        <tfoot>
                                            <tr class="total-row">
                                                <td colspan="3"><strong>ÊÄªËÆ°</strong></td>
                                                <td class="text-right"><strong style="color: #28a745; font-size: 1.1em;">${Utils.formatCurrency(totalAmount)}</strong></td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            ` : `
                                <div class="empty-state">
                                    <p style="color: #6c757d; text-align: center; padding: 2rem;">
                                        <i class="icon-empty"></i><br>
                                        ÊöÇÊó†ÁÇπËèúËÆ∞ÂΩï
                                    </p>
                                </div>
                            `}
                        </div>
                        
                        <div class="action-buttons" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="addDish(${currentOrder.orderID})" class="btn btn-primary">
                                    <i class="icon-add"></i> Âä†Ëèú
                                </button>
                                <button onclick="printOrder(${currentOrder.orderID})" class="btn btn-secondary">
                                    <i class="icon-print"></i> ÊâìÂç∞
                                </button>
                                <button onclick="checkoutOrder(${currentOrder.orderID})" class="btn btn-success">
                                    <i class="icon-checkout"></i> ÁªìË¥¶ (${Utils.formatCurrency(totalAmount)})
                                </button>
                            </div>
                            <div style="margin-top: 1rem;">
                                <button onclick="Utils.hideModal('tableModal')" class="btn btn-light" style="width: 100%;">ÂÖ≥Èó≠</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Ê≤°ÊúâËÆ¢ÂçïÊó∂ÊòæÁ§∫ÂàõÂª∫ËÆ¢ÂçïÁïåÈù¢
                    orderDetails = `
                        <div class="no-order-section">
                            <div style="
                                text-align: center; 
                                padding: 3rem 2rem; 
                                background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); 
                                border: 2px dashed #28a745; 
                                border-radius: 16px; 
                                margin: 1rem 0;
                                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1);
                                transition: all 0.3s ease;
                            ">
                                <div style="
                                    font-size: 4rem; 
                                    margin-bottom: 1.5rem;
                                    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
                                ">üçΩÔ∏è</div>
                                <h4 style="
                                    color: #28a745; 
                                    margin-bottom: 1rem;
                                    font-size: 1.5rem;
                                    font-weight: 700;
                                ">ËØ•Ê°åÂè∞ÊöÇÊó†ËÆ¢Âçï</h4>
                                <p style="
                                    color: #6c757d; 
                                    margin-bottom: 2rem;
                                    font-size: 1.1rem;
                                    font-weight: 500;
                                ">ÂÆ¢‰∫∫Â∑≤ÂÖ•Â∫ßÔºåÂèØ‰ª•ÂºÄÂßãÁÇπÈ§ê‰∫Ü</p>
                                
                                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                    <button onclick="createNewOrder(${table.tableID})" class="btn btn-primary btn-lg" style="
                                        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                                        border: none;
                                        padding: 1rem 2rem;
                                        border-radius: 12px;
                                        font-size: 1.1rem;
                                        font-weight: 600;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                                        transition: all 0.3s ease;
                                    " 
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(40, 167, 69, 0.4)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.3)'">
                                        ‚ú® ÂàõÂª∫ËÆ¢Âçï
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                document.getElementById('modal-title').textContent = `Ê°åÂè∞${table.tableNumber}`;
                document.getElementById('modal-body').innerHTML = `
                    <div class="table-details-container">
                        ${orderDetails}
                    </div>
                `;

                Utils.showModal('tableModal');
            } catch (error) {
                console.error('Ëé∑ÂèñÊ°åÂè∞ËØ¶ÊÉÖÂ§±Ë¥•:', error);
                document.getElementById('modal-title').textContent = `Ê°åÂè∞${table.tableNumber} - ÈîôËØØ`;
                document.getElementById('modal-body').innerHTML = `
                    <div class="error-state" style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <h4 style="color: #dc3545;">Âä†ËΩΩÂ§±Ë¥•</h4>
                        <p style="color: #6c757d; margin: 1rem 0;">Êó†Ê≥ïËé∑ÂèñÊ°åÂè∞ËØ¶ÊÉÖ‰ø°ÊÅØ</p>
                        <div>
                            <button onclick="showTableDetails({tableID: ${table.tableID}, tableNumber: '${table.tableNumber}', capacity: ${table.capacity}, area: '${table.area}', status: '${table.status}'})" class="btn btn-primary">ÈáçËØï</button>
                            <button onclick="Utils.hideModal('tableModal')" class="btn btn-secondary">ÂÖ≥Èó≠</button>
                        </div>
                    </div>
                `;
                Utils.showNotification('Ëé∑ÂèñÊ°åÂè∞ËØ¶ÊÉÖÂ§±Ë¥•', 'error');
            }
        }

        // Ëé∑ÂèñËÆ¢ÂçïÁä∂ÊÄÅÂØπÂ∫îÁöÑCSSÁ±ª
        function getOrderStatusClass(status) {
            const statusMap = {
                'ÂæÖÂ§ÑÁêÜ': 'status-default',
                'Âà∂‰Ωú‰∏≠': 'status-active',
                'Â∑≤ÂÆåÊàê': 'status-success',
                'Â∑≤ÁªìË¥¶': 'status-finished'
            };
            return statusMap[status] || 'status-default';
        }

        // ÊâìÂç∞ËÆ¢Âçï
        function printOrder(orderId) {
            // TODO: ÂÆûÁé∞ÊâìÂç∞ÂäüËÉΩ
            Utils.showNotification('ÊâìÂç∞ÂäüËÉΩÂæÖÂÆûÁé∞', 'info');
        }

        function showTableCleaningOptions(table) {
            document.getElementById('modal-title').textContent = `Ê°åÂè∞${table.tableNumber} - Ê∏ÖÊ¥Å‰∏≠`;
            document.getElementById('modal-body').innerHTML = `
                <div class="table-details-container">
                    <div style="
                        text-align: center; 
                        padding: 3rem 2rem; 
                        background: linear-gradient(135deg, #fff3e0 0%, #fffef7 100%); 
                        border: 2px dashed #ff9800; 
                        border-radius: 16px; 
                        margin: 1rem 0;
                        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.1);
                    ">
                        <div style="
                            font-size: 4rem; 
                            margin-bottom: 1.5rem;
                            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
                        ">üßπ</div>
                        <h4 style="
                            color: #f57f17; 
                            margin-bottom: 1rem;
                            font-size: 1.5rem;
                            font-weight: 700;
                        ">Ê°åÂè∞${table.tableNumber} Ê∏ÖÊ¥Å‰∏≠</h4>
                        
                        <div style="
                            background: rgba(255,255,255,0.8);
                            padding: 1.5rem;
                            border-radius: 12px;
                            margin: 1.5rem 0;
                            border: 1px solid #e9ecef;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                        ">
                            <p style="margin: 0.5rem 0; color: #495057;"><strong>Ê°åÂè∞Âè∑:</strong> ${table.tableNumber}</p>
                            <p style="margin: 0.5rem 0; color: #495057;"><strong>ÂÆπÈáè:</strong> ${table.capacity}‰∫∫</p>
                            <p style="margin: 0.5rem 0; color: #495057;"><strong>Âå∫Âüü:</strong> ${table.area}</p>
                            <p style="margin: 0.5rem 0; color: #495057;"><strong>ÂΩìÂâçÁä∂ÊÄÅ:</strong> <span class="status-badge status-cleaning">Ê∏ÖÊ¥Å‰∏≠</span></p>
                        </div>
                        
                        <p style="
                            color: #6c757d; 
                            margin-bottom: 2rem;
                            font-size: 1.1rem;
                            font-weight: 500;
                        ">ËØ•Ê°åÂè∞Ê≠£Âú®Ê∏ÖÊ¥Å‰∏≠ÔºåÊ∏ÖÊ¥ÅÂÆåÊàêÂêéÂèØËÆæÁΩÆ‰∏∫Á©∫Èó≤Áä∂ÊÄÅ</p>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button onclick="finishCleaning(${table.tableID})" class="btn btn-success" style="
                                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                                border: none;
                                padding: 1rem 2rem;
                                border-radius: 12px;
                                font-size: 1.1rem;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                                transition: all 0.3s ease;
                                color: white;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(40, 167, 69, 0.4)'"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.3)'">
                                ‚ú® ÂÆåÊàêÊ∏ÖÊ¥Å
                            </button>
                            
                            <button onclick="Utils.hideModal('tableModal')" class="btn btn-secondary" style="
                                background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                                border: none;
                                padding: 1rem 1.5rem;
                                border-radius: 12px;
                                font-size: 1.1rem;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
                                transition: all 0.3s ease;
                                color: white;
                            " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(108, 117, 125, 0.4)'"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(108, 117, 125, 0.3)'">
                                ÂÖ≥Èó≠
                            </button>
                        </div>
                    </div>
                </div>
            `;
            Utils.showModal('tableModal');
        }

        async function handleOpenTable() {
            if (!Utils.validateForm(document.getElementById('openTableForm'))) {
                Utils.showNotification('ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØ', 'warning');
                return;
            }

            try {
                const staffId = document.getElementById('staffSelect').value;
                const notes = document.getElementById('orderNotes').value;

                console.log(`ÂºÄÂè∞ÔºöÂáÜÂ§áÂºÄÂêØÊ°åÂè∞ ${currentTableId}`);
                console.log('ÂºÄÂè∞URL:', `/api/tables/${currentTableId}/open`);
                console.log('ÂºÄÂè∞ÂèÇÊï∞:', { staffId, notes });

                // ‰ΩøÁî®‰∏ìÈó®ÁöÑÂºÄÂè∞API
                const openTableResult = await API.post(`/tables/${currentTableId}/open`, { 
                    staffId: staffId,
                    notes: notes 
                });
                console.log('ÂºÄÂè∞APIËøîÂõûÁªìÊûú:', openTableResult);

                Utils.showNotification('ÂºÄÂè∞ÊàêÂäü', 'success');
                Utils.hideModal('openTableModal');
                Utils.resetForm(document.getElementById('openTableForm'));
                
                // Âà∑Êñ∞Ê°åÂè∞Áä∂ÊÄÅ
                await loadTables();

            } catch (error) {
                console.error('ÂºÄÂè∞Â§±Ë¥•:', error);
                console.error('ÂºÄÂè∞ÈîôËØØËØ¶ÊÉÖ:', error.response || error.message);
                console.error('ÂºÄÂè∞ÈîôËØØÁä∂ÊÄÅÁ†Å:', error.status);
                console.error('ÂºÄÂè∞ÂÆåÊï¥ÈîôËØØÂØπË±°:', error);
                Utils.showNotification('ÂºÄÂè∞Â§±Ë¥•', 'error');
            }
        }

        let currentCheckoutOrderId = null;

        async function checkoutOrder(orderId) {
            try {
                // ÂÖàËé∑ÂèñËÆ¢Âçï‰ø°ÊÅØÁî®‰∫éÊòæÁ§∫
                const order = await API.get(`/orders/${orderId}`);
                if (!order) {
                    Utils.showNotification('ËÆ¢Âçï‰∏çÂ≠òÂú®', 'error');
                    return;
                }

                // Ëé∑ÂèñËÆ¢ÂçïËØ¶ÊÉÖËÆ°ÁÆóÊÄªÈáëÈ¢ù
                const detailsResponse = await API.get(`/orders/${orderId}/details`).catch(() => ({ details: [] }));
                const detailsArray = Array.isArray(detailsResponse.details) ? detailsResponse.details : 
                                   Array.isArray(detailsResponse) ? detailsResponse : [];
                const totalAmount = detailsResponse.statistics?.totalAmount || 
                    detailsArray.reduce((sum, d) => sum + (d.Subtotal || 0), 0);

                // ËÆæÁΩÆÂΩìÂâçË¶ÅÁªìË¥¶ÁöÑËÆ¢ÂçïID
                currentCheckoutOrderId = orderId;

                // Â°´ÂÖÖÁ°ÆËÆ§‰ø°ÊÅØ
                document.getElementById('checkout-order-info').innerHTML = `
                    <strong>ËÆ¢ÂçïÂè∑:</strong> #${orderId}<br>
                    <strong>ÊÄªÈáëÈ¢ù:</strong> <span style="color: #28a745; font-size: 1.2em;">${Utils.formatCurrency(totalAmount)}</span>
                `;

                // ÊòæÁ§∫Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü
                Utils.showModal('checkoutConfirmModal');

            } catch (error) {
                console.error('Ëé∑ÂèñËÆ¢Âçï‰ø°ÊÅØÂ§±Ë¥•:', error);
                Utils.showNotification('Ëé∑ÂèñËÆ¢Âçï‰ø°ÊÅØÂ§±Ë¥•', 'error');
            }
        }

        async function confirmCheckout() {
            if (!currentCheckoutOrderId) {
                Utils.showNotification('ËÆ¢Âçï‰ø°ÊÅØÂºÇÂ∏∏', 'error');
                return;
            }

            try {
                Utils.showNotification('Ê≠£Âú®Â§ÑÁêÜÁªìË¥¶...', 'info');
                
                // ÈöêËóèÁ°ÆËÆ§Ê®°ÊÄÅÊ°Ü
                Utils.hideModal('checkoutConfirmModal');

                // ÂÖàËé∑ÂèñËÆ¢Âçï‰ø°ÊÅØ
                const order = await API.get(`/orders/${currentCheckoutOrderId}`);
                if (!order) {
                    throw new Error('ËÆ¢Âçï‰∏çÂ≠òÂú®');
                }

                console.log('ÁªìË¥¶ÂâçËÆ¢ÂçïÁä∂ÊÄÅ:', order.orderStatus);

                // ÊâßË°åÁªìË¥¶Êìç‰Ωú
                const checkoutResult = await API.put(`/orders/${currentCheckoutOrderId}/checkout`);
                console.log('ÁªìË¥¶APIËøîÂõûÁªìÊûú:', checkoutResult);

                // È™åËØÅËÆ¢ÂçïÁä∂ÊÄÅÊòØÂê¶Â∑≤Êõ¥Êñ∞‰∏∫"Â∑≤ÁªìË¥¶"
                const updatedOrder = await API.get(`/orders/${currentCheckoutOrderId}`);
                console.log('ÁªìË¥¶ÂêéËÆ¢ÂçïÁä∂ÊÄÅ:', updatedOrder?.orderStatus);

                if (updatedOrder && updatedOrder.orderStatus !== 'Â∑≤ÁªìË¥¶') {
                    console.warn(`ËÆ¢ÂçïÁä∂ÊÄÅÊõ¥Êñ∞ÂºÇÂ∏∏: ÊúüÊúõ"Â∑≤ÁªìË¥¶"ÔºåÂÆûÈôÖ"${updatedOrder.orderStatus}"`);
                    // ÊâãÂä®Êõ¥Êñ∞ËÆ¢ÂçïÁä∂ÊÄÅÔºàÂ§áÁî®ÊñπÊ°àÔºâ
                    try {
                        await API.put(`/orders/${currentCheckoutOrderId}/status`, { status: 'Â∑≤ÁªìË¥¶' });
                        console.log('ÊâãÂä®Êõ¥Êñ∞ËÆ¢ÂçïÁä∂ÊÄÅ‰∏∫"Â∑≤ÁªìË¥¶"');
                    } catch (statusUpdateError) {
                        console.error('ÊâãÂä®Êõ¥Êñ∞ËÆ¢ÂçïÁä∂ÊÄÅÂ§±Ë¥•:', statusUpdateError);
                    }
                }
                
                // ËÆæÁΩÆÊ°åÂè∞‰∏∫Ê∏ÖÊ¥Å‰∏≠Áä∂ÊÄÅ
                if (order.tableID) {
                    try {
                        console.log(`ÂáÜÂ§áÂ∞ÜÊ°åÂè∞ ${order.tableID} Áä∂ÊÄÅÊõ¥Êñ∞‰∏∫Ê∏ÖÊ¥Å‰∏≠`);
                        console.log('Ê°åÂè∞Áä∂ÊÄÅÊõ¥Êñ∞URL:', `/api/tables/${order.tableID}/status`);
                        console.log('Ê°åÂè∞Áä∂ÊÄÅÊõ¥Êñ∞ÂèÇÊï∞:', { status: "Ê∏ÖÊ¥Å‰∏≠" });
                        
                        const tableUpdateResult = await API.put(`/tables/${order.tableID}/status`, { Status: "Ê∏ÖÊ¥Å‰∏≠" });
                        console.log('Ê°åÂè∞Áä∂ÊÄÅÊõ¥Êñ∞APIËøîÂõûÁªìÊûú:', tableUpdateResult);
                        console.log('Ê°åÂè∞Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞‰∏∫Ê∏ÖÊ¥Å‰∏≠');
                    } catch (tableError) {
                        console.error('Êõ¥Êñ∞Ê°åÂè∞Áä∂ÊÄÅÂ§±Ë¥•:', tableError);
                        console.error('ÈîôËØØËØ¶ÊÉÖ:', tableError.response || tableError.message);
                        console.error('ÈîôËØØÁä∂ÊÄÅÁ†Å:', tableError.status);
                        console.error('ÂÆåÊï¥ÈîôËØØÂØπË±°:', tableError);
                        Utils.showNotification(`Ê°åÂè∞Áä∂ÊÄÅÊõ¥Êñ∞Â§±Ë¥•: ${tableError.message || 'Êú™Áü•ÈîôËØØ'}`, 'warning');
                        // ‰∏çÂΩ±ÂìçÁªìË¥¶ÊµÅÁ®ãÔºåÁªßÁª≠ÊâßË°å
                    }
                } else {
                    console.warn('ËÆ¢ÂçïÊ≤°ÊúâÂÖ≥ËÅîÁöÑÊ°åÂè∞IDÔºåÊó†Ê≥ïÊõ¥Êñ∞Ê°åÂè∞Áä∂ÊÄÅ');
                }

                Utils.showNotification(`ËÆ¢Âçï #${currentCheckoutOrderId} ÁªìË¥¶ÊàêÂäüÔºÅ`, 'success');
                Utils.hideModal('tableModal');
                
                // ÈáçÁΩÆÂΩìÂâçÁªìË¥¶ËÆ¢ÂçïID
                currentCheckoutOrderId = null;
                
                // Âà∑Êñ∞Ê°åÂè∞Áä∂ÊÄÅ
                await loadTables();

            } catch (error) {
                console.error('ÁªìË¥¶Â§±Ë¥•:', error);
                let errorMessage = 'ÁªìË¥¶Â§±Ë¥•';
                
                if (error.response) {
                    console.error('APIÈîôËØØËØ¶ÊÉÖ:', error.response);
                    if (error.response.status === 404) {
                        errorMessage = 'ËÆ¢Âçï‰∏çÂ≠òÂú®ÊàñÂ∑≤Ë¢´Âà†Èô§';
                    } else if (error.response.status === 400) {
                        errorMessage = 'ËÆ¢ÂçïÁä∂ÊÄÅÂºÇÂ∏∏ÔºåÊó†Ê≥ïÁªìË¥¶';
                    } else {
                        errorMessage = `ÁªìË¥¶Â§±Ë¥• (ÈîôËØØÁ†Å: ${error.response.status})`;
                    }
                } else if (error.message) {
                    errorMessage = `ÁªìË¥¶Â§±Ë¥•: ${error.message}`;
                }
                
                Utils.showNotification(errorMessage, 'error');
                
                // ÈáçÁΩÆÂΩìÂâçÁªìË¥¶ËÆ¢ÂçïID
                currentCheckoutOrderId = null;
            }
        }

        async function finishCleaning(tableId) {
            try {
                Utils.showNotification('Ê≠£Âú®ÂÆåÊàêÊ∏ÖÊ¥Å...', 'info');
                
                await API.put(`/tables/${tableId}/status`, { Status: "Á©∫Èó≤" });
                
                Utils.showNotification('Ê∏ÖÊ¥ÅÂÆåÊàêÔºåÊ°åÂè∞Â∑≤ËÆæ‰∏∫Á©∫Èó≤', 'success');
                Utils.hideModal('tableModal');
                
                // Âà∑Êñ∞Ê°åÂè∞Áä∂ÊÄÅ
                await loadTables();

            } catch (error) {
                console.error('Êìç‰ΩúÂ§±Ë¥•:', error);
                Utils.showNotification('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            }
        }

        function addDish(orderId) {
            currentAddDishOrderId = orderId;
            selectedDishes.clear();
            showAddDishModal(orderId);
        }

        async function showAddDishModal(orderId) {
            try {
                // Ëé∑ÂèñËÆ¢Âçï‰ø°ÊÅØ
                const order = await API.get(`/orders/${orderId}`);
                if (!order) {
                    Utils.showNotification('ËÆ¢Âçï‰∏çÂ≠òÂú®', 'error');
                    return;
                }

                // Ëé∑ÂèñÊ°åÂè∞‰ø°ÊÅØ
                const table = tables.find(t => t.tableID === order.tableID);
                const tableNumber = table ? table.tableNumber : order.tableID;

                // ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÊ†áÈ¢òÂíåËÆ¢ÂçïÊëòË¶Å
                document.getElementById('addDishModalTitle').textContent = `Âä†Ëèú - Ê°åÂè∞${tableNumber}`;
                document.getElementById('orderSummary').innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h5 style="margin: 0; color: #28a745;">ËÆ¢Âçï #${orderId}</h5>
                            <p style="margin: 0.25rem 0 0 0; color: #6c757d;">Ê°åÂè∞${tableNumber} | ${Utils.formatDateTime(order.orderTime)}</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #6c757d; font-size: 0.9rem;">ÂΩìÂâçÁä∂ÊÄÅ</div>
                            <span class="status-badge ${getOrderStatusClass(order.orderStatus)}">${order.orderStatus}</span>
                        </div>
                    </div>
                `;

                // Ê∏≤ÊüìËèúÂìÅÁΩëÊ†º
                renderDishesGrid();
                updateSelectedDishesDisplay();

                Utils.showModal('addDishModal');

            } catch (error) {
                console.error('Âä†ËΩΩÂä†ËèúÊ®°ÊÄÅÊ°ÜÂ§±Ë¥•:', error);
                Utils.showNotification('Âä†ËΩΩËèúÂìÅ‰ø°ÊÅØÂ§±Ë¥•', 'error');
            }
        }

        async function loadDishesForAddDish() {
            try {
                console.log('ÂºÄÂßãÂä†ËΩΩËèúÂìÅÊï∞ÊçÆ...');
                
                // Âä†ËΩΩËèúÂìÅÊï∞ÊçÆ
                availableDishes = await API.get('/menu/dishes');
                console.log('ÂéüÂßãËèúÂìÅÊï∞ÊçÆ:', availableDishes);
                
                if (availableDishes && availableDishes.length > 0) {
                    console.log('Á¨¨‰∏Ä‰∏™ËèúÂìÅÊï∞ÊçÆÁ§∫‰æã:', availableDishes[0]);
                }
                
                // ËøáÊª§ÂèØÁî®ËèúÂìÅ
                const originalCount = availableDishes?.length || 0;
                availableDishes = availableDishes?.filter(dish => {
                    // Â§ÑÁêÜÂ§ßÂ∞èÂÜôÂ≠óÊÆµÂêçÈóÆÈ¢ò
                    const isAvailable = dish.isAvailable === true || dish.ISAVAILABLE === 'Y';
                    return isAvailable;
                }) || [];
                console.log(`ËèúÂìÅËøáÊª§ÁªìÊûú: ÂéüÂßã${originalCount}‰∏™ÔºåÂèØÁî®${availableDishes.length}‰∏™`);

                // Âä†ËΩΩËèúÂìÅÂàÜÁ±ª
                console.log('ÂºÄÂßãÂä†ËΩΩËèúÂìÅÂàÜÁ±ª...');
                try {
                    const categories = await API.get('/menu/categories');
                    console.log('ÂàÜÁ±ªÊï∞ÊçÆ:', categories);
                    dishCategories = categories || [];

                    // Â°´ÂÖÖÂàÜÁ±ª‰∏ãÊãâÊ°Ü
                    const categorySelect = document.getElementById('dishCategoryFilter');
                    if (categorySelect) {
                        categorySelect.innerHTML = '<option value="">ÂÖ®ÈÉ®ÂàÜÁ±ª</option>';
                        dishCategories.forEach(category => {
                            const option = document.createElement('option');
                            const categoryID = category.categoryID || category.CATEGORYID;
                            const categoryName = category.categoryName || category.CATEGORYNAME;
                            option.value = categoryID;
                            option.textContent = categoryName;
                            categorySelect.appendChild(option);
                        });
                        console.log(`ÂàÜÁ±ª‰∏ãÊãâÊ°ÜÂ∑≤Â°´ÂÖÖÔºåÂÖ±${dishCategories.length}‰∏™ÂàÜÁ±ª`);
                    }
                } catch (categoryError) {
                    console.warn('Âä†ËΩΩÂàÜÁ±ªÂ§±Ë¥•Ôºå‰ΩÜËèúÂìÅÂäüËÉΩ‰ªçÂèØ‰ΩøÁî®:', categoryError);
                    dishCategories = [];
                }

                console.log('ËèúÂìÅÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê');

            } catch (error) {
                console.error('Âä†ËΩΩËèúÂìÅÊï∞ÊçÆÂ§±Ë¥•:', error);
                availableDishes = [];
                dishCategories = [];
                Utils.showNotification('Âä†ËΩΩËèúÂìÅÊï∞ÊçÆÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò', 'error');
            }
        }

        function renderDishesGrid() {
            const dishesGrid = document.getElementById('dishesGrid');
            const categoryFilter = document.getElementById('dishCategoryFilter').value;
            const searchQuery = document.getElementById('dishSearchInput').value.toLowerCase().trim();

            console.log('Ê∏≤ÊüìËèúÂìÅÁΩëÊ†º...');
            console.log('ÂèØÁî®ËèúÂìÅÊï∞Èáè:', availableDishes.length);
            console.log('ÂàÜÁ±ªËøáÊª§Âô®:', categoryFilter);
            console.log('ÊêúÁ¥¢Êü•ËØ¢:', searchQuery);

            // ËøáÊª§ËèúÂìÅ
            let filteredDishes = availableDishes;

            if (categoryFilter) {
                const beforeFilter = filteredDishes.length;
                filteredDishes = filteredDishes.filter(dish => {
                    const categoryID = dish.categoryID || dish.CATEGORYID;
                    return categoryID == categoryFilter;
                });
                console.log(`ÊåâÂàÜÁ±ªËøáÊª§: ${beforeFilter} -> ${filteredDishes.length}`);
            }

            if (searchQuery) {
                const beforeFilter = filteredDishes.length;
                filteredDishes = filteredDishes.filter(dish => {
                    const dishName = dish.dishName || dish.DISHNAME || '';
                    const description = dish.description || dish.DESCRIPTION || '';
                    return dishName.toLowerCase().includes(searchQuery) ||
                           description.toLowerCase().includes(searchQuery);
                });
                console.log(`ÊåâÊêúÁ¥¢ËøáÊª§: ${beforeFilter} -> ${filteredDishes.length}`);
            }

            console.log('ÊúÄÁªàËøáÊª§ÂêéËèúÂìÅÊï∞Èáè:', filteredDishes.length);

            if (filteredDishes.length === 0) {
                console.log('Ê≤°ÊúâÊâæÂà∞Á¨¶ÂêàÊù°‰ª∂ÁöÑËèúÂìÅÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ');
                dishesGrid.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6c757d;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üîç</div>
                        <p>Ê≤°ÊúâÊâæÂà∞Á¨¶ÂêàÊù°‰ª∂ÁöÑËèúÂìÅ</p>
                        <p style="font-size: 0.9rem; margin-top: 1rem;">
                            ÊÄªËèúÂìÅÊï∞: ${availableDishes.length} | 
                            ÂàÜÁ±ªËøáÊª§: ${categoryFilter || 'Êó†'} | 
                            ÊêúÁ¥¢ÂÖ≥ÈîÆËØç: ${searchQuery || 'Êó†'}
                        </p>
                    </div>
                `;
                return;
            }

            console.log('ÂºÄÂßãÊ∏≤ÊüìËèúÂìÅÁΩëÊ†ºÔºåËèúÂìÅÊï∞Èáè:', filteredDishes.length);
            
            dishesGrid.innerHTML = `
                <div class="dish-grid">
                    ${filteredDishes.map(dish => {
                        const dishID = dish.dishID || dish.DISHID;
                        const dishName = dish.dishName || dish.DISHNAME || 'Êú™Áü•ËèúÂìÅ';
                        const description = dish.description || dish.DESCRIPTION || 'ÊöÇÊó†ÊèèËø∞';
                        const price = dish.price || dish.PRICE || 0;
                        
                        const isSelected = selectedDishes.has(dishID);
                        const selectedData = selectedDishes.get(dishID);
                        const quantity = selectedData ? selectedData.quantity : 0;
                        
                        return `
                            <div class="dish-item ${isSelected ? 'selected' : ''}" id="dish-${dishID}">
                                <div class="dish-name">${dishName}</div>
                                <div class="dish-description">${description}</div>
                                <div class="dish-price">¬•${price.toFixed(2)}</div>
                                <div class="dish-controls">
                                    <div class="quantity-controls">
                                        <button class="quantity-btn" onclick="updateDishQuantity(${dishID}, ${quantity - 1})" ${quantity === 0 ? 'disabled' : ''}>-</button>
                                        <input type="number" class="quantity-input" value="${quantity}" min="0" max="99" 
                                               onchange="updateDishQuantity(${dishID}, parseInt(this.value) || 0)"
                                               id="quantity-${dishID}">
                                        <button class="quantity-btn" onclick="updateDishQuantity(${dishID}, ${quantity + 1})">+</button>
                                    </div>
                                    ${isSelected ? `<span style="color: #28a745; font-weight: 600;">Â∑≤ÈÄâ</span>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            console.log('ËèúÂìÅÁΩëÊ†ºÊ∏≤ÊüìÂÆåÊàê');
        }

        function filterDishes() {
            renderDishesGrid();
        }

        function updateDishQuantity(dishId, newQuantity) {
            newQuantity = Math.max(0, Math.min(99, newQuantity)); // ÈôêÂà∂Êï∞ÈáèËåÉÂõ¥

            const dish = availableDishes.find(d => (d.dishID || d.DISHID) === dishId);
            if (!dish) return;

            if (newQuantity === 0) {
                // ÁßªÈô§ËèúÂìÅ
                selectedDishes.delete(dishId);
            } else {
                // Ê∑ªÂä†ÊàñÊõ¥Êñ∞ËèúÂìÅÔºåÊ†áÂáÜÂåñÂ≠óÊÆµÂêç
                const standardizedDish = {
                    dishID: dish.dishID || dish.DISHID,
                    dishName: dish.dishName || dish.DISHNAME,
                    price: dish.price || dish.PRICE,
                    description: dish.description || dish.DESCRIPTION,
                    categoryID: dish.categoryID || dish.CATEGORYID
                };
                
                selectedDishes.set(dishId, {
                    dish: standardizedDish,
                    quantity: newQuantity,
                    specialRequests: ''
                });
            }

            // Êõ¥Êñ∞ÊòæÁ§∫
            renderDishesGrid();
            updateSelectedDishesDisplay();
        }

        function updateSelectedDishesDisplay() {
            const selectedSection = document.getElementById('selectedDishesSection');
            const selectedList = document.getElementById('selectedDishesList');
            const totalElement = document.getElementById('addDishTotal');
            const confirmBtn = document.getElementById('confirmAddDishBtn');

            if (selectedDishes.size === 0) {
                selectedSection.style.display = 'none';
                confirmBtn.disabled = true;
                return;
            }

            selectedSection.style.display = 'block';
            confirmBtn.disabled = false;

            let totalAmount = 0;
            let selectedHTML = '';

            selectedDishes.forEach((data, dishId) => {
                const { dish, quantity, specialRequests } = data;
                const subtotal = dish.price * quantity;
                totalAmount += subtotal;

                selectedHTML += `
                    <div class="selected-dish-item">
                        <div class="selected-dish-info">
                            <div class="selected-dish-name">${dish.dishName}</div>
                            <div class="selected-dish-details">
                                Êï∞Èáè: ${quantity} | Âçï‰ª∑: ¬•${dish.price.toFixed(2)}
                                ${specialRequests ? ` | Â§áÊ≥®: ${specialRequests}` : ''}
                            </div>
                        </div>
                        <div class="selected-dish-total">¬•${subtotal.toFixed(2)}</div>
                        <button class="remove-dish-btn" onclick="removeDishFromSelection(${dishId})" title="ÁßªÈô§">√ó</button>
                    </div>
                `;
            });

            selectedList.innerHTML = selectedHTML;
            totalElement.textContent = `¬•${totalAmount.toFixed(2)}`;
        }

        function removeDishFromSelection(dishId) {
            selectedDishes.delete(dishId);
            renderDishesGrid();
            updateSelectedDishesDisplay();
        }

        async function confirmAddSelectedDishes() {
            if (selectedDishes.size === 0) {
                Utils.showNotification('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂä†ÁöÑËèúÂìÅ', 'warning');
                return;
            }

            if (!currentAddDishOrderId) {
                Utils.showNotification('ËÆ¢Âçï‰ø°ÊÅØÂºÇÂ∏∏ÔºåËØ∑ÈáçËØï', 'error');
                return;
            }

            try {
                Utils.showNotification('Ê≠£Âú®Ê∑ªÂä†ËèúÂìÅ...', 'info');

                // ÂáÜÂ§áË¶ÅÊ∑ªÂä†ÁöÑËèúÂìÅÊï∞ÊçÆÔºå‰ΩøÁî®ÂêéÁ´ØÊúüÊúõÁöÑÂ≠óÊÆµÂêç
                const dishesToAdd = [];
                selectedDishes.forEach((data, dishId) => {
                    const { dish, quantity, specialRequests } = data;
                    dishesToAdd.push({
                        DishID: dish.dishID,        // ‰ΩøÁî®Â§ßÂÜôD
                        Quantity: quantity,         // ‰ΩøÁî®Â§ßÂÜôQ
                        UnitPrice: dish.price,      // ‰ΩøÁî®Â§ßÂÜôU
                        SpecialRequests: specialRequests || null  // ‰ΩøÁî®Â§ßÂÜôS
                    });
                });

                console.log('ÂáÜÂ§áÊ∑ªÂä†ÁöÑËèúÂìÅÊï∞ÊçÆ:', dishesToAdd);
                console.log('ËÆ¢ÂçïID:', currentAddDishOrderId);

                // ÊâπÈáèÊ∑ªÂä†ËèúÂìÅÂà∞ËÆ¢Âçï
                for (let i = 0; i < dishesToAdd.length; i++) {
                    const dishData = dishesToAdd[i];
                    console.log(`Ê≠£Âú®Ê∑ªÂä†Á¨¨${i + 1}ÈÅìËèúÂìÅ:`, dishData);
                    
                    try {
                        const response = await API.post(`/orders/${currentAddDishOrderId}/details`, dishData);
                        console.log(`Á¨¨${i + 1}ÈÅìËèúÂìÅÊ∑ªÂä†ÊàêÂäü:`, response);
                    } catch (dishError) {
                        console.error(`Á¨¨${i + 1}ÈÅìËèúÂìÅÊ∑ªÂä†Â§±Ë¥•:`, dishError);
                        throw new Error(`Ê∑ªÂä† ${dishData.DishID} Âè∑ËèúÂìÅÂ§±Ë¥•: ${dishError.message}`);
                    }
                }

                const totalItems = dishesToAdd.reduce((sum, d) => sum + d.Quantity, 0);
                Utils.showNotification(`ÊàêÂäüÊ∑ªÂä† ${totalItems} ÈÅìËèúÂìÅÔºÅ`, 'success');

                // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                Utils.hideModal('addDishModal');

                // Â¶ÇÊûúÊ°åÂè∞ËØ¶ÊÉÖÊ®°ÊÄÅÊ°ÜËøòÂºÄÁùÄÔºåÈúÄË¶ÅÂà∑Êñ∞ÂÜÖÂÆπ
                const tableModal = document.getElementById('tableModal');
                if (tableModal.style.display === 'block') {
                    // ÈáçÊñ∞ÊòæÁ§∫Ê°åÂè∞ËØ¶ÊÉÖ
                    const table = tables.find(t => t.tableID === currentTableId);
                    if (table) {
                        await showTableDetails(table);
                    }
                }

                // Ê∏ÖÁ©∫ÈÄâÊã©
                selectedDishes.clear();
                currentAddDishOrderId = null;

            } catch (error) {
                console.error('Ê∑ªÂä†ËèúÂìÅÂ§±Ë¥•:', error);
                let errorMessage = 'Ê∑ªÂä†ËèúÂìÅÂ§±Ë¥•';
                
                if (error.response) {
                    console.error('APIÈîôËØØÂìçÂ∫î:', error.response);
                    if (error.response.status === 404) {
                        errorMessage = 'ËÆ¢Âçï‰∏çÂ≠òÂú®ÊàñÂ∑≤ÁªìË¥¶';
                    } else if (error.response.status === 400) {
                        errorMessage = 'ËèúÂìÅ‰ø°ÊÅØÊúâËØØÔºåËØ∑ÈáçËØï';
                    } else if (error.response.status === 500) {
                        errorMessage = 'ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò';
                    } else {
                        errorMessage = `Ê∑ªÂä†Â§±Ë¥• (ÈîôËØØÁ†Å: ${error.response.status})`;
                    }
                } else if (error.message) {
                    errorMessage = `Ê∑ªÂä†Â§±Ë¥•: ${error.message}`;
                }
                
                Utils.showNotification(errorMessage, 'error');
            }
        }

        async function createNewOrder(tableId) {
            try {
                // ÊòæÁ§∫ÂàõÂª∫‰∏≠Áä∂ÊÄÅ
                Utils.showNotification('Ê≠£Âú®ÂàõÂª∫ËÆ¢Âçï...', 'info');

                // Ëé∑ÂèñÂëòÂ∑•ÂàóË°®Áî®‰∫éÂàõÂª∫ËÆ¢Âçï
                if (staff.length === 0) {
                    await loadStaff();
                }

                // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑‰ø°ÊÅØÊàñ‰ΩøÁî®ÈªòËÆ§ÂëòÂ∑•
                const currentUser = Auth.getCurrentUser();
                let selectedStaffId = null;

                if (currentUser && currentUser.staffID) {
                    selectedStaffId = currentUser.staffID;
                } else {
                    const availableStaff = staff.find(s => s.status === 'Âú®ËÅå');
                    if (availableStaff) {
                        selectedStaffId = availableStaff.staffID;
                    }
                }

                if (!selectedStaffId) {
                    Utils.showNotification('Ê≤°ÊúâÂèØÁî®ÁöÑÊúçÂä°ÂëòÔºåËØ∑ÂÖàÊ∑ªÂä†ÂëòÂ∑•', 'warning');
                    return;
                }

                // ÂàõÂª∫ËÆ¢ÂçïÊï∞ÊçÆ
                const orderData = {
                    tableID: tableId,
                    customerID: null, // Áé∞Âú∫ÂÆ¢Êà∑ÔºåÊó†ÈúÄÂÆ¢Êà∑ID
                    staffID: selectedStaffId,
                    orderTime: new Date().toISOString(),
                    totalAmount: 0, // ÂàùÂßãÈáëÈ¢ù‰∏∫0ÔºåÂêéÁª≠ÈÄöËøáÁÇπËèúÂ¢ûÂä†
                    orderStatus: 'ÂæÖÂ§ÑÁêÜ', // Ê†πÊçÆË°®ËÆæËÆ°ÊñáÊ°£ÔºåÊñ∞ËÆ¢ÂçïÁä∂ÊÄÅ‰∏∫"ÂæÖÂ§ÑÁêÜ"
                    notes: `Ê°åÂè∞${tables.find(t => t.tableID === tableId)?.tableNumber || tableId}ÂºÄÂè∞`
                };

                console.log('ÂàõÂª∫ËÆ¢ÂçïÊï∞ÊçÆ:', orderData);

                // Ë∞ÉÁî®APIÂàõÂª∫ËÆ¢Âçï
                const result = await API.post('/orders', orderData);
                
                if (result && (result.orderID || result.id)) {
                    const orderId = result.orderID || result.id;
                    Utils.showNotification(`ËÆ¢ÂçïÂàõÂª∫ÊàêÂäüÔºÅËÆ¢ÂçïÂè∑: #${orderId}`, 'success');
                    
                    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                    Utils.hideModal('tableModal');
                    
                    // Âà∑Êñ∞Ê°åÂè∞Áä∂ÊÄÅ‰ª•Êõ¥Êñ∞ËÆ¢Âçï‰ø°ÊÅØ
                    await loadTables();
                    
                    // ÂèØÈÄâÔºöËá™Âä®Ë∑≥ËΩ¨Âà∞ÁÇπËèúÈ°µÈù¢
                    // window.location.href = `menu.html?orderId=${orderId}&tableId=${tableId}`;
                } else {
                    throw new Error('ÂàõÂª∫ËÆ¢ÂçïËøîÂõûÊï∞ÊçÆÊ†ºÂºèÂºÇÂ∏∏');
                }

            } catch (error) {
                console.error('ÂàõÂª∫ËÆ¢ÂçïÂ§±Ë¥•:', error);
                let errorMessage = 'ÂàõÂª∫ËÆ¢ÂçïÂ§±Ë¥•';
                
                if (error.response) {
                    // APIËøîÂõûÁöÑÈîôËØØ
                    if (error.response.status === 400) {
                        errorMessage = 'ËÆ¢ÂçïÊï∞ÊçÆÊ†ºÂºèÈîôËØØÔºåËØ∑Ê£ÄÊü•ËæìÂÖ•';
                    } else if (error.response.status === 500) {
                        errorMessage = 'ÊúçÂä°Âô®ÂÜÖÈÉ®ÈîôËØØÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò';
                    } else {
                        errorMessage = `ÂàõÂª∫ËÆ¢ÂçïÂ§±Ë¥• (ÈîôËØØÁ†Å: ${error.response.status})`;
                    }
                } else if (error.message) {
                    errorMessage = `ÂàõÂª∫ËÆ¢ÂçïÂ§±Ë¥•: ${error.message}`;
                }
                
                Utils.showNotification(errorMessage, 'error');
            }
        }

        async function refreshTables() {
            Utils.showNotification('Ê≠£Âú®Âà∑Êñ∞...', 'info');
            await loadTables();
            Utils.showNotification('Âà∑Êñ∞ÂÆåÊàê', 'success');
        }
    </script>
</body>
</html>
