<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡Œå°ç®¡ç† - é¤é¥®ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* æ¡Œå°è¯¦æƒ…æ ·å¼å¢å¼º */
        .table-details-container {
            max-height: 70vh;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .table-basic-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid #e1f5fe;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            transition: background-color 0.2s ease;
        }
        
        .info-row:hover {
            background-color: rgba(0,0,0,0.02);
            border-radius: 6px;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .info-label::before {
            content: "â€¢";
            color: #007bff;
            font-size: 1.2rem;
        }
        
        .info-value {
            color: #212529;
            font-weight: 500;
        }
        
        .order-info-section {
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #f1f8e9 0%, #f8fff8 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);
        }
        
        .order-info-section h4 {
            color: #28a745;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
        }
        
        .order-info-section h4::before {
            content: "ğŸ“‹";
            font-size: 1.3rem;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .info-grid p {
            margin: 0.5rem 0;
            padding: 0.75rem;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.06);
            transition: all 0.2s ease;
        }
        
        .info-grid p:hover {
            background: rgba(255,255,255,0.9);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .dishes-section {
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #fff3e0 0%, #fffef7 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #ff9800;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
        }
        
        .dishes-section h5 {
            color: #f57f17;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }
        
        .dishes-section h5::before {
            content: "ğŸ½ï¸";
            font-size: 1.2rem;
        }
        
        .table-responsive {
            max-height: 350px;
            overflow-y: auto;
            border: none;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .table-responsive table {
            margin-bottom: 0;
        }
        
        .table-responsive thead th {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            font-weight: 600;
            border: none;
            padding: 1rem 0.75rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .table-responsive tbody tr {
            transition: background-color 0.2s ease;
        }
        
        .table-responsive tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .table-responsive tbody td {
            padding: 0.875rem 0.75rem;
            border-top: 1px solid #e9ecef;
            vertical-align: middle;
        }
        
        .total-row {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%) !important;
            font-weight: bold;
            color: #155724;
        }
        
        .total-row td {
            border-top: 2px solid #28a745 !important;
            padding: 1rem 0.75rem !important;
        }
        
        .empty-state {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
        }
        
        .empty-state::before {
            content: "ğŸ½ï¸";
            font-size: 3rem;
            display: block;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .no-order-section {
            margin: 1.5rem 0;
        }
        
        .action-buttons {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border-top: 1px solid #e9ecef;
            margin-top: 1.5rem;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
        }
        
        .action-buttons .btn {
            margin: 0.25rem;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .action-buttons .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .action-buttons .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
        }
        
        .action-buttons .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border: none;
        }
        
        .action-buttons .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            border: none;
        }
        
        .action-buttons .btn-light {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .error-state {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            color: #721c24;
        }
        
        /* è®¢å•çŠ¶æ€æ ·å¼ */
        .status-active { 
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
            color: white; 
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }
        .status-success { 
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); 
            color: white; 
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
        }
        .status-cancelled { 
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
            color: white; 
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }
        .status-finished { 
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%); 
            color: white; 
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
        }
        .status-default { 
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); 
            color: #212529; 
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        
        /* æ¨¡æ€æ¡†ç¾åŒ– */
        .modal-content {
            border-radius: 16px;
            border: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-bottom: none;
            position: relative;
        }
        
        .modal-header h3 {
            margin: 0;
            font-weight: 700;
            font-size: 1.3rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .modal-header .close {
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 1.5rem;
            font-weight: 300;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        
        .modal-header .close:hover {
            opacity: 1;
        }
        
        #modal-body {
            padding: 0;
            background: #fafafa;
        }
        
        /* ç¾åŒ–è´§å¸æ˜¾ç¤º */
        .currency {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        /* ç¾åŒ–è¡¨æ ¼ */
        .table-responsive tbody td strong {
            color: #2c3e50;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-muted {
            color: #6c757d !important;
            font-style: italic;
        }
        
        /* ç¾åŒ–åŠ è½½çŠ¶æ€ */
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        
        /* å¢å¼ºå“åº”å¼ä½“éªŒ */
        @media (max-width: 768px) {
            .modal-content {
                margin: 1rem;
                max-height: 95vh;
            }
            
            .table-details-container {
                padding: 1rem;
            }
            
            .order-info-section,
            .dishes-section {
                padding: 1rem;
            }
            
            .action-buttons {
                padding: 1rem;
            }
            
            .action-buttons .btn {
                display: block;
                width: 100%;
                margin: 0.25rem 0;
            }
        }
        
        /* åŠ èœæ¨¡æ€æ¡†æ ·å¼ */
        .dish-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            padding: 1rem;
            min-height: 100px; /* ç¡®ä¿æœ‰æœ€å°é«˜åº¦ */
        }
        
        .dish-item {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            background: white;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .dish-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.15);
            transform: translateY(-1px);
        }
        
        .dish-item.selected {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        
        .dish-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #212529;
            margin-bottom: 0.5rem;
        }
        
        .dish-description {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }
        
        .dish-price {
            color: #e74c3c;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
        }
        
        .dish-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }
        
        .quantity-btn:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }
        
        .quantity-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 0.25rem;
        }
        
        .selected-dish-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        
        .selected-dish-info {
            flex: 1;
        }
        
        .selected-dish-name {
            font-weight: 600;
            color: #212529;
        }
        
        .selected-dish-details {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .selected-dish-total {
            font-weight: 600;
            color: #28a745;
            margin-left: 1rem;
        }
        
        .remove-dish-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 0.5rem;
            font-size: 0.8rem;
        }
        
        .remove-dish-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>é¤é¥®ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="nav-links">
            <a href="index.html">é¦–é¡µ</a>
            <a href="tables.html" class="active">æ¡Œå°ç®¡ç†</a>
            <a href="orders.html">è®¢å•ç®¡ç†</a>
            <a href="menu.html">èœå•ç®¡ç†</a>
            <a href="staff.html">å‘˜å·¥ç®¡ç†</a>
            <a href="inventory.html">åº“å­˜ç®¡ç†</a>
        </div>
    </nav>

    <div class="container">
        <div class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>æ¡Œå°ç®¡ç†</h2>
                <div>
                    <button onclick="refreshTables()" class="btn btn-secondary">åˆ·æ–°çŠ¶æ€</button>
                </div>
            </div>

            <!-- æ¡Œå°çŠ¶æ€ç»Ÿè®¡ -->
            <div class="card">
                <h3>æ¡Œå°çŠ¶æ€æ¦‚è§ˆ</h3>
                <div style="display: flex; gap: 2rem; margin-top: 1rem;">
                    <div>
                        <span class="status-badge status-available">ç©ºé—²: <span id="available-count">0</span></span>
                    </div>
                    <div>
                        <span class="status-badge status-occupied">å ç”¨: <span id="occupied-count">0</span></span>
                    </div>
                    <div>
                        <span class="status-badge status-reserved">é¢„è®¢: <span id="reserved-count">0</span></span>
                    </div>
                    <div>
                        <span class="status-badge status-cleaning">æ¸…æ´ä¸­: <span id="cleaning-count">0</span></span>
                    </div>
                </div>
            </div>

            <!-- æ¡Œå°ç½‘æ ¼ -->
            <div class="card">
                <h3>æ¡Œå°å¸ƒå±€</h3>
                <div id="table-grid" class="table-grid">
                    <!-- æ¡Œå°é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
    </div>

    <!-- æ¡Œå°è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="tableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">æ¡Œå°è¯¦æƒ…</h3>
                <span class="close">&times;</span>
            </div>
            <div id="modal-body">
                <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </div>

    <!-- å¼€å°æ¨¡æ€æ¡† -->
    <div id="openTableModal" class="modal">
        <div class="modal-content" style="
            max-width: 500px; 
            max-height: 90vh; 
            margin: 5vh auto;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        ">
            <div class="modal-header" style="
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%); 
                color: white;
                flex-shrink: 0;
            ">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    ğŸª <span id="openTableTitle">å¼€å°</span>
                </h3>
                <span class="close">&times;</span>
            </div>
            <div style="
                padding: 2rem; 
                background: linear-gradient(135deg, #f8fff8 0%, #ffffff 100%);
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
            ">>
                <form id="openTableForm">
                    <!-- æ¡Œå°ä¿¡æ¯å±•ç¤º -->
                    <div style="
                        background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
                        padding: 1.5rem;
                        border-radius: 12px;
                        margin-bottom: 2rem;
                        border: 1px solid #c3e6cb;
                        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);
                    ">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">ğŸ½ï¸</div>
                            <h4 style="color: #28a745; margin: 0; font-weight: 700;" id="tableInfoDisplay">å‡†å¤‡å¼€å°</h4>
                            <p style="color: #6c757d; margin: 0.5rem 0 0 0; font-size: 0.9rem;">ä¸ºå®¢äººæä¾›ä¼˜è´¨æœåŠ¡</p>
                        </div>
                    </div>

                    <!-- è¡¨å•å­—æ®µ -->
                    <div class="form-group" style="margin-bottom: 1.75rem;">
                        <label for="staffSelect" style="
                            display: block;
                            margin-bottom: 0.75rem;
                            font-weight: 600;
                            color: #495057;
                            font-size: 1rem;
                        ">ğŸ‘¨â€ğŸ’¼ è´Ÿè´£æœåŠ¡å‘˜:</label>
                        <select id="staffSelect" class="form-control" required style="
                            width: 100%;
                            padding: 0.875rem 1rem;
                            border: 2px solid #e9ecef;
                            border-radius: 8px;
                            font-size: 1rem;
                            transition: all 0.3s ease;
                            background: white;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        " onchange="this.style.borderColor = this.value ? '#28a745' : '#e9ecef'">
                            <option value="">è¯·é€‰æ‹©æœåŠ¡å‘˜</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label for="orderNotes" style="
                            display: block;
                            margin-bottom: 0.75rem;
                            font-weight: 600;
                            color: #495057;
                            font-size: 1rem;
                        ">ğŸ“ å¼€å°å¤‡æ³¨:</label>
                        <textarea id="orderNotes" class="form-control" rows="3" placeholder="è¯·è¾“å…¥å¼€å°å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰" style="
                            width: 100%;
                            padding: 0.875rem 1rem;
                            border: 2px solid #e9ecef;
                            border-radius: 8px;
                            font-size: 1rem;
                            resize: vertical;
                            min-height: 80px;
                            transition: all 0.3s ease;
                            background: white;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        " onfocus="this.style.borderColor = '#28a745'; this.style.boxShadow = '0 4px 8px rgba(40, 167, 69, 0.15)'"
                           onblur="this.style.borderColor = '#e9ecef'; this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)'"></textarea>
                    </div>

                    <!-- æŒ‰é’®ç»„ -->
                    <div style="
                        display: flex;
                        gap: 1rem;
                        justify-content: center;
                        padding-top: 1rem;
                        border-top: 1px solid #e9ecef;
                    ">
                        <button type="button" onclick="Utils.hideModal('openTableModal')" class="btn btn-secondary" style="
                            padding: 0.75rem 1.5rem;
                            border-radius: 8px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            font-size: 0.9rem;
                            transition: all 0.3s ease;
                            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                            border: none;
                            color: white;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            âŒ å–æ¶ˆ
                        </button>
                        <button type="submit" class="btn btn-primary" style="
                            padding: 0.75rem 2rem;
                            border-radius: 8px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            font-size: 0.9rem;
                            transition: all 0.3s ease;
                            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                            border: none;
                            color: white;
                            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(40, 167, 69, 0.3)'"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(40, 167, 69, 0.2)'">
                            âœ… ç¡®è®¤å¼€å°
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ç»“è´¦ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="checkoutConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 450px; margin: 10% auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                    ğŸ’³ ç¡®è®¤ç»“è´¦
                </h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" style="padding: 0; background: linear-gradient(135deg, #f8fff8 0%, #ffffff 100%);">
                <div style="text-align: center; padding: 2rem;">
                    <!-- æˆåŠŸå›¾æ ‡ -->
                    <div style="
                        width: 80px;
                        height: 80px;
                        margin: 0 auto 1.5rem;
                        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 2.5rem;
                        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                        animation: pulse 1.5s ease-in-out infinite alternate;
                    ">ğŸ’³</div>
                    
                    <h4 style="
                        color: #28a745; 
                        margin-bottom: 1.5rem;
                        font-size: 1.3rem;
                        font-weight: 700;
                    ">ç¡®è®¤è¦ä¸ºæ­¤è®¢å•ç»“è´¦å—ï¼Ÿ</h4>
                    
                    <div id="checkout-order-info" style="
                        color: #495057; 
                        margin-bottom: 2rem;
                        background: rgba(255,255,255,0.8);
                        padding: 1.5rem;
                        border-radius: 12px;
                        border: 1px solid #e9ecef;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                        font-size: 1.1rem;
                        line-height: 1.6;
                    ">
                        <!-- è®¢å•ä¿¡æ¯å°†åŠ¨æ€å¡«å…… -->
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="Utils.hideModal('checkoutConfirmModal')" class="btn btn-secondary" style="
                            padding: 0.75rem 1.5rem;
                            border-radius: 8px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            font-size: 0.9rem;
                            transition: all 0.3s ease;
                            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                            border: none;
                            color: white;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            âŒ å–æ¶ˆ
                        </button>
                        
                        <button id="confirmCheckoutBtn" onclick="confirmCheckout()" class="btn btn-success" style="
                            padding: 0.75rem 2rem;
                            border-radius: 8px;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            font-size: 0.9rem;
                            transition: all 0.3s ease;
                            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                            border: none;
                            color: white;
                            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(40, 167, 69, 0.3)'"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(40, 167, 69, 0.2)'">
                            âœ… ç¡®è®¤ç»“è´¦
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ èœæ¨¡æ€æ¡† -->
    <div id="addDishModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 id="addDishModalTitle">åŠ èœ</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 1rem;">
                <!-- è®¢å•ä¿¡æ¯æ‘˜è¦ -->
                <div id="orderSummary" style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                    <!-- è®¢å•æ‘˜è¦å°†åŠ¨æ€å¡«å…… -->
                </div>
                
                <!-- èœå“åˆ†ç±»å’Œæœç´¢ -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="flex: 1;">
                            <label for="dishCategoryFilter">èœå“åˆ†ç±»:</label>
                            <select id="dishCategoryFilter" class="form-control" onchange="filterDishes()">
                                <option value="">å…¨éƒ¨åˆ†ç±»</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="dishSearchInput">æœç´¢èœå“:</label>
                            <input type="text" id="dishSearchInput" class="form-control" placeholder="è¾“å…¥èœå“åç§°æœç´¢" oninput="filterDishes()">
                        </div>
                    </div>
                </div>
                
                <!-- èœå“åˆ—è¡¨ -->
                <div id="dishesGrid" style="max-height: 350px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.5rem; background: #f8f9fa; margin-bottom: 1rem;">
                    <!-- èœå“ç½‘æ ¼å°†åŠ¨æ€å¡«å…… -->
                </div>
                
                <!-- å·²é€‰èœå“ -->
                <div id="selectedDishesSection" style="display: none;">
                    <h5>å·²é€‰èœå“:</h5>
                    <div id="selectedDishesList" style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; max-height: 200px; overflow-y: auto;">
                        <!-- å·²é€‰èœå“åˆ—è¡¨ -->
                    </div>
                    <div style="text-align: right; margin-bottom: 1rem;">
                        <strong>æœ¬æ¬¡åŠ èœæ€»è®¡: <span id="addDishTotal" style="color: #28a745; font-size: 1.2rem;">Â¥0.00</span></strong>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="flex-shrink: 0;">
                <button onclick="Utils.hideModal('addDishModal')" class="btn btn-secondary">å–æ¶ˆ</button>
                <button onclick="confirmAddSelectedDishes()" class="btn btn-primary" id="confirmAddDishBtn" disabled>ç¡®è®¤åŠ èœ</button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let currentTableId = null;
        let tables = [];
        let staff = [];
        let currentAddDishOrderId = null;
        let availableDishes = [];
        let dishCategories = [];
        let selectedDishes = new Map(); // ä½¿ç”¨Mapå­˜å‚¨å·²é€‰èœå“ {dishId: {dish, quantity, specialRequests}}

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadTables();
            loadStaff();
            loadDishesForAddDish();
            setupEventListeners();
        });

        function setupEventListeners() {
            // å¼€å°è¡¨å•æäº¤
            document.getElementById('openTableForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleOpenTable();
            });
        }

        async function loadTables() {
            try {
                tables = await API.get('/tables');
                renderTables();
                updateStatusCounts();
            } catch (error) {
                console.error('åŠ è½½æ¡Œå°æ•°æ®å¤±è´¥:', error);
                Utils.showNotification('åŠ è½½æ¡Œå°æ•°æ®å¤±è´¥', 'error');
            }
        }

        async function loadStaff() {
            try {
                staff = await API.get('/staff');
                populateStaffSelect();
            } catch (error) {
                console.error('åŠ è½½å‘˜å·¥æ•°æ®å¤±è´¥:', error);
            }
        }

        function populateStaffSelect() {
            const select = document.getElementById('staffSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©æœåŠ¡å‘˜</option>';
            
            staff.filter(s => s.status === 'åœ¨èŒ').forEach(s => {
                const option = document.createElement('option');
                option.value = s.staffID;
                option.textContent = s.staffName;
                select.appendChild(option);
            });
        }

        function renderTables() {
            const grid = document.getElementById('table-grid');
            grid.innerHTML = '';

            tables.forEach(table => {
                const tableItem = document.createElement('div');
                // è·å–æ¡Œå°é¡¹çš„çŠ¶æ€ç±»ï¼ˆä¸å¸¦ status- å‰ç¼€ï¼‰
                const statusInfo = Utils.getStatusInfo(table.status, 'table');
                const tableStatusClass = statusInfo.class.replace('status-', ''); // ç§»é™¤ status- å‰ç¼€
                tableItem.className = `table-item ${tableStatusClass}`;
                tableItem.onclick = () => handleTableClick(table);

                tableItem.innerHTML = `
                    <div class="table-number">æ¡Œå° ${table.tableNumber}</div>
                    <div class="table-capacity">å®¹é‡: ${table.capacity}äºº</div>
                    <div class="status-badge ${statusInfo.class}">
                        ${statusInfo.text}
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
                        åŒºåŸŸ: ${table.area}
                    </div>
                `;

                grid.appendChild(tableItem);
            });
        }

        function updateStatusCounts() {
            const counts = {
                available: tables.filter(t => t.status === 'ç©ºé—²').length,
                occupied: tables.filter(t => t.status === 'å ç”¨').length,
                reserved: tables.filter(t => t.status === 'é¢„è®¢').length,
                cleaning: tables.filter(t => t.status === 'æ¸…æ´ä¸­').length
            };

            document.getElementById('available-count').textContent = counts.available;
            document.getElementById('occupied-count').textContent = counts.occupied;
            document.getElementById('reserved-count').textContent = counts.reserved;
            document.getElementById('cleaning-count').textContent = counts.cleaning;
        }

        async function handleTableClick(table) {
            currentTableId = table.tableID;
            
            if (table.status === 'ç©ºé—²') {
                showOpenTableModal(table);
            } else if (table.status === 'å ç”¨') {
                await showTableDetails(table);
            } else if (table.status === 'æ¸…æ´ä¸­') {
                showTableCleaningOptions(table);
            }
        }

        function showOpenTableModal(table) {
            // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜å’Œæ¡Œå°ä¿¡æ¯
            document.getElementById('openTableTitle').textContent = `å¼€å° - æ¡Œå°${table.tableNumber}`;
            document.getElementById('tableInfoDisplay').innerHTML = `
                æ¡Œå°${table.tableNumber} (${table.capacity}äººæ¡Œ)
                <br><small style="color: #6c757d; font-size: 0.8rem;">åŒºåŸŸ: ${table.area}</small>
            `;
            
            // é‡ç½®è¡¨å•
            Utils.resetForm(document.getElementById('openTableForm'));
            
            Utils.showModal('openTableModal');
        }

        async function showTableDetails(table) {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('modal-title').textContent = `æ¡Œå°${table.tableNumber} - åŠ è½½ä¸­...`;
                document.getElementById('modal-body').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div class="loading-spinner"></div>
                        <p>æ­£åœ¨åŠ è½½è®¢å•ä¿¡æ¯...</p>
                    </div>
                `;
                Utils.showModal('tableModal');

                // è·å–å½“å‰è®¢å•ä¿¡æ¯ï¼Œå¢åŠ é”™è¯¯å¤„ç†
                let currentOrder = null;
                try {
                    const response = await fetch(`/api/tables/${table.tableID}/current-order`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        currentOrder = await response.json();
                        console.log('è·å–åˆ°çš„è®¢å•æ•°æ®:', currentOrder);
                    } else if (response.status === 404) {
                        // 404è¡¨ç¤ºæ²¡æœ‰è®¢å•ï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µ
                        currentOrder = null;
                    } else {
                        throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`);
                    }
                } catch (apiError) {
                    console.warn('è·å–è®¢å•APIè°ƒç”¨å¤±è´¥:', apiError);
                    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œç»§ç»­æ˜¾ç¤ºæ— è®¢å•çŠ¶æ€
                    currentOrder = null;
                }
                
                let orderDetails = '';
                let staffInfo = '';
                
                if (currentOrder) {
                    // è·å–è®¢å•è¯¦æƒ…å’ŒæœåŠ¡å‘˜ä¿¡æ¯
                    const [detailsResponse, orderStaff] = await Promise.all([
                        API.get(`/orders/${currentOrder.orderID}/details`).catch(() => ({ details: [] })),
                        currentOrder.staffID ? API.get(`/staff/${currentOrder.staffID}`).catch(() => null) : null
                    ]);

                    staffInfo = orderStaff ? `
                        <p><strong>è´Ÿè´£æœåŠ¡å‘˜:</strong> ${orderStaff.staffName}</p>
                    ` : '';

                    // æ­£ç¡®è§£æåç«¯è¿”å›çš„æ•°æ®ç»“æ„
                    console.log('è®¢å•è¯¦æƒ…å“åº”æ•°æ®:', detailsResponse);
                    console.log('å“åº”æ•°æ®ç±»å‹:', typeof detailsResponse);
                    
                    // åç«¯è¿”å›çš„æ˜¯ { details: [...], statistics: {...} } æ ¼å¼
                    let detailsArray = [];
                    if (detailsResponse && Array.isArray(detailsResponse.details)) {
                        detailsArray = detailsResponse.details;
                    } else if (Array.isArray(detailsResponse)) {
                        // å…¼å®¹ç›´æ¥è¿”å›æ•°ç»„çš„æƒ…å†µ
                        detailsArray = detailsResponse;
                    }
                    
                    console.log('è§£æåçš„è¯¦æƒ…æ•°ç»„:', detailsArray);
                    console.log('è¯¦æƒ…æ•°ç»„é•¿åº¦:', detailsArray.length);
                    console.log('æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(detailsArray));
                    
                    // è°ƒè¯•ï¼šæŸ¥çœ‹ç¬¬ä¸€æ¡è®°å½•çš„æ‰€æœ‰å­—æ®µ
                    if (detailsArray.length > 0) {
                        console.log('ç¬¬ä¸€æ¡è®°å½•çš„æ‰€æœ‰å­—æ®µ:', Object.keys(detailsArray[0]));
                        console.log('ç¬¬ä¸€æ¡è®°å½•çš„å®Œæ•´æ•°æ®:', detailsArray[0]);
                    }
                    
                    // è®¡ç®—æ€»é‡‘é¢ï¼Œä¼˜å…ˆä½¿ç”¨åç«¯ç»Ÿè®¡æ•°æ®
                    const totalAmount = detailsResponse.statistics?.totalAmount || 
                        detailsArray.reduce((sum, d) => sum + (d.subtotal || d.Subtotal || 0), 0);
                    
                    orderDetails = `
                        <div class="order-info-section">
                            <h4 style="color: #28a745; margin-bottom: 1rem;">
                                <i class="icon-order"></i> å½“å‰è®¢å•ä¿¡æ¯
                            </h4>
                            <div class="info-grid">
                                <p><strong>è®¢å•å·:</strong> #${currentOrder.orderID}</p>
                                <p><strong>ä¸‹å•æ—¶é—´:</strong> ${Utils.formatDateTime(currentOrder.orderTime)}</p>
                                ${staffInfo}
                                <p><strong>è®¢å•çŠ¶æ€:</strong> <span class="status-badge ${getOrderStatusClass(currentOrder.orderStatus)}">${currentOrder.orderStatus}</span></p>
                                <p><strong>å¤‡æ³¨:</strong> ${currentOrder.notes || 'æ— '}</p>
                            </div>
                        </div>
                        
                        <div class="dishes-section">
                            <h5 style="margin: 1.5rem 0 1rem 0;">
                                <i class="icon-dish"></i> èœå“åˆ—è¡¨ (${detailsArray.length}é¡¹)
                            </h5>
                            ${detailsArray.length > 0 ? `
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>èœå“åç§°</th>
                                                <th>æ•°é‡</th>
                                                <th>å•ä»·</th>
                                                <th>å°è®¡</th>
                                                <th>ç‰¹æ®Šè¦æ±‚</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${detailsArray.map(d => `
                                                <tr>
                                                    <td><strong>${d.dishName || d.DishName || 'æœªçŸ¥èœå“'}</strong></td>
                                                    <td class="text-center">${d.quantity || d.Quantity || 0}</td>
                                                    <td class="text-right">${Utils.formatCurrency(d.unitPrice || d.UnitPrice || 0)}</td>
                                                    <td class="text-right"><strong>${Utils.formatCurrency(d.subtotal || d.Subtotal || 0)}</strong></td>
                                                    <td class="text-muted">${d.specialRequests || d.SpecialRequests || '-'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                        <tfoot>
                                            <tr class="total-row">
                                                <td colspan="3"><strong>æ€»è®¡</strong></td>
                                                <td class="text-right"><strong style="color: #28a745; font-size: 1.1em;">${Utils.formatCurrency(totalAmount)}</strong></td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            ` : `
                                <div class="empty-state">
                                    <p style="color: #6c757d; text-align: center; padding: 2rem;">
                                        <i class="icon-empty"></i><br>
                                        æš‚æ— ç‚¹èœè®°å½•
                                    </p>
                                </div>
                            `}
                        </div>
                        
                        <div class="action-buttons" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="addDish(${currentOrder.orderID})" class="btn btn-primary">
                                    <i class="icon-add"></i> åŠ èœ
                                </button>
                                <button onclick="printOrder(${currentOrder.orderID})" class="btn btn-secondary">
                                    <i class="icon-print"></i> æ‰“å°
                                </button>
                                <button onclick="checkoutOrder(${currentOrder.orderID})" class="btn btn-success">
                                    <i class="icon-checkout"></i> ç»“è´¦ (${Utils.formatCurrency(totalAmount)})
                                </button>
                            </div>
                            <div style="margin-top: 1rem;">
                                <button onclick="Utils.hideModal('tableModal')" class="btn btn-light" style="width: 100%;">å…³é—­</button>
                            </div>
                        </div>
                    `;
                } else {
                    // æ²¡æœ‰è®¢å•æ—¶æ˜¾ç¤ºåˆ›å»ºè®¢å•ç•Œé¢
                    orderDetails = `
                        <div class="no-order-section">
                            <div style="
                                text-align: center; 
                                padding: 3rem 2rem; 
                                background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); 
                                border: 2px dashed #28a745; 
                                border-radius: 16px; 
                                margin: 1rem 0;
                                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1);
                                transition: all 0.3s ease;
                            ">
                                <div style="
                                    font-size: 4rem; 
                                    margin-bottom: 1.5rem;
                                    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
                                ">ğŸ½ï¸</div>
                                <h4 style="
                                    color: #28a745; 
                                    margin-bottom: 1rem;
                                    font-size: 1.5rem;
                                    font-weight: 700;
                                ">è¯¥æ¡Œå°æš‚æ— è®¢å•</h4>
                                <p style="
                                    color: #6c757d; 
                                    margin-bottom: 2rem;
                                    font-size: 1.1rem;
                                    font-weight: 500;
                                ">å®¢äººå·²å…¥åº§ï¼Œå¯ä»¥å¼€å§‹ç‚¹é¤äº†</p>
                                
                                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                    <button onclick="createNewOrder(${table.tableID})" class="btn btn-primary btn-lg" style="
                                        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                                        border: none;
                                        padding: 1rem 2rem;
                                        border-radius: 12px;
                                        font-size: 1.1rem;
                                        font-weight: 600;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                                        transition: all 0.3s ease;
                                    " 
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(40, 167, 69, 0.4)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.3)'">
                                        âœ¨ åˆ›å»ºè®¢å•
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                document.getElementById('modal-title').textContent = `æ¡Œå°${table.tableNumber}`;
                document.getElementById('modal-body').innerHTML = `
                    <div class="table-details-container">
                        ${orderDetails}
                    </div>
                `;

                Utils.showModal('tableModal');
            } catch (error) {
                console.error('è·å–æ¡Œå°è¯¦æƒ…å¤±è´¥:', error);
                document.getElementById('modal-title').textContent = `æ¡Œå°${table.tableNumber} - é”™è¯¯`;
                document.getElementById('modal-body').innerHTML = `
                    <div class="error-state" style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;">âš ï¸</div>
                        <h4 style="color: #dc3545;">åŠ è½½å¤±è´¥</h4>
                        <p style="color: #6c757d; margin: 1rem 0;">æ— æ³•è·å–æ¡Œå°è¯¦æƒ…ä¿¡æ¯</p>
                        <div>
                            <button onclick="showTableDetails({tableID: ${table.tableID}, tableNumber: '${table.tableNumber}', capacity: ${table.capacity}, area: '${table.area}', status: '${table.status}'})" class="btn btn-primary">é‡è¯•</button>
                            <button onclick="Utils.hideModal('tableModal')" class="btn btn-secondary">å…³é—­</button>
                        </div>
                    </div>
                `;
                Utils.showNotification('è·å–æ¡Œå°è¯¦æƒ…å¤±è´¥', 'error');
            }
        }

        // è·å–è®¢å•çŠ¶æ€å¯¹åº”çš„CSSç±»
        function getOrderStatusClass(status) {
            const statusMap = {
                'å¾…å¤„ç†': 'status-default',
                'åˆ¶ä½œä¸­': 'status-active',
                'å·²å®Œæˆ': 'status-success',
                'å·²ç»“è´¦': 'status-finished'
            };
            return statusMap[status] || 'status-default';
        }

        // æ‰“å°è®¢å•
        function printOrder(orderId) {
            // TODO: å®ç°æ‰“å°åŠŸèƒ½
            Utils.showNotification('æ‰“å°åŠŸèƒ½å¾…å®ç°', 'info');
        }

        function showTableCleaningOptions(table) {
            document.getElementById('modal-title').textContent = `æ¡Œå°${table.tableNumber} - æ¸…æ´ä¸­`;
            document.getElementById('modal-body').innerHTML = `
                <div class="table-details-container">
                    <div style="
                        text-align: center; 
                        padding: 3rem 2rem; 
                        background: linear-gradient(135deg, #fff3e0 0%, #fffef7 100%); 
                        border: 2px dashed #ff9800; 
                        border-radius: 16px; 
                        margin: 1rem 0;
                        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.1);
                    ">
                        <div style="
                            font-size: 4rem; 
                            margin-bottom: 1.5rem;
                            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
                        ">ğŸ§¹</div>
                        <h4 style="
                            color: #f57f17; 
                            margin-bottom: 1rem;
                            font-size: 1.5rem;
                            font-weight: 700;
                        ">æ¡Œå°${table.tableNumber} æ¸…æ´ä¸­</h4>
                        
                        <div style="
                            background: rgba(255,255,255,0.8);
                            padding: 1.5rem;
                            border-radius: 12px;
                            margin: 1.5rem 0;
                            border: 1px solid #e9ecef;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                        ">
                            <p style="margin: 0.5rem 0; color: #495057;"><strong>æ¡Œå°å·:</strong> ${table.tableNumber}</p>
                            <p style="margin: 0.5rem 0; color: #495057;"><strong>å®¹é‡:</strong> ${table.capacity}äºº</p>
                            <p style="margin: 0.5rem 0; color: #495057;"><strong>åŒºåŸŸ:</strong> ${table.area}</p>
                            <p style="margin: 0.5rem 0; color: #495057;"><strong>å½“å‰çŠ¶æ€:</strong> <span class="status-badge status-cleaning">æ¸…æ´ä¸­</span></p>
                        </div>
                        
                        <p style="
                            color: #6c757d; 
                            margin-bottom: 2rem;
                            font-size: 1.1rem;
                            font-weight: 500;
                        ">è¯¥æ¡Œå°æ­£åœ¨æ¸…æ´ä¸­ï¼Œæ¸…æ´å®Œæˆåå¯è®¾ç½®ä¸ºç©ºé—²çŠ¶æ€</p>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button onclick="finishCleaning(${table.tableID})" class="btn btn-success" style="
                                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                                border: none;
                                padding: 1rem 2rem;
                                border-radius: 12px;
                                font-size: 1.1rem;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                                transition: all 0.3s ease;
                                color: white;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(40, 167, 69, 0.4)'"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.3)'">
                                âœ¨ å®Œæˆæ¸…æ´
                            </button>
                            
                            <button onclick="Utils.hideModal('tableModal')" class="btn btn-secondary" style="
                                background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
                                border: none;
                                padding: 1rem 1.5rem;
                                border-radius: 12px;
                                font-size: 1.1rem;
                                font-weight: 600;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                                box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
                                transition: all 0.3s ease;
                                color: white;
                            " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(108, 117, 125, 0.4)'"
                               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(108, 117, 125, 0.3)'">
                                å…³é—­
                            </button>
                        </div>
                    </div>
                </div>
            `;
            Utils.showModal('tableModal');
        }

        async function handleOpenTable() {
            if (!Utils.validateForm(document.getElementById('openTableForm'))) {
                Utils.showNotification('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'warning');
                return;
            }

            try {
                const staffId = document.getElementById('staffSelect').value;
                const notes = document.getElementById('orderNotes').value;

                console.log(`å¼€å°ï¼šå‡†å¤‡å¼€å¯æ¡Œå° ${currentTableId}`);
                console.log('å¼€å°URL:', `/api/tables/${currentTableId}/open`);
                console.log('å¼€å°å‚æ•°:', { staffId, notes });

                // ä½¿ç”¨ä¸“é—¨çš„å¼€å°API
                const openTableResult = await API.post(`/tables/${currentTableId}/open`, { 
                    staffId: staffId,
                    notes: notes 
                });
                console.log('å¼€å°APIè¿”å›ç»“æœ:', openTableResult);

                Utils.showNotification('å¼€å°æˆåŠŸ', 'success');
                Utils.hideModal('openTableModal');
                Utils.resetForm(document.getElementById('openTableForm'));
                
                // åˆ·æ–°æ¡Œå°çŠ¶æ€
                await loadTables();

            } catch (error) {
                console.error('å¼€å°å¤±è´¥:', error);
                console.error('å¼€å°é”™è¯¯è¯¦æƒ…:', error.response || error.message);
                console.error('å¼€å°é”™è¯¯çŠ¶æ€ç :', error.status);
                console.error('å¼€å°å®Œæ•´é”™è¯¯å¯¹è±¡:', error);
                Utils.showNotification('å¼€å°å¤±è´¥', 'error');
            }
        }

        let currentCheckoutOrderId = null;

        async function checkoutOrder(orderId) {
            try {
                // å…ˆè·å–è®¢å•ä¿¡æ¯ç”¨äºæ˜¾ç¤º
                const order = await API.get(`/orders/${orderId}`);
                if (!order) {
                    Utils.showNotification('è®¢å•ä¸å­˜åœ¨', 'error');
                    return;
                }

                // è·å–è®¢å•è¯¦æƒ…è®¡ç®—æ€»é‡‘é¢
                const detailsResponse = await API.get(`/orders/${orderId}/details`).catch(() => ({ details: [] }));
                const detailsArray = Array.isArray(detailsResponse.details) ? detailsResponse.details : 
                                   Array.isArray(detailsResponse) ? detailsResponse : [];
                const totalAmount = detailsResponse.statistics?.totalAmount || 
                    detailsArray.reduce((sum, d) => sum + (d.Subtotal || 0), 0);

                // è®¾ç½®å½“å‰è¦ç»“è´¦çš„è®¢å•ID
                currentCheckoutOrderId = orderId;

                // å¡«å……ç¡®è®¤ä¿¡æ¯
                document.getElementById('checkout-order-info').innerHTML = `
                    <strong>è®¢å•å·:</strong> #${orderId}<br>
                    <strong>æ€»é‡‘é¢:</strong> <span style="color: #28a745; font-size: 1.2em;">${Utils.formatCurrency(totalAmount)}</span>
                `;

                // æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†
                Utils.showModal('checkoutConfirmModal');

            } catch (error) {
                console.error('è·å–è®¢å•ä¿¡æ¯å¤±è´¥:', error);
                Utils.showNotification('è·å–è®¢å•ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        async function confirmCheckout() {
            if (!currentCheckoutOrderId) {
                Utils.showNotification('è®¢å•ä¿¡æ¯å¼‚å¸¸', 'error');
                return;
            }

            try {
                Utils.showNotification('æ­£åœ¨å¤„ç†ç»“è´¦...', 'info');
                
                // éšè—ç¡®è®¤æ¨¡æ€æ¡†
                Utils.hideModal('checkoutConfirmModal');

                // å…ˆè·å–è®¢å•ä¿¡æ¯
                const order = await API.get(`/orders/${currentCheckoutOrderId}`);
                if (!order) {
                    throw new Error('è®¢å•ä¸å­˜åœ¨');
                }

                console.log('ç»“è´¦å‰è®¢å•çŠ¶æ€:', order.orderStatus);

                // æ‰§è¡Œç»“è´¦æ“ä½œ
                const checkoutResult = await API.put(`/orders/${currentCheckoutOrderId}/checkout`);
                console.log('ç»“è´¦APIè¿”å›ç»“æœ:', checkoutResult);

                // éªŒè¯è®¢å•çŠ¶æ€æ˜¯å¦å·²æ›´æ–°ä¸º"å·²ç»“è´¦"
                const updatedOrder = await API.get(`/orders/${currentCheckoutOrderId}`);
                console.log('ç»“è´¦åè®¢å•çŠ¶æ€:', updatedOrder?.orderStatus);

                if (updatedOrder && updatedOrder.orderStatus !== 'å·²ç»“è´¦') {
                    console.warn(`è®¢å•çŠ¶æ€æ›´æ–°å¼‚å¸¸: æœŸæœ›"å·²ç»“è´¦"ï¼Œå®é™…"${updatedOrder.orderStatus}"`);
                    // æ‰‹åŠ¨æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
                    try {
                        await API.put(`/orders/${currentCheckoutOrderId}/status`, { status: 'å·²ç»“è´¦' });
                        console.log('æ‰‹åŠ¨æ›´æ–°è®¢å•çŠ¶æ€ä¸º"å·²ç»“è´¦"');
                    } catch (statusUpdateError) {
                        console.error('æ‰‹åŠ¨æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', statusUpdateError);
                    }
                }
                
                // è®¾ç½®æ¡Œå°ä¸ºæ¸…æ´ä¸­çŠ¶æ€
                if (order.tableID) {
                    try {
                        console.log(`å‡†å¤‡å°†æ¡Œå° ${order.tableID} çŠ¶æ€æ›´æ–°ä¸ºæ¸…æ´ä¸­`);
                        console.log('æ¡Œå°çŠ¶æ€æ›´æ–°URL:', `/api/tables/${order.tableID}/status`);
                        console.log('æ¡Œå°çŠ¶æ€æ›´æ–°å‚æ•°:', { status: "æ¸…æ´ä¸­" });
                        
                        const tableUpdateResult = await API.put(`/tables/${order.tableID}/status`, { Status: "æ¸…æ´ä¸­" });
                        console.log('æ¡Œå°çŠ¶æ€æ›´æ–°APIè¿”å›ç»“æœ:', tableUpdateResult);
                        console.log('æ¡Œå°çŠ¶æ€å·²æ›´æ–°ä¸ºæ¸…æ´ä¸­');
                    } catch (tableError) {
                        console.error('æ›´æ–°æ¡Œå°çŠ¶æ€å¤±è´¥:', tableError);
                        console.error('é”™è¯¯è¯¦æƒ…:', tableError.response || tableError.message);
                        console.error('é”™è¯¯çŠ¶æ€ç :', tableError.status);
                        console.error('å®Œæ•´é”™è¯¯å¯¹è±¡:', tableError);
                        Utils.showNotification(`æ¡Œå°çŠ¶æ€æ›´æ–°å¤±è´¥: ${tableError.message || 'æœªçŸ¥é”™è¯¯'}`, 'warning');
                        // ä¸å½±å“ç»“è´¦æµç¨‹ï¼Œç»§ç»­æ‰§è¡Œ
                    }
                } else {
                    console.warn('è®¢å•æ²¡æœ‰å…³è”çš„æ¡Œå°IDï¼Œæ— æ³•æ›´æ–°æ¡Œå°çŠ¶æ€');
                }

                Utils.showNotification(`è®¢å• #${currentCheckoutOrderId} ç»“è´¦æˆåŠŸï¼`, 'success');
                Utils.hideModal('tableModal');
                
                // é‡ç½®å½“å‰ç»“è´¦è®¢å•ID
                currentCheckoutOrderId = null;
                
                // åˆ·æ–°æ¡Œå°çŠ¶æ€
                await loadTables();

            } catch (error) {
                console.error('ç»“è´¦å¤±è´¥:', error);
                let errorMessage = 'ç»“è´¦å¤±è´¥';
                
                if (error.response) {
                    console.error('APIé”™è¯¯è¯¦æƒ…:', error.response);
                    if (error.response.status === 404) {
                        errorMessage = 'è®¢å•ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤';
                    } else if (error.response.status === 400) {
                        errorMessage = 'è®¢å•çŠ¶æ€å¼‚å¸¸ï¼Œæ— æ³•ç»“è´¦';
                    } else {
                        errorMessage = `ç»“è´¦å¤±è´¥ (é”™è¯¯ç : ${error.response.status})`;
                    }
                } else if (error.message) {
                    errorMessage = `ç»“è´¦å¤±è´¥: ${error.message}`;
                }
                
                Utils.showNotification(errorMessage, 'error');
                
                // é‡ç½®å½“å‰ç»“è´¦è®¢å•ID
                currentCheckoutOrderId = null;
            }
        }

        async function finishCleaning(tableId) {
            try {
                Utils.showNotification('æ­£åœ¨å®Œæˆæ¸…æ´...', 'info');
                
                await API.put(`/tables/${tableId}/status`, { Status: "ç©ºé—²" });
                
                Utils.showNotification('æ¸…æ´å®Œæˆï¼Œæ¡Œå°å·²è®¾ä¸ºç©ºé—²', 'success');
                Utils.hideModal('tableModal');
                
                // åˆ·æ–°æ¡Œå°çŠ¶æ€
                await loadTables();

            } catch (error) {
                console.error('æ“ä½œå¤±è´¥:', error);
                Utils.showNotification('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        function addDish(orderId) {
            currentAddDishOrderId = orderId;
            selectedDishes.clear();
            showAddDishModal(orderId);
        }

        async function showAddDishModal(orderId) {
            try {
                // è·å–è®¢å•ä¿¡æ¯
                const order = await API.get(`/orders/${orderId}`);
                if (!order) {
                    Utils.showNotification('è®¢å•ä¸å­˜åœ¨', 'error');
                    return;
                }

                // è·å–æ¡Œå°ä¿¡æ¯
                const table = tables.find(t => t.tableID === order.tableID);
                const tableNumber = table ? table.tableNumber : order.tableID;

                // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜å’Œè®¢å•æ‘˜è¦
                document.getElementById('addDishModalTitle').textContent = `åŠ èœ - æ¡Œå°${tableNumber}`;
                document.getElementById('orderSummary').innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h5 style="margin: 0; color: #28a745;">è®¢å• #${orderId}</h5>
                            <p style="margin: 0.25rem 0 0 0; color: #6c757d;">æ¡Œå°${tableNumber} | ${Utils.formatDateTime(order.orderTime)}</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #6c757d; font-size: 0.9rem;">å½“å‰çŠ¶æ€</div>
                            <span class="status-badge ${getOrderStatusClass(order.orderStatus)}">${order.orderStatus}</span>
                        </div>
                    </div>
                `;

                // æ¸²æŸ“èœå“ç½‘æ ¼
                renderDishesGrid();
                updateSelectedDishesDisplay();

                Utils.showModal('addDishModal');

            } catch (error) {
                console.error('åŠ è½½åŠ èœæ¨¡æ€æ¡†å¤±è´¥:', error);
                Utils.showNotification('åŠ è½½èœå“ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        async function loadDishesForAddDish() {
            try {
                console.log('å¼€å§‹åŠ è½½èœå“æ•°æ®...');
                
                // åŠ è½½èœå“æ•°æ®
                availableDishes = await API.get('/menu/dishes');
                console.log('åŸå§‹èœå“æ•°æ®:', availableDishes);
                
                if (availableDishes && availableDishes.length > 0) {
                    console.log('ç¬¬ä¸€ä¸ªèœå“æ•°æ®ç¤ºä¾‹:', availableDishes[0]);
                }
                
                // è¿‡æ»¤å¯ç”¨èœå“
                const originalCount = availableDishes?.length || 0;
                availableDishes = availableDishes?.filter(dish => {
                    // å¤„ç†å¤§å°å†™å­—æ®µåé—®é¢˜
                    const isAvailable = dish.isAvailable === true || dish.ISAVAILABLE === 'Y';
                    return isAvailable;
                }) || [];
                console.log(`èœå“è¿‡æ»¤ç»“æœ: åŸå§‹${originalCount}ä¸ªï¼Œå¯ç”¨${availableDishes.length}ä¸ª`);

                // åŠ è½½èœå“åˆ†ç±»
                console.log('å¼€å§‹åŠ è½½èœå“åˆ†ç±»...');
                try {
                    const categories = await API.get('/menu/categories');
                    console.log('åˆ†ç±»æ•°æ®:', categories);
                    dishCategories = categories || [];

                    // å¡«å……åˆ†ç±»ä¸‹æ‹‰æ¡†
                    const categorySelect = document.getElementById('dishCategoryFilter');
                    if (categorySelect) {
                        categorySelect.innerHTML = '<option value="">å…¨éƒ¨åˆ†ç±»</option>';
                        dishCategories.forEach(category => {
                            const option = document.createElement('option');
                            const categoryID = category.categoryID || category.CATEGORYID;
                            const categoryName = category.categoryName || category.CATEGORYNAME;
                            option.value = categoryID;
                            option.textContent = categoryName;
                            categorySelect.appendChild(option);
                        });
                        console.log(`åˆ†ç±»ä¸‹æ‹‰æ¡†å·²å¡«å……ï¼Œå…±${dishCategories.length}ä¸ªåˆ†ç±»`);
                    }
                } catch (categoryError) {
                    console.warn('åŠ è½½åˆ†ç±»å¤±è´¥ï¼Œä½†èœå“åŠŸèƒ½ä»å¯ä½¿ç”¨:', categoryError);
                    dishCategories = [];
                }

                console.log('èœå“æ•°æ®åŠ è½½å®Œæˆ');

            } catch (error) {
                console.error('åŠ è½½èœå“æ•°æ®å¤±è´¥:', error);
                availableDishes = [];
                dishCategories = [];
                Utils.showNotification('åŠ è½½èœå“æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜', 'error');
            }
        }

        function renderDishesGrid() {
            const dishesGrid = document.getElementById('dishesGrid');
            const categoryFilter = document.getElementById('dishCategoryFilter').value;
            const searchQuery = document.getElementById('dishSearchInput').value.toLowerCase().trim();

            console.log('æ¸²æŸ“èœå“ç½‘æ ¼...');
            console.log('å¯ç”¨èœå“æ•°é‡:', availableDishes.length);
            console.log('åˆ†ç±»è¿‡æ»¤å™¨:', categoryFilter);
            console.log('æœç´¢æŸ¥è¯¢:', searchQuery);

            // è¿‡æ»¤èœå“
            let filteredDishes = availableDishes;

            if (categoryFilter) {
                const beforeFilter = filteredDishes.length;
                filteredDishes = filteredDishes.filter(dish => {
                    const categoryID = dish.categoryID || dish.CATEGORYID;
                    return categoryID == categoryFilter;
                });
                console.log(`æŒ‰åˆ†ç±»è¿‡æ»¤: ${beforeFilter} -> ${filteredDishes.length}`);
            }

            if (searchQuery) {
                const beforeFilter = filteredDishes.length;
                filteredDishes = filteredDishes.filter(dish => {
                    const dishName = dish.dishName || dish.DISHNAME || '';
                    const description = dish.description || dish.DESCRIPTION || '';
                    return dishName.toLowerCase().includes(searchQuery) ||
                           description.toLowerCase().includes(searchQuery);
                });
                console.log(`æŒ‰æœç´¢è¿‡æ»¤: ${beforeFilter} -> ${filteredDishes.length}`);
            }

            console.log('æœ€ç»ˆè¿‡æ»¤åèœå“æ•°é‡:', filteredDishes.length);

            if (filteredDishes.length === 0) {
                console.log('æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„èœå“ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                dishesGrid.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6c757d;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ğŸ”</div>
                        <p>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„èœå“</p>
                        <p style="font-size: 0.9rem; margin-top: 1rem;">
                            æ€»èœå“æ•°: ${availableDishes.length} | 
                            åˆ†ç±»è¿‡æ»¤: ${categoryFilter || 'æ— '} | 
                            æœç´¢å…³é”®è¯: ${searchQuery || 'æ— '}
                        </p>
                    </div>
                `;
                return;
            }

            console.log('å¼€å§‹æ¸²æŸ“èœå“ç½‘æ ¼ï¼Œèœå“æ•°é‡:', filteredDishes.length);
            
            dishesGrid.innerHTML = `
                <div class="dish-grid">
                    ${filteredDishes.map(dish => {
                        const dishID = dish.dishID || dish.DISHID;
                        const dishName = dish.dishName || dish.DISHNAME || 'æœªçŸ¥èœå“';
                        const description = dish.description || dish.DESCRIPTION || 'æš‚æ— æè¿°';
                        const price = dish.price || dish.PRICE || 0;
                        
                        const isSelected = selectedDishes.has(dishID);
                        const selectedData = selectedDishes.get(dishID);
                        const quantity = selectedData ? selectedData.quantity : 0;
                        
                        return `
                            <div class="dish-item ${isSelected ? 'selected' : ''}" id="dish-${dishID}">
                                <div class="dish-name">${dishName}</div>
                                <div class="dish-description">${description}</div>
                                <div class="dish-price">Â¥${price.toFixed(2)}</div>
                                <div class="dish-controls">
                                    <div class="quantity-controls">
                                        <button class="quantity-btn" onclick="updateDishQuantity(${dishID}, ${quantity - 1})" ${quantity === 0 ? 'disabled' : ''}>-</button>
                                        <input type="number" class="quantity-input" value="${quantity}" min="0" max="99" 
                                               onchange="updateDishQuantity(${dishID}, parseInt(this.value) || 0)"
                                               id="quantity-${dishID}">
                                        <button class="quantity-btn" onclick="updateDishQuantity(${dishID}, ${quantity + 1})">+</button>
                                    </div>
                                    ${isSelected ? `<span style="color: #28a745; font-weight: 600;">å·²é€‰</span>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            console.log('èœå“ç½‘æ ¼æ¸²æŸ“å®Œæˆ');
        }

        function filterDishes() {
            renderDishesGrid();
        }

        function updateDishQuantity(dishId, newQuantity) {
            newQuantity = Math.max(0, Math.min(99, newQuantity)); // é™åˆ¶æ•°é‡èŒƒå›´

            const dish = availableDishes.find(d => (d.dishID || d.DISHID) === dishId);
            if (!dish) return;

            if (newQuantity === 0) {
                // ç§»é™¤èœå“
                selectedDishes.delete(dishId);
            } else {
                // æ·»åŠ æˆ–æ›´æ–°èœå“ï¼Œæ ‡å‡†åŒ–å­—æ®µå
                const standardizedDish = {
                    dishID: dish.dishID || dish.DISHID,
                    dishName: dish.dishName || dish.DISHNAME,
                    price: dish.price || dish.PRICE,
                    description: dish.description || dish.DESCRIPTION,
                    categoryID: dish.categoryID || dish.CATEGORYID
                };
                
                selectedDishes.set(dishId, {
                    dish: standardizedDish,
                    quantity: newQuantity,
                    specialRequests: ''
                });
            }

            // æ›´æ–°æ˜¾ç¤º
            renderDishesGrid();
            updateSelectedDishesDisplay();
        }

        function updateSelectedDishesDisplay() {
            const selectedSection = document.getElementById('selectedDishesSection');
            const selectedList = document.getElementById('selectedDishesList');
            const totalElement = document.getElementById('addDishTotal');
            const confirmBtn = document.getElementById('confirmAddDishBtn');

            if (selectedDishes.size === 0) {
                selectedSection.style.display = 'none';
                confirmBtn.disabled = true;
                return;
            }

            selectedSection.style.display = 'block';
            confirmBtn.disabled = false;

            let totalAmount = 0;
            let selectedHTML = '';

            selectedDishes.forEach((data, dishId) => {
                const { dish, quantity, specialRequests } = data;
                const subtotal = dish.price * quantity;
                totalAmount += subtotal;

                selectedHTML += `
                    <div class="selected-dish-item">
                        <div class="selected-dish-info">
                            <div class="selected-dish-name">${dish.dishName}</div>
                            <div class="selected-dish-details">
                                æ•°é‡: ${quantity} | å•ä»·: Â¥${dish.price.toFixed(2)}
                                ${specialRequests ? ` | å¤‡æ³¨: ${specialRequests}` : ''}
                            </div>
                        </div>
                        <div class="selected-dish-total">Â¥${subtotal.toFixed(2)}</div>
                        <button class="remove-dish-btn" onclick="removeDishFromSelection(${dishId})" title="ç§»é™¤">Ã—</button>
                    </div>
                `;
            });

            selectedList.innerHTML = selectedHTML;
            totalElement.textContent = `Â¥${totalAmount.toFixed(2)}`;
        }

        function removeDishFromSelection(dishId) {
            selectedDishes.delete(dishId);
            renderDishesGrid();
            updateSelectedDishesDisplay();
        }

        async function confirmAddSelectedDishes() {
            if (selectedDishes.size === 0) {
                Utils.showNotification('è¯·å…ˆé€‰æ‹©è¦åŠ çš„èœå“', 'warning');
                return;
            }

            if (!currentAddDishOrderId) {
                Utils.showNotification('è®¢å•ä¿¡æ¯å¼‚å¸¸ï¼Œè¯·é‡è¯•', 'error');
                return;
            }

            try {
                Utils.showNotification('æ­£åœ¨æ·»åŠ èœå“...', 'info');

                // å‡†å¤‡è¦æ·»åŠ çš„èœå“æ•°æ®ï¼Œä½¿ç”¨åç«¯æœŸæœ›çš„å­—æ®µå
                const dishesToAdd = [];
                selectedDishes.forEach((data, dishId) => {
                    const { dish, quantity, specialRequests } = data;
                    dishesToAdd.push({
                        DishID: dish.dishID,        // ä½¿ç”¨å¤§å†™D
                        Quantity: quantity,         // ä½¿ç”¨å¤§å†™Q
                        UnitPrice: dish.price,      // ä½¿ç”¨å¤§å†™U
                        SpecialRequests: specialRequests || null  // ä½¿ç”¨å¤§å†™S
                    });
                });

                console.log('å‡†å¤‡æ·»åŠ çš„èœå“æ•°æ®:', dishesToAdd);
                console.log('è®¢å•ID:', currentAddDishOrderId);

                // æ‰¹é‡æ·»åŠ èœå“åˆ°è®¢å•
                for (let i = 0; i < dishesToAdd.length; i++) {
                    const dishData = dishesToAdd[i];
                    console.log(`æ­£åœ¨æ·»åŠ ç¬¬${i + 1}é“èœå“:`, dishData);
                    
                    try {
                        const response = await API.post(`/orders/${currentAddDishOrderId}/details`, dishData);
                        console.log(`ç¬¬${i + 1}é“èœå“æ·»åŠ æˆåŠŸ:`, response);
                    } catch (dishError) {
                        console.error(`ç¬¬${i + 1}é“èœå“æ·»åŠ å¤±è´¥:`, dishError);
                        throw new Error(`æ·»åŠ  ${dishData.DishID} å·èœå“å¤±è´¥: ${dishError.message}`);
                    }
                }

                const totalItems = dishesToAdd.reduce((sum, d) => sum + d.Quantity, 0);
                Utils.showNotification(`æˆåŠŸæ·»åŠ  ${totalItems} é“èœå“ï¼`, 'success');

                // å…³é—­æ¨¡æ€æ¡†
                Utils.hideModal('addDishModal');

                // å¦‚æœæ¡Œå°è¯¦æƒ…æ¨¡æ€æ¡†è¿˜å¼€ç€ï¼Œéœ€è¦åˆ·æ–°å†…å®¹
                const tableModal = document.getElementById('tableModal');
                if (tableModal.style.display === 'block') {
                    // é‡æ–°æ˜¾ç¤ºæ¡Œå°è¯¦æƒ…
                    const table = tables.find(t => t.tableID === currentTableId);
                    if (table) {
                        await showTableDetails(table);
                    }
                }

                // æ¸…ç©ºé€‰æ‹©
                selectedDishes.clear();
                currentAddDishOrderId = null;

            } catch (error) {
                console.error('æ·»åŠ èœå“å¤±è´¥:', error);
                let errorMessage = 'æ·»åŠ èœå“å¤±è´¥';
                
                if (error.response) {
                    console.error('APIé”™è¯¯å“åº”:', error.response);
                    if (error.response.status === 404) {
                        errorMessage = 'è®¢å•ä¸å­˜åœ¨æˆ–å·²ç»“è´¦';
                    } else if (error.response.status === 400) {
                        errorMessage = 'èœå“ä¿¡æ¯æœ‰è¯¯ï¼Œè¯·é‡è¯•';
                    } else if (error.response.status === 500) {
                        errorMessage = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                    } else {
                        errorMessage = `æ·»åŠ å¤±è´¥ (é”™è¯¯ç : ${error.response.status})`;
                    }
                } else if (error.message) {
                    errorMessage = `æ·»åŠ å¤±è´¥: ${error.message}`;
                }
                
                Utils.showNotification(errorMessage, 'error');
            }
        }

        async function createNewOrder(tableId) {
            try {
                // æ˜¾ç¤ºåˆ›å»ºä¸­çŠ¶æ€
                Utils.showNotification('æ­£åœ¨åˆ›å»ºè®¢å•...', 'info');

                // è·å–å‘˜å·¥åˆ—è¡¨ç”¨äºåˆ›å»ºè®¢å•
                if (staff.length === 0) {
                    await loadStaff();
                }

                // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯æˆ–ä½¿ç”¨é»˜è®¤å‘˜å·¥
                const currentUser = Auth.getCurrentUser();
                let selectedStaffId = null;

                if (currentUser && currentUser.staffID) {
                    selectedStaffId = currentUser.staffID;
                } else {
                    const availableStaff = staff.find(s => s.status === 'åœ¨èŒ');
                    if (availableStaff) {
                        selectedStaffId = availableStaff.staffID;
                    }
                }

                if (!selectedStaffId) {
                    Utils.showNotification('æ²¡æœ‰å¯ç”¨çš„æœåŠ¡å‘˜ï¼Œè¯·å…ˆæ·»åŠ å‘˜å·¥', 'warning');
                    return;
                }

                // åˆ›å»ºè®¢å•æ•°æ®
                const orderData = {
                    tableID: tableId,
                    customerID: null, // ç°åœºå®¢æˆ·ï¼Œæ— éœ€å®¢æˆ·ID
                    staffID: selectedStaffId,
                    orderTime: new Date().toISOString(),
                    totalAmount: 0, // åˆå§‹é‡‘é¢ä¸º0ï¼Œåç»­é€šè¿‡ç‚¹èœå¢åŠ 
                    orderStatus: 'å¾…å¤„ç†', // æ ¹æ®è¡¨è®¾è®¡æ–‡æ¡£ï¼Œæ–°è®¢å•çŠ¶æ€ä¸º"å¾…å¤„ç†"
                    notes: `æ¡Œå°${tables.find(t => t.tableID === tableId)?.tableNumber || tableId}å¼€å°`
                };

                console.log('åˆ›å»ºè®¢å•æ•°æ®:', orderData);

                // è°ƒç”¨APIåˆ›å»ºè®¢å•
                const result = await API.post('/orders', orderData);
                
                if (result && (result.orderID || result.id)) {
                    const orderId = result.orderID || result.id;
                    Utils.showNotification(`è®¢å•åˆ›å»ºæˆåŠŸï¼è®¢å•å·: #${orderId}`, 'success');
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    Utils.hideModal('tableModal');
                    
                    // åˆ·æ–°æ¡Œå°çŠ¶æ€ä»¥æ›´æ–°è®¢å•ä¿¡æ¯
                    await loadTables();
                    
                    // å¯é€‰ï¼šè‡ªåŠ¨è·³è½¬åˆ°ç‚¹èœé¡µé¢
                    // window.location.href = `menu.html?orderId=${orderId}&tableId=${tableId}`;
                } else {
                    throw new Error('åˆ›å»ºè®¢å•è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸');
                }

            } catch (error) {
                console.error('åˆ›å»ºè®¢å•å¤±è´¥:', error);
                let errorMessage = 'åˆ›å»ºè®¢å•å¤±è´¥';
                
                if (error.response) {
                    // APIè¿”å›çš„é”™è¯¯
                    if (error.response.status === 400) {
                        errorMessage = 'è®¢å•æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥';
                    } else if (error.response.status === 500) {
                        errorMessage = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                    } else {
                        errorMessage = `åˆ›å»ºè®¢å•å¤±è´¥ (é”™è¯¯ç : ${error.response.status})`;
                    }
                } else if (error.message) {
                    errorMessage = `åˆ›å»ºè®¢å•å¤±è´¥: ${error.message}`;
                }
                
                Utils.showNotification(errorMessage, 'error');
            }
        }

        async function refreshTables() {
            Utils.showNotification('æ­£åœ¨åˆ·æ–°...', 'info');
            await loadTables();
            Utils.showNotification('åˆ·æ–°å®Œæˆ', 'success');
        }
    </script>
</body>
</html>
