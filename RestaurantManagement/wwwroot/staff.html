<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>员工管理 - 餐饮管理系统</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- SheetJS库用于Excel导出 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <h1>餐饮管理系统</h1>
        <div class="nav-links">
            <a href="index.html">首页</a>
            <a href="tables.html">桌台管理</a>
            <a href="orders.html">订单管理</a>
            <a href="menu.html">菜单管理</a>
            <a href="staff.html" class="active">员工管理</a>
            <a href="inventory.html">库存管理</a>
        </div>
    </nav>

    <div class="container">
        <div class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2>员工管理</h2>
                <div>
                    <button onclick="showAddStaffModal()" class="btn btn-primary" data-permission="staff">添加员工</button>
                    <button onclick="generateStatistics()" class="btn btn-info">生成统计</button>
                </div>
            </div>

            <!-- Tab 导航 -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('staff')">员工管理</button>
                <button class="tab-btn" onclick="switchTab('attendance')">考勤记录</button>
                <button class="tab-btn" onclick="switchTab('statistics')">考勤统计</button>
                <button class="tab-btn" onclick="switchTab('schedule')">排班管理</button>
            </div>

            <!-- 统计卡片 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-staff">0</div>
                    <div class="stat-label">员工总数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-staff">0</div>
                    <div class="stat-label">在职员工</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="today-attendance">0</div>
                    <div class="stat-label">今日出勤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="today-late">0</div>
                    <div class="stat-label">今日迟到</div>
                </div>
            </div>

            <!-- 员工管理Tab -->
            <div id="staffTab" class="tab-content active">
                <!-- 搜索和过滤器 -->
                <div class="card">
                    <h3>员工筛选</h3>
                    <div class="search-filters">
                        <div class="form-group">
                            <label for="departmentFilter">部门筛选:</label>
                            <select id="departmentFilter" class="form-control" onchange="filterStaff()">
                                <option value="all">全部部门</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="storeFilter">门店筛选:</label>
                            <select id="storeFilter" class="form-control" onchange="filterStaff()">
                                <option value="all">全部门店</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="positionFilter">职位筛选:</label>
                            <select id="positionFilter" class="form-control" onchange="filterStaff()">
                                <option value="all">全部职位</option>
                                <option value="服务员">服务员</option>
                                <option value="厨师">厨师</option>
                                <option value="收银员">收银员</option>
                                <option value="经理">经理</option>
                                <option value="清洁员">清洁员</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="statusFilter">在职状态:</label>
                            <select id="statusFilter" class="form-control" onchange="filterStaff()">
                                <option value="all">全部状态</option>
                                <option value="在职">在职</option>
                                <option value="离职">离职</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="staffSearch">员工搜索:</label>
                            <input type="text" id="staffSearch" class="form-control" placeholder="输入员工姓名" onkeyup="filterStaff()">
                        </div>
                    </div>
                </div>

                <!-- 员工列表 -->
                <div class="card">
                    <h3>员工列表</h3>
                    <div class="staff-info-bar">
                        <span id="staffCount">共 0 名员工</span>
                        <div class="page-size-selector">
                            <label for="pageSize">每页显示:</label>
                            <select id="pageSize" class="form-control" onchange="changePageSize()">
                                <option value="5" selected>5条</option>
                                <option value="10">10条</option>
                                <option value="20">20条</option>
                                <option value="50">50条</option>
                                <option value="100">100条</option>
                            </select>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="table" id="staffTable">
                            <thead>
                                <tr>
                                    <th>员工ID</th>
                                    <th>姓名</th>
                                    <th>职位</th>
                                    <th>部门</th>
                                    <th>门店</th>
                                    <th>电话</th>
                                    <th>薪资</th>
                                    <th>状态</th>
                                    <th>入职日期</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="staffTableBody">
                                <!-- 员工数据将通过JavaScript动态填充 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页控件 -->
                    <div class="pagination-container">
                        <div class="pagination-info">
                            <span id="paginationInfo">显示第 1-10 条，共 0 条记录</span>
                        </div>
                        <div class="pagination-controls">
                            <button id="firstPageBtn" onclick="goToPage(1)" class="btn btn-sm btn-outline-secondary" disabled>
                                <i class="fas fa-angle-double-left"></i> 首页
                            </button>
                            <button id="prevPageBtn" onclick="goToPrevPage()" class="btn btn-sm btn-outline-secondary" disabled>
                                <i class="fas fa-angle-left"></i> 上一页
                            </button>
                            <div class="page-numbers" id="pageNumbers">
                                <!-- 页码按钮将通过JavaScript动态生成 -->
                            </div>
                            <button id="nextPageBtn" onclick="goToNextPage()" class="btn btn-sm btn-outline-secondary">
                                下一页 <i class="fas fa-angle-right"></i>
                            </button>
                            <button id="lastPageBtn" onclick="goToLastPage()" class="btn btn-sm btn-outline-secondary">
                                末页 <i class="fas fa-angle-double-right"></i>
                            </button>
                        </div>
                        <div class="page-jump">
                            <span>跳转到第</span>
                            <input type="number" id="pageJumpInput" class="form-control" min="1" style="width: 60px;">
                            <span>页</span>
                            <button onclick="jumpToPage()" class="btn btn-sm btn-primary">跳转</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 考勤记录Tab -->
            <div id="attendanceTab" class="tab-content">
                <!-- 打卡签到区域 -->
                <div class="card">
                    <h3>员工打卡</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="quickCheckStaff">选择员工：</label>
                                <select id="quickCheckStaff" class="form-control">
                                    <option value="">请选择员工</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <div class="attendance-actions">
                                    <button onclick="quickCheckIn()" class="btn btn-success btn-lg">
                                        <i class="fas fa-sign-in-alt"></i> 签到
                                    </button>
                                    <button onclick="quickCheckOut()" class="btn btn-warning btn-lg">
                                        <i class="fas fa-sign-out-alt"></i> 签退
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="today-schedule">
                                <h4>今日排班信息</h4>
                                <div id="todayScheduleInfo" class="schedule-info">
                                    <p>请先选择员工查看排班信息</p>
                                </div>
                            </div>
                            <div class="current-status">
                                <h4>当前状态</h4>
                                <div id="currentStatusInfo" class="status-info">
                                    <p>暂无打卡记录</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 考勤筛选 -->
                <div class="card">
                    <h3>考勤记录查询</h3>
                    <div class="filters-enhanced">
                        <div class="filter-group">
                            <label>开始日期：</label>
                            <input type="date" id="attendanceStartDate" class="form-control">
                        </div>
                        <div class="filter-group">
                            <label>结束日期：</label>
                            <input type="date" id="attendanceEndDate" class="form-control">
                        </div>
                        <div class="filter-group">
                            <label>员工：</label>
                            <select id="attendanceStaffFilter" class="form-control">
                                <option value="">所有员工</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>员工姓名：</label>
                            <input type="text" id="staffNameFilter" class="form-control" placeholder="输入员工姓名搜索">
                        </div>
                        <div class="filter-group">
                            <label>状态筛选：</label>
                            <select id="attendanceStatusFilter" class="form-control">
                                <option value="">全部状态</option>
                                <option value="正常">正常</option>
                                <option value="迟到">迟到</option>
                                <option value="早退">早退</option>
                                <option value="缺勤">缺勤</option>
                            </select>
                        </div>
                        <div class="filter-actions">
                            <button onclick="loadAttendanceRecords()" class="btn btn-primary">
                                <i class="fas fa-search"></i> 查询
                            </button>
                            <button onclick="resetAttendanceFilter()" class="btn btn-secondary">
                                <i class="fas fa-undo"></i> 重置
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 考勤记录列表 -->
                <div class="card">
                    <h3>考勤记录</h3>
                    
                    <!-- 考勤记录信息栏 -->
                    <div class="staff-info-bar">
                        <div class="records-info">
                            <span id="recordsCount">共 0 条记录</span>
                        </div>
                        <div class="page-size-selector">
                            <label for="attendancePageSize">每页显示:</label>
                            <select id="attendancePageSize" onchange="changeAttendancePageSize()" class="form-control">
                                <option value="5">5条</option>
                                <option value="10" selected>10条</option>
                                <option value="20">20条</option>
                                <option value="50">50条</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="table" id="attendanceTable">
                            <thead>
                                <tr>
                                    <th>员工姓名</th>
                                    <th>部门</th>
                                    <th>工作日期</th>
                                    <th>签到时间</th>
                                    <th>签退时间</th>
                                    <th>工作时长</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">暂无数据</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 考勤记录分页控件 -->
                    <div class="pagination-container">
                        <div class="pagination-info" id="attendancePaginationInfo">
                            显示第 1-10 条，共 0 条记录
                        </div>
                        <div class="pagination-controls">
                            <button id="attendanceFirstPageBtn" onclick="goToAttendanceFirstPage()" class="btn btn-sm btn-outline-secondary">首页</button>
                            <button id="attendancePrevPageBtn" onclick="goToAttendancePrevPage()" class="btn btn-sm btn-outline-secondary">上一页</button>
                            <div class="page-numbers" id="attendancePageNumbers"></div>
                            <button id="attendanceNextPageBtn" onclick="goToAttendanceNextPage()" class="btn btn-sm btn-outline-secondary">下一页</button>
                            <button id="attendanceLastPageBtn" onclick="goToAttendanceLastPage()" class="btn btn-sm btn-outline-secondary">末页</button>
                        </div>
                        <div class="page-jump">
                            <span>跳转到第</span>
                            <input type="number" id="attendancePageJumpInput" min="1" style="width: 60px;" class="form-control">
                            <span>页</span>
                            <button onclick="jumpToAttendancePage()" class="btn btn-sm btn-primary">跳转</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 考勤统计Tab -->
            <div id="statisticsTab" class="tab-content">
                <!-- 统计筛选 -->
                <div class="card">
                    <h3>统计条件</h3>
                    <div class="search-filters">
                        <div class="form-group">
                            <label for="statsStartDate">开始日期:</label>
                            <input type="date" id="statsStartDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="statsEndDate">结束日期:</label>
                            <input type="date" id="statsEndDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="statsDepartmentFilter">部门筛选:</label>
                            <select id="statsDepartmentFilter" class="form-control">
                                <option value="">全部部门</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 统计结果 -->
                <div class="card">
                    <h3>考勤统计报表</h3>
                    <div style="overflow-x: auto;">
                        <table class="table" id="statisticsTable">
                            <thead>
                                <tr>
                                    <th>员工姓名</th>
                                    <th>部门</th>
                                    <th>总出勤天数</th>
                                    <th>正常天数</th>
                                    <th>迟到天数</th>
                                    <th>早退天数</th>
                                    <th>缺勤天数</th>
                                    <th>总工时</th>
                                    <th>平均工时</th>
                                    <th>出勤率</th>
                                </tr>
                            </thead>
                            <tbody id="statisticsTableBody">
                                <!-- 统计数据将通过JavaScript动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 排班管理Tab -->
            <div id="scheduleTab" class="tab-content">
                <div class="card">
                    <h3>排班管理</h3>
                    <div id="calendar-view" style="min-height:300px;"></div>
                    <button onclick="showAddScheduleModal()" class="btn btn-primary" style="margin-top:1rem;">新增排班</button>
                </div>
            </div>

            <!-- 新增/编辑排班模态框 -->
            <div id="addScheduleModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="scheduleModalTitle">新增排班</h3>
                        <span class="close" onclick="Utils.hideModal('addScheduleModal')">&times;</span>
                    </div>
                    <form id="scheduleForm">
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="scheduleStaff">员工</label>
                                    <select id="scheduleStaff" required>
                                        <option value="">请选择员工</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="scheduleDate">工作星期</label>
                                    <select id="scheduleDate" required>
                                        <option value="">请选择星期</option>
                                        <option value="1">周一</option>
                                        <option value="2">周二</option>
                                        <option value="3">周三</option>
                                        <option value="4">周四</option>
                                        <option value="5">周五</option>
                                        <option value="6">周六</option>
                                        <option value="7">周日</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="scheduleStartTime">开始时间</label>
                                    <input type="time" id="scheduleStartTime" required>
                                </div>
                                <div class="form-group">
                                    <label for="scheduleEndTime">结束时间</label>
                                    <input type="time" id="scheduleEndTime" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="scheduleNotes">备注</label>
                                <textarea id="scheduleNotes" rows="3" placeholder="请输入备注信息"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" onclick="Utils.hideModal('addScheduleModal')" class="btn btn-secondary">取消</button>
                            <button type="submit" class="btn btn-primary">保存</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 编辑考勤记录模态框 -->
            <div id="editAttendanceModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>编辑考勤记录</h3>
                        <span class="close" onclick="Utils.hideModal('editAttendanceModal')">&times;</span>
                    </div>
                    <form id="attendanceForm">
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="attendanceStaffName">员工姓名:</label>
                                    <input type="text" id="attendanceStaffName" class="form-control" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="attendanceWorkDate">工作日期:</label>
                                    <input type="date" id="attendanceWorkDate" class="form-control" readonly>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="attendanceCheckInTime">签到时间:</label>
                                    <input type="time" id="attendanceCheckInTime" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="attendanceCheckOutTime">签退时间:</label>
                                    <input type="time" id="attendanceCheckOutTime" class="form-control">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="attendanceStatus">考勤状态:</label>
                                    <select id="attendanceStatus" class="form-control" required>
                                        <option value="正常">正常</option>
                                        <option value="迟到">迟到</option>
                                        <option value="早退">早退</option>
                                        <option value="缺勤">缺勤</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="attendanceWorkHours">工作时长(小时):</label>
                                    <input type="number" id="attendanceWorkHours" class="form-control" step="0.1" min="0">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" onclick="Utils.hideModal('editAttendanceModal')" class="btn btn-secondary">取消</button>
                            <button type="submit" class="btn btn-primary">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑员工模态框 -->
    <div id="addStaffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="staffModalTitle">添加员工</h3>
                <span class="close">&times;</span>
            </div>
            <form id="staffForm">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="staffName">员工姓名:</label>
                            <input type="text" id="staffName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="staffGender">性别:</label>
                            <select id="staffGender" class="form-control" required>
                                <option value="">请选择性别</option>
                                <option value="M">男</option>
                                <option value="F">女</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="staffPosition">职位:</label>
                            <select id="staffPosition" class="form-control" required>
                                <option value="">请选择职位</option>
                                <option value="服务员">服务员</option>
                                <option value="厨师">厨师</option>
                                <option value="收银员">收银员</option>
                                <option value="经理">经理</option>
                                <option value="清洁员">清洁员</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="staffEmail">邮箱:</label>
                            <input type="email" id="staffEmail" class="form-control" placeholder="可选">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="staffPhone">联系电话:</label>
                            <input type="tel" id="staffPhone" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="staffSalary">薪资(元/月):</label>
                            <input type="number" id="staffSalary" class="form-control" min="0" step="100" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="staffDepartment">所属部门:</label>
                            <select id="staffDepartment" class="form-control" required>
                                <option value="">请选择部门</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="staffStore">所属门店:</label>
                            <select id="staffStore" class="form-control" required>
                                <option value="">请选择门店</option>
                            </select>
                        </div>
                     </div>
                    <div class="form-group">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="Utils.hideModal('addStaffModal')" class="btn btn-secondary">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 员工详情模态框 -->
    <div id="staffDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="staffDetailTitle">员工详情</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="staffDetailBody">
                <!-- 员工详情内容将通过JavaScript动态填充 -->
            </div>
            <div class="modal-footer">
                <button onclick="Utils.hideModal('staffDetailModal')" class="btn btn-secondary">关闭</button>
                <button id="editStaffBtn" onclick="editCurrentStaff()" class="btn btn-primary">编辑</button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // 排班管理功能实现
        // 加载员工列表到排班表单
        function populateScheduleStaffSelect() {
            const select = document.getElementById('scheduleStaff');
            select.innerHTML = '';
            allStaff.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.StaffID || staff.staffID || staff.STAFFID;
                option.textContent = staff.StaffName || staff.staffName || staff.STAFFNAME;
                select.appendChild(option);
            });
        }

        // 显示新增排班模态框
        function showAddScheduleModal() {
            currentScheduleId = null; // 重置为新增模式
            document.getElementById('scheduleModalTitle').textContent = '新增排班';
            Utils.resetForm(document.getElementById('scheduleForm'));
            populateScheduleStaffSelect();
            Utils.showModal('addScheduleModal');
        }

        // 排班表单提交
        document.addEventListener('DOMContentLoaded', function() {
            const scheduleForm = document.getElementById('scheduleForm');
            if (scheduleForm) {
                scheduleForm.onsubmit = async function(e) {
                    e.preventDefault();
                    
                    // 获取表单数据
                    const staffId = document.getElementById('scheduleStaff').value;
                    const workDate = document.getElementById('scheduleDate').value; // 1-7星期几
                    const startTime = document.getElementById('scheduleStartTime').value;
                    const endTime = document.getElementById('scheduleEndTime').value;
                    const notes = document.getElementById('scheduleNotes').value;
                    
                    // 验证必填字段
                    if (!staffId || !workDate || !startTime || !endTime) {
                        Utils.showNotification('请填写完整的排班信息', 'warning');
                        return;
                    }
                    
                    // 获取选中员工的门店ID
                    const selectedStaff = allStaff.find(s => 
                        (s.StaffID || s.staffID || s.STAFFID) == staffId
                    );
                    const storeId = selectedStaff ? 
                        (selectedStaff.StoreID || selectedStaff.storeID || selectedStaff.STOREID) : null;
                    
                    if (!storeId) {
                        Utils.showNotification('无法获取员工所属门店信息', 'error');
                        return;
                    }
                    
                    const data = {
                        staffID: parseInt(staffId),
                        workDate: parseInt(workDate), // 1-7星期几
                        startTime: startTime + ':00', // 确保时间格式为 HH:MM:SS
                        endTime: endTime + ':00',
                        storeID: parseInt(storeId),
                        notes: notes || null
                    };
                    
                    try {
                        if (currentScheduleId) {
                            // 编辑模式 - 使用PUT请求
                            await API.put(`/schedule/${currentScheduleId}`, data);
                            Utils.showNotification('排班已更新', 'success');
                            currentScheduleId = null; // 重置编辑状态
                        } else {
                            // 新增模式 - 使用POST请求
                            await API.post('/schedule', data);
                            Utils.showNotification('排班已保存', 'success');
                        }
                        Utils.hideModal('addScheduleModal');
                        await loadScheduleCalendar();
                    } catch (error) {
                        console.error('保存排班失败:', error);
                        Utils.showNotification('保存排班失败', 'error');
                    }
                }
            }
        });

        // 加载排班日历
        async function loadScheduleCalendar() {
            const calendar = document.getElementById('calendar-view');
            allSchedules = await API.get('/schedule');
            if (!allSchedules || allSchedules.length === 0) {
                calendar.innerHTML = `<div style='text-align:center;color:#888;padding:2rem;'>暂无排班数据<br>请点击“新增排班”按钮添加员工排班。</div>`;
                return;
            }
            // 生成排班视图（按星期显示）
            const weekDays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
            
            let html = `<div style='overflow-x:auto;'>
                <table class='table' style='min-width:600px;'>
                    <thead>
                        <tr>
                            <th>星期</th>
                            <th>员工</th>
                            <th>门店</th>
                            <th>班次时间</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            for (let day = 1; day <= 7; day++) {
                const dayName = weekDays[day - 1];
                
                // 找出该星期几的所有排班
                const daySchedules = Array.isArray(allSchedules) ? allSchedules.filter(sch => {
                    const schDay = sch.WORKDATE || sch.workDate || sch.WorkDate;
                    return schDay == day;
                }) : [];
                
                if (!daySchedules || daySchedules.length === 0) {
                    html += `<tr><td>${dayName}</td><td colspan='5' style='color:#aaa;'>无排班</td></tr>`;
                } else {
                    daySchedules.forEach(sch => {
                        // 处理时间格式
                        const startTime = formatIntervalTime(sch.STARTTIME || sch.startTime || sch.StartTime);
                        const endTime = formatIntervalTime(sch.ENDTIME || sch.endTime || sch.EndTime);
                        
                        html += `<tr>
                            <td>${dayName}</td>
                            <td>${sch.STAFFNAME || sch.staffName || sch.StaffName || '-'}</td>
                            <td>${sch.STORENAME || sch.storeName || sch.StoreName || '-'}</td>
                            <td>${startTime} ~ ${endTime}</td>
                            <td>${sch.NOTES || sch.notes || sch.Notes || ''}</td>
                            <td>
                                <button onclick="editSchedule(${sch.SCHEDULEID || sch.scheduleId || sch.ScheduleID})" 
                                        class="btn btn-sm btn-secondary" style="margin-right: 0.25rem;">编辑</button>
                                <button onclick="deleteSchedule(${sch.SCHEDULEID || sch.scheduleId || sch.ScheduleID})" 
                                        class="btn btn-sm btn-danger">删除</button>
                            </td>
                        </tr>`;
                    });
                }
            }
            html += '</tbody></table></div>';
            calendar.innerHTML = html;
        }

        // 格式化 Oracle INTERVAL DAY TO SECOND 时间
        function formatIntervalTime(intervalStr) {
            if (!intervalStr) return '-';
            // 如果是 "0 08:30:00.000000" 格式，提取时间部分
            if (typeof intervalStr === 'string' && intervalStr.includes(' ')) {
                const parts = intervalStr.split(' ');
                if (parts.length >= 2) {
                    return parts[1].substring(0, 5); // 取 HH:MM 部分
                }
            }
            // 如果是标准时间格式，直接返回前5位
            return intervalStr.toString().substring(0, 5);
        }

        // 编辑排班
        async function editSchedule(scheduleId) {
            try {
                // 从allSchedules中找到要编辑的排班记录
                const schedule = allSchedules.find(s => 
                    (s.SCHEDULEID || s.scheduleId || s.ScheduleID) === scheduleId
                );
                
                if (!schedule) {
                    Utils.showNotification('未找到排班记录', 'error');
                    return;
                }
                
                // 设置为编辑模式
                currentScheduleId = scheduleId;
                document.getElementById('scheduleModalTitle').textContent = '编辑排班';
                
                // 填充表单数据
                populateScheduleStaffSelect();
                document.getElementById('scheduleStaff').value = schedule.STAFFID || schedule.staffId || schedule.StaffID;
                document.getElementById('scheduleDate').value = schedule.WORKDATE || schedule.workDate || schedule.WorkDate;
                
                // 处理时间格式
                const startTime = formatTimeForInput(schedule.STARTTIME || schedule.startTime || schedule.StartTime);
                const endTime = formatTimeForInput(schedule.ENDTIME || schedule.endTime || schedule.EndTime);
                
                document.getElementById('scheduleStartTime').value = startTime;
                document.getElementById('scheduleEndTime').value = endTime;
                document.getElementById('scheduleNotes').value = schedule.NOTES || schedule.notes || schedule.Notes || '';
                
                Utils.showModal('addScheduleModal');
                
            } catch (error) {
                console.error('编辑排班失败:', error);
                Utils.showNotification('编辑排班失败', 'error');
            }
        }

        // 格式化时间为input[type="time"]所需的格式
        function formatTimeForInput(timeStr) {
            if (!timeStr) return '';
            
            // 如果是 "0 08:30:00.000000" 格式，提取时间部分
            if (typeof timeStr === 'string' && timeStr.includes(' ')) {
                const parts = timeStr.split(' ');
                if (parts.length >= 2) {
                    return parts[1].substring(0, 5); // 取 HH:MM 部分
                }
            }
            
            // 如果是标准时间格式，返回前5位
            return timeStr.toString().substring(0, 5);
        }

        // 删除排班
        async function deleteSchedule(scheduleId) {
            if (!confirm('确定要删除这个排班吗？')) return;
            
            try {
                await API.delete(`/schedule/${scheduleId}`);
                Utils.showNotification('排班已删除', 'success');
                await loadScheduleCalendar();
            } catch (error) {
                console.error('删除排班失败:', error);
                Utils.showNotification('删除排班失败', 'error');
            }
        }

        // Tab切换功能（合并版本，包含排班管理）
        function switchTab(tabName) {
            // 移除所有活跃状态
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // 添加活跃状态
            const tabBtn = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (tabBtn) tabBtn.classList.add('active');
            const tabContent = document.getElementById(tabName + 'Tab');
            if (tabContent) tabContent.classList.add('active');
            
            currentTab = tabName;
            
            // 根据Tab加载相应数据
            if (tabName === 'attendance') {
                loadAttendanceRecords();
            } else if (tabName === 'statistics') {
                loadAttendanceStatistics();
            } else if (tabName === 'schedule') {
                loadScheduleCalendar();
            }
        }
    </script>
    <script>
        let allStaff = [];
        let filteredStaff = [];
        let attendanceRecords = [];
        let allAttendanceRecords = []; // 存储所有考勤记录用于编辑
        let currentStaffId = null;
        let allDepartments = [];
        let allStores = [];
        let currentTab = 'staff';
        let allSchedules = [];
        let currentScheduleId = null;
        let currentAttendanceId = null;

        // 分页相关变量
        let currentPage = 1;
        let pageSize = 5; // 改为5条以便测试分页效果
        let totalPages = 1;
        let totalRecords = 0;

        // 考勤记录分页相关变量
        let attendanceCurrentPage = 1;
        let attendancePageSize = 10;
        let attendanceTotalPages = 1;
        let attendanceTotalRecords = 0;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            setupEventListeners();
            setDefaultDates();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        });

        // 按正确顺序加载数据
        async function initializeData() {
            console.log('开始初始化数据...');
            try {
                // 先加载部门和门店数据
                await loadDepartmentsAndStores();
                // 然后加载员工数据并渲染
                await loadStaff();
                console.log('数据初始化完成');
            } catch (error) {
                console.error('初始化数据失败:', error);
                Utils.showNotification('初始化数据失败', 'error');
            }
        }

        function setupEventListeners() {
            // 员工表单提交
            document.getElementById('staffForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleStaffSubmit();
            });
            
            // 考勤记录表单提交
            document.getElementById('attendanceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleAttendanceSubmit();
            });
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = now.toLocaleString('zh-CN');
            }
        }

        function setDefaultDates() {
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            const monthAgo = new Date(today);
            monthAgo.setMonth(today.getMonth() - 1);

            // 考勤记录默认查询最近一周
            const attendanceStartDate = document.getElementById('attendanceStartDate');
            const attendanceEndDate = document.getElementById('attendanceEndDate');
            if (attendanceStartDate) attendanceStartDate.value = weekAgo.toISOString().split('T')[0];
            if (attendanceEndDate) attendanceEndDate.value = today.toISOString().split('T')[0];

            // 统计默认查询最近一个月
            const statsStartDate = document.getElementById('statsStartDate');
            const statsEndDate = document.getElementById('statsEndDate');
            if (statsStartDate) statsStartDate.value = monthAgo.toISOString().split('T')[0];
            if (statsEndDate) statsEndDate.value = today.toISOString().split('T')[0];
        }

        async function loadStaff() {
            console.log('开始加载员工数据...');
            try {
                console.log('正在调用API: /staff');
                allStaff = await API.get('/staff');
                console.log('员工数据加载成功:', allStaff);
                console.log('员工数量:', allStaff.length);
                
                if (allStaff.length > 0) {
                    console.log('第一个员工数据:', allStaff[0]);
                    // 检查员工状态
                    const activeStaff = allStaff.filter(s => (s.Status || s.status || s.STATUS) === '在职');
                    console.log('在职员工数量:', activeStaff.length);
                    if (activeStaff.length > 0) {
                        console.log('第一个在职员工:', activeStaff[0]);
                    }
                }
                
                filteredStaff = [...allStaff];
                renderStaffTable();
                populateFilterSelects(); // 使用统一的函数填充员工相关选择器
                updateStatistics();
            } catch (error) {
                console.error('加载员工数据失败:', error);
                console.error('错误详情:', error.message);
                Utils.showNotification('加载员工数据失败: ' + error.message, 'error');
            }
        }

        function renderStaffTable() {
            const tbody = document.getElementById('staffTableBody');
            tbody.innerHTML = '';

            // 更新总记录数
            totalRecords = filteredStaff.length;
            totalPages = Math.ceil(totalRecords / pageSize);
            
            // 更新员工数量显示
            updateStaffCount();

            if (filteredStaff.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666;">暂无员工数据</td></tr>';
                updatePaginationControls();
                return;
            }

            // 计算当前页的数据范围
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredStaff.length);
            const pageData = filteredStaff.slice(startIndex, endIndex);

            pageData.forEach(staff => {
                const row = document.createElement('tr');
                
                // 获取状态，确保字段名兼容性
                const staffStatus = staff.Status || staff.status || staff.STATUS || '在职';
                const statusInfo = Utils.getStatusInfo(staffStatus, 'staff');
                
                // 获取部门名称 - 统一使用大写字段名匹配
                const staffDeptId = staff.DepartmentID || staff.departmentID || staff.DEPARTMENTID;
                const department = allDepartments.find(d => {
                    const deptId = d.DepartmentID || d.departmentID || d.DEPARTMENTID;
                    return deptId === staffDeptId;
                });
                const departmentName = department ? (department.DepartmentName || department.departmentName || department.DEPARTMENTNAME || '未知部门') : '未知部门';
                
                // 获取门店名称 - 统一使用大写字段名匹配  
                const staffStoreId = staff.StoreID || staff.storeID || staff.STOREID;
                const store = allStores.find(s => {
                    const storeId = s.StoreID || s.storeID || s.STOREID;
                    return storeId === staffStoreId;
                });
                const storeName = store ? (store.StoreName || store.storeName || store.STORENAME || '未知门店') : '未知门店';
                
                row.innerHTML = `
                    <td>${staff.StaffID || staff.staffID || staff.STAFFID || 'N/A'}</td>
                    <td>${staff.StaffName || staff.staffName || staff.STAFFNAME || '未知'}</td>
                    <td>${staff.Position || staff.position || staff.POSITION || '未设置'}</td>
                    <td>${departmentName}</td>
                    <td>${storeName}</td>
                    <td>${staff.Phone || staff.phone || staff.PHONE || '未设置'}</td>
                    <td>${Utils.formatCurrency(staff.Salary || staff.salary || staff.SALARY || 0)}</td>
                    <td><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></td>
                    <td>${Utils.formatDate(staff.HireDate || staff.hireDate || staff.HIREDATE)}</td>
                    <td>
                        <button onclick="viewStaffDetails(${staff.StaffID || staff.staffID || staff.STAFFID})" class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-right: 0.25rem;">详情</button>
                        <button onclick="editStaff(${staff.StaffID || staff.staffID || staff.STAFFID})" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-right: 0.25rem;">编辑</button>
                        ${staffStatus === '在职' ? `
                            <button onclick="toggleStaffStatus(${staff.StaffID || staff.staffID || staff.STAFFID}, '离职')" class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">离职</button>
                        ` : `
                            <button onclick="toggleStaffStatus(${staff.StaffID || staff.staffID || staff.STAFFID}, '在职')" class="btn btn-success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">复职</button>
                        `}
                        <button onclick="deleteStaff(${staff.StaffID || staff.staffID || staff.STAFFID})" class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">删除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // 更新分页控件
            updatePaginationControls();
        }

        function filterStaff() {
            const departmentFilter = document.getElementById('departmentFilter').value;
            const storeFilter = document.getElementById('storeFilter').value;
            const positionFilter = document.getElementById('positionFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const staffSearch = document.getElementById('staffSearch').value.trim().toLowerCase();

            filteredStaff = allStaff.filter(staff => {
                const staffDeptId = staff.DepartmentID || staff.departmentID || staff.DEPARTMENTID;
                const staffStoreId = staff.StoreID || staff.storeID || staff.STOREID;
                const staffPosition = staff.Position || staff.position || staff.POSITION;
                const staffStatus = staff.Status || staff.status || staff.STATUS;
                const staffName = staff.StaffName || staff.staffName || staff.STAFFNAME || '';
                
                const departmentMatch = departmentFilter === 'all' || staffDeptId == departmentFilter;
                const storeMatch = storeFilter === 'all' || staffStoreId == storeFilter;
                const positionMatch = positionFilter === 'all' || staffPosition === positionFilter;
                const statusMatch = statusFilter === 'all' || staffStatus === statusFilter;
                const nameMatch = !staffSearch || staffName.toLowerCase().includes(staffSearch);

                return departmentMatch && storeMatch && positionMatch && statusMatch && nameMatch;
            });

            // 筛选后重置到第一页
            currentPage = 1;
            renderStaffTable();
        }

        async function updateStatistics() {
            const totalStaff = allStaff.length;
            const activeStaff = allStaff.filter(s => (s.Status || s.status || s.STATUS) === '在职').length;

            document.getElementById('total-staff').textContent = totalStaff;
            document.getElementById('active-staff').textContent = activeStaff;

            // 获取今日出勤统计和迟到统计
            try {
                const today = new Date().toISOString().split('T')[0];
                const todayAttendance = await API.get(`/staff/attendance?startDate=${today}&endDate=${today}`);
                const todayLate = todayAttendance.filter(a => (a.StatusAnalysis || a.Status) === '迟到').length;
                
                document.getElementById('today-attendance').textContent = todayAttendance.length;
                document.getElementById('today-late').textContent = todayLate;
            } catch (error) {
                console.error('获取今日出勤统计失败:', error);
                document.getElementById('today-attendance').textContent = '-';
                document.getElementById('today-late').textContent = '-';
            }
        }

        // 分页相关函数
        function updateStaffCount() {
            const countElement = document.getElementById('staffCount');
            if (countElement) {
                countElement.textContent = `共 ${totalRecords} 名员工`;
            }
        }

        function updatePaginationControls() {
            // 更新分页信息
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, totalRecords);
            const paginationInfo = document.getElementById('paginationInfo');
            if (paginationInfo) {
                paginationInfo.textContent = `显示第 ${startIndex}-${endIndex} 条，共 ${totalRecords} 条记录`;
            }

            // 更新按钮状态
            const firstPageBtn = document.getElementById('firstPageBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const lastPageBtn = document.getElementById('lastPageBtn');
            const pageJumpInput = document.getElementById('pageJumpInput');

            if (firstPageBtn) firstPageBtn.disabled = currentPage === 1;
            if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
            if (nextPageBtn) nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            if (lastPageBtn) lastPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            if (pageJumpInput) pageJumpInput.max = totalPages;

            // 生成页码按钮
            generatePageNumbers();
        }

        function generatePageNumbers() {
            const pageNumbers = document.getElementById('pageNumbers');
            if (!pageNumbers) return;

            pageNumbers.innerHTML = '';

            if (totalPages <= 1) return;

            // 计算显示的页码范围
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // 调整开始页码
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // 添加页码按钮
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-secondary'}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pageNumbers.appendChild(pageBtn);
            }
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderStaffTable();
        }

        function goToPrevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderStaffTable();
            }
        }

        function goToNextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                renderStaffTable();
            }
        }

        function goToLastPage() {
            currentPage = totalPages;
            renderStaffTable();
        }

        function jumpToPage() {
            const pageInput = document.getElementById('pageJumpInput');
            const page = parseInt(pageInput.value);
            if (page && page >= 1 && page <= totalPages) {
                goToPage(page);
                pageInput.value = '';
            } else {
                Utils.showNotification('请输入有效的页码', 'warning');
            }
        }

        function changePageSize() {
            const pageSizeSelect = document.getElementById('pageSize');
            pageSize = parseInt(pageSizeSelect.value);
            currentPage = 1; // 重置到第一页
            renderStaffTable();
        }

        async function loadAttendanceStatistics() {
            try {
                const startDate = document.getElementById('statsStartDate').value;
                const endDate = document.getElementById('statsEndDate').value;
                const departmentId = document.getElementById('statsDepartmentFilter').value;
                
                let url = `/staff/attendance/statistics?startDate=${startDate}&endDate=${endDate}`;
                if (departmentId) {
                    url += `&departmentId=${departmentId}`;
                }
                
                const statistics = await API.get(url);
                renderStatisticsTable(statistics);
            } catch (error) {
                console.error('加载考勤统计失败:', error);
                Utils.showNotification('加载考勤统计失败', 'error');
            }
        }

        function renderStatisticsTable(statistics) {
            const tbody = document.getElementById('statisticsTableBody');
            tbody.innerHTML = '';

            if (statistics.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666;">暂无统计数据</td></tr>';
                return;
            }

            statistics.forEach(stat => {
                const row = document.createElement('tr');
                const attendanceRate = stat.TotalDays > 0 ? 
                    ((stat.TotalDays - stat.AbsentDays) / stat.TotalDays * 100).toFixed(1) : 0;
                
                // 获取部门名称
                const staff = allStaff.find(s => 
                    (s.StaffID || s.staffID || s.STAFFID) === stat.StaffID
                );
                const staffDeptId = staff ? (staff.DepartmentID || staff.departmentID || staff.DEPARTMENTID) : null;
                const department = allDepartments.find(d => 
                    (d.DepartmentID || d.departmentID || d.DEPARTMENTID) === staffDeptId
                );
                const departmentName = department ? 
                    (department.DepartmentName || department.departmentName || department.DEPARTMENTNAME) : '未知部门';
                
                row.innerHTML = `
                    <td>${stat.StaffName}</td>
                    <td>${departmentName}</td>
                    <td>${stat.TotalDays}</td>
                    <td>${stat.NormalDays}</td>
                    <td>${stat.LateDays}</td>
                    <td>${stat.EarlyLeaveDays}</td>
                    <td>${stat.AbsentDays}</td>
                    <td>${parseFloat(stat.TotalWorkHours || 0).toFixed(1)}小时</td>
                    <td>${parseFloat(stat.AverageWorkHours || 0).toFixed(1)}小时</td>
                    <td>
                        <span class="attendance-rate ${attendanceRate >= 95 ? 'excellent' : attendanceRate >= 85 ? 'good' : 'poor'}">
                            ${attendanceRate}%
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showAddStaffModal() {
            currentStaffId = null;
            document.getElementById('staffModalTitle').textContent = '添加员工';
            Utils.resetForm(document.getElementById('staffForm'));
            Utils.showModal('addStaffModal');
        }

        async function handleStaffSubmit() {
            if (!Utils.validateForm(document.getElementById('staffForm'))) {
                Utils.showNotification('请填写完整信息', 'warning');
                return;
            }

            try {
                const staffData = {
                    staffName: document.getElementById('staffName').value,
                    gender: document.getElementById('staffGender').value,
                    position: document.getElementById('staffPosition').value,
                    phone: document.getElementById('staffPhone').value,
                    email: document.getElementById('staffEmail').value || null,
                    salary: parseFloat(document.getElementById('staffSalary').value),
                    departmentID: parseInt(document.getElementById('staffDepartment').value),
                    storeID: parseInt(document.getElementById('staffStore').value),
                };

                // 验证必填字段
                if (!staffData.gender) {
                    Utils.showNotification('请选择性别', 'warning');
                    return;
                }
                
                if (!staffData.departmentID || !staffData.storeID) {
                    Utils.showNotification('请选择部门和门店', 'warning');
                    return;
                }

                if (currentStaffId) {
                    // 编辑员工时保持原有状态
                    const currentStaff = allStaff.find(s => (s.StaffID || s.staffID || s.STAFFID) === currentStaffId);
                    if (currentStaff) {
                        staffData.status = currentStaff.Status || currentStaff.status || currentStaff.STATUS || '在职';
                    }
                    staffData.staffID = currentStaffId;
                    await API.put(`/staff/${currentStaffId}`, staffData);
                    Utils.showNotification('员工信息更新成功', 'success');
                } else {
                    // 新增员工时设置默认状态
                    staffData.status = '在职';
                    await API.post('/staff', staffData);
                    Utils.showNotification('员工添加成功', 'success');
                }

                Utils.hideModal('addStaffModal');
                await loadStaff();

            } catch (error) {
                console.error('保存员工信息失败:', error);
                Utils.showNotification('保存员工信息失败', 'error');
            }
        }

        // 处理考勤记录表单提交
        async function handleAttendanceSubmit() {
            if (!Utils.validateForm(document.getElementById('attendanceForm'))) {
                Utils.showNotification('请填写完整信息', 'warning');
                return;
            }

            if (!currentAttendanceId) {
                Utils.showNotification('缺少考勤记录ID', 'error');
                return;
            }

            try {
                const workDate = document.getElementById('attendanceWorkDate').value;
                const checkInTime = document.getElementById('attendanceCheckInTime').value;
                const checkOutTime = document.getElementById('attendanceCheckOutTime').value;
                const status = document.getElementById('attendanceStatus').value;
                const workHours = document.getElementById('attendanceWorkHours').value;

                // 构建完整的日期时间 - 避免时区转换问题
                let checkInDateTime = null;
                let checkOutDateTime = null;
                
                if (checkInTime) {
                    // 直接构建本地时间字符串，避免时区转换
                    checkInDateTime = `${workDate}T${checkInTime}:00`;
                }
                
                if (checkOutTime) {
                    // 直接构建本地时间字符串，避免时区转换
                    checkOutDateTime = `${workDate}T${checkOutTime}:00`;
                }

                const attendanceData = {
                    checkInTimeString: checkInDateTime,
                    checkOutTimeString: checkOutDateTime,
                    status: status,
                    actualWorkHours: workHours ? parseFloat(workHours) : null
                };

                const response = await API.put(`/staff/attendance/${currentAttendanceId}`, attendanceData);
                
                if (response && response.Success) {
                    Utils.showNotification('考勤记录更新成功', 'success');
                    Utils.hideModal('editAttendanceModal');
                    await loadAttendanceRecords(); // 刷新考勤记录列表
                } else {
                    Utils.showNotification(response?.Message || '考勤记录更新失败', 'error');
                }

            } catch (error) {
                console.error('更新考勤记录失败:', error);
                Utils.showNotification('更新考勤记录失败: ' + (error.message || '网络错误'), 'error');
            }
        }

        function editStaff(staffId) {
            const staff = allStaff.find(s => (s.StaffID || s.staffID || s.STAFFID) === staffId);
            if (!staff) return;

            // 兼容各种字段名格式
            const staffName = staff.StaffName || staff.staffName || staff.STAFFNAME;
            const gender = staff.Gender || staff.gender || staff.GENDER;
            const position = staff.Position || staff.position || staff.POSITION;
            const phone = staff.Phone || staff.phone || staff.PHONE;
            const email = staff.Email || staff.email || staff.EMAIL;
            const salary = staff.Salary || staff.salary || staff.SALARY;
            const departmentID = staff.DepartmentID || staff.departmentID || staff.DEPARTMENTID;
            const storeID = staff.StoreID || staff.storeID || staff.STOREID;

            currentStaffId = staffId;
            document.getElementById('staffModalTitle').textContent = '编辑员工信息';
            document.getElementById('staffName').value = staffName || '';
            document.getElementById('staffGender').value = gender || '';
            document.getElementById('staffPosition').value = position || '';
            document.getElementById('staffPhone').value = phone || '';
            document.getElementById('staffEmail').value = email || '';
            document.getElementById('staffSalary').value = salary || '';
            document.getElementById('staffDepartment').value = departmentID || '';
            document.getElementById('staffStore').value = storeID || '';
            Utils.showModal('addStaffModal');
        }

        async function viewStaffDetails(staffId) {
            const staff = allStaff.find(s => (s.StaffID || s.staffID || s.STAFFID) === staffId);
            if (!staff) return;

            // 兼容各种字段名格式
            const staffID = staff.StaffID || staff.staffID || staff.STAFFID;
            const staffName = staff.StaffName || staff.staffName || staff.STAFFNAME;
            const gender = staff.Gender || staff.gender || staff.GENDER;
            const position = staff.Position || staff.position || staff.POSITION;
            const phone = staff.Phone || staff.phone || staff.PHONE;
            const email = staff.Email || staff.email || staff.EMAIL;
            const salary = staff.Salary || staff.salary || staff.SALARY;
            const status = staff.Status || staff.status || staff.STATUS;
            const hireDate = staff.HireDate || staff.hireDate || staff.HIREDATE;
            const workSchedule = staff.WorkSchedule || staff.workSchedule || staff.WORKSCHEDULE;
            const departmentID = staff.DepartmentID || staff.departmentID || staff.DEPARTMENTID;
            const storeID = staff.StoreID || staff.storeID || staff.STOREID;

            document.getElementById('staffDetailTitle').textContent = `员工详情 - ${staffName}`;
            
            const statusInfo = Utils.getStatusInfo(status, 'staff');
            
            // 获取部门名称
            const department = allDepartments.find(d => 
                (d.DepartmentID || d.departmentID || d.DEPARTMENTID) === departmentID
            );
            const departmentName = department ? (department.DepartmentName || department.departmentName || department.DEPARTMENTNAME || '未知部门') : '未知部门';
            
            // 获取门店名称
            const store = allStores.find(s => 
                (s.StoreID || s.storeID || s.STOREID) === storeID
            );
            const storeName = store ? (store.StoreName || store.storeName || store.STORENAME || '未知门店') : '未知门店';
            
            const detailsHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div><strong>员工ID:</strong> ${staffID}</div>
                    <div><strong>姓名:</strong> ${staffName}</div>
                    <div><strong>性别:</strong> ${gender === 'M' ? '男' : gender === 'F' ? '女' : '未设置'}</div>
                    <div><strong>职位:</strong> ${position || '未设置'}</div>
                    <div><strong>所属部门:</strong> ${departmentName}</div>
                    <div><strong>所属门店:</strong> ${storeName}</div>
                    <div><strong>联系电话:</strong> ${phone || '未设置'}</div>
                    <div><strong>邮箱:</strong> ${email || '未设置'}</div>
                    <div><strong>薪资:</strong> ${Utils.formatCurrency(salary || 0)}/月</div>
                    <div><strong>状态:</strong> <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></div>
                    <div><strong>入职日期:</strong> ${Utils.formatDate(hireDate)}</div>
                </div>
                ${workSchedule ? `
                    <div>
                        <strong>工作安排:</strong>
                        <p style="margin-top: 0.5rem; padding: 1rem; background-color: #f8f9fa; border-radius: 4px;">${workSchedule}</p>
                    </div>
                ` : ''}
            `;

            document.getElementById('staffDetailBody').innerHTML = detailsHTML;
            currentStaffId = staffId;
            Utils.showModal('staffDetailModal');
        }

        async function loadDepartmentsAndStores() {
            try {
                // 并行加载部门和门店数据
                const [departmentsResponse, storesResponse] = await Promise.all([
                    API.get('/department'),
                    API.get('/store')
                ]);
                
                allDepartments = departmentsResponse || [];
                allStores = storesResponse || [];
                
                // 填充添加员工表单中的选择器
                const deptSelect = document.getElementById('staffDepartment');
                const storeSelect = document.getElementById('staffStore');
                
                if (deptSelect) {
                    deptSelect.innerHTML = '<option value="">请选择部门</option>';
                    allDepartments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.DepartmentID || dept.departmentID || dept.DEPARTMENTID;
                        option.textContent = dept.DepartmentName || dept.departmentName || dept.DEPARTMENTNAME || '未知部门';
                        deptSelect.appendChild(option);
                    });
                }
                
                if (storeSelect) {
                    storeSelect.innerHTML = '<option value="">请选择门店</option>';
                    allStores.forEach(store => {
                        const option = document.createElement('option');
                        option.value = store.StoreID || store.storeID || store.STOREID;
                        option.textContent = store.StoreName || store.storeName || store.STORENAME || '未知门店';
                        storeSelect.appendChild(option);
                    });
                }
                
                // 只填充部门和门店的筛选器，员工相关的筛选器在loadStaff后填充
                populateDepartmentAndStoreFilters();
                
            } catch (error) {
                console.error('加载部门或门店数据失败:', error);
                Utils.showNotification('加载部门或门店数据失败', 'error');
            }
        }

        function populateFilterSelects() {
            console.log('开始填充员工相关的筛选器...', allStaff.length, '名员工');
            
            // 填充快速打卡员工选择器（考勤Tab）
            const quickCheckStaff = document.getElementById('quickCheckStaff');
            if (quickCheckStaff) {
                quickCheckStaff.innerHTML = '<option value="">请选择员工</option>';
                const activeStaff = allStaff.filter(s => (s.Status || s.status || s.STATUS) === '在职');
                console.log('在职员工数量:', activeStaff.length);
                
                activeStaff.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.StaffID || staff.staffID || staff.STAFFID;
                    option.textContent = staff.StaffName || staff.staffName || staff.STAFFNAME || '未知员工';
                    quickCheckStaff.appendChild(option);
                    console.log('添加员工到快速打卡:', option.textContent);
                });
            }

            // 填充考勤筛选员工选择器
            const attendanceStaffFilter = document.getElementById('attendanceStaffFilter');
            if (attendanceStaffFilter) {
                attendanceStaffFilter.innerHTML = '<option value="">所有员工</option>';
                allStaff.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.StaffID || staff.staffID || staff.STAFFID;
                    option.textContent = staff.StaffName || staff.staffName || staff.STAFFNAME || '未知员工';
                    attendanceStaffFilter.appendChild(option);
                });
            }
            
            console.log('员工筛选器填充完成');
        }

        // 初始化默认日期
        function initializeDefaultDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            const startDateElement = document.getElementById('attendanceStartDate');
            const endDateElement = document.getElementById('attendanceEndDate');
            
            if (startDateElement) {
                startDateElement.value = thirtyDaysAgo.toISOString().split('T')[0];
            }
            if (endDateElement) {
                endDateElement.value = today.toISOString().split('T')[0];
            }
        }

        // 只填充部门和门店筛选器
        function populateDepartmentAndStoreFilters() {
            // 填充部门筛选器
            const departmentFilter = document.getElementById('departmentFilter');
            if (departmentFilter) {
                departmentFilter.innerHTML = '<option value="all">全部部门</option>';
                allDepartments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.DepartmentID || dept.departmentID || dept.DEPARTMENTID;
                    option.textContent = dept.DepartmentName || dept.departmentName || dept.DEPARTMENTNAME || '未知部门';
                    departmentFilter.appendChild(option);
                });
            }
            
            // 填充门店筛选器
            const storeFilter = document.getElementById('storeFilter');
            if (storeFilter) {
                storeFilter.innerHTML = '<option value="all">全部门店</option>';
                allStores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store.StoreID || store.storeID || store.STOREID;
                    option.textContent = store.StoreName || store.storeName || store.STORENAME || '未知门店';
                    storeFilter.appendChild(option);
                });
            }

            // 填充统计页面的部门筛选器
            const statsDepartmentFilter = document.getElementById('statsDepartmentFilter');
            if (statsDepartmentFilter) {
                statsDepartmentFilter.innerHTML = '<option value="">全部部门</option>';
                allDepartments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.DepartmentID || dept.departmentID || dept.DEPARTMENTID;
                    option.textContent = dept.DepartmentName || dept.departmentName || dept.DEPARTMENTNAME || '未知部门';
                    statsDepartmentFilter.appendChild(option);
                });
            }
        }

        function editCurrentStaff() {
            if (!currentStaffId) return;
            Utils.hideModal('staffDetailModal');
            editStaff(currentStaffId);
        }

        async function toggleStaffStatus(staffId, newStatus) {
            const action = newStatus === '在职' ? '复职' : '离职';
            if (!Utils.showConfirm(`确认要为该员工办理${action}手续吗？`)) {
                return;
            }

            try {
                await API.put(`/staff/${staffId}/status`, newStatus);
                Utils.showNotification(`员工${action}成功`, 'success');
                await loadStaff();
            } catch (error) {
                console.error(`员工${action}失败:`, error);
                Utils.showNotification(`员工${action}失败`, 'error');
            }
        }

        // 增强的考勤功能
        async function quickCheckIn() {
            const staffId = document.getElementById('quickCheckStaff').value;
            if (!staffId) {
                Utils.showNotification('请选择员工', 'warning');
                return;
            }

            try {
                const response = await API.post('/staff/checkin', { staffId: parseInt(staffId) });
                if (response.success) {
                    Utils.showNotification(response.message || '签到成功', 'success');
                    // 更新当前状态显示
                    await updateCurrentStatus(staffId);
                    // 刷新考勤记录
                    await loadAttendanceRecords();
                } else {
                    Utils.showNotification(response.message || '签到失败', 'error');
                }
            } catch (error) {
                console.error('签到失败:', error);
                Utils.showNotification('签到失败: ' + (error.message || '网络错误'), 'error');
            }
        }

        async function quickCheckOut() {
            const staffId = document.getElementById('quickCheckStaff').value;
            if (!staffId) {
                Utils.showNotification('请选择员工', 'warning');
                return;
            }

            try {
                const response = await API.post('/staff/checkout', { staffId: parseInt(staffId) });
                if (response.success) {
                    Utils.showNotification(response.message || '签退成功', 'success');
                    // 更新当前状态显示
                    await updateCurrentStatus(staffId);
                    // 刷新考勤记录
                    await loadAttendanceRecords();
                } else {
                    Utils.showNotification(response.message || '签退失败', 'error');
                }
            } catch (error) {
                console.error('签退失败:', error);
                Utils.showNotification('签退失败: ' + (error.message || '网络错误'), 'error');
            }
        }

        async function quickCheckOutTop() {
            const staffId = document.getElementById('quickCheckStaffTop').value;
            if (!staffId) {
                Utils.showNotification('请选择员工', 'warning');
                return;
            }

            try {
                const response = await API.post('/staff/checkout', { staffId: parseInt(staffId) });
                if (response.success) {
                    Utils.showNotification(response.message || '签退成功', 'success');
                } else {
                    Utils.showNotification(response.message || '签退失败', 'error');
                }
            } catch (error) {
                console.error('签退失败:', error);
                Utils.showNotification('签退失败: ' + (error.message || '网络错误'), 'error');
            }
        }

        // 更新当前状态显示
        async function updateCurrentStatus(staffId) {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await API.get(`/staff/attendance?staffId=${staffId}&startDate=${today}&endDate=${today}`);
                
                const statusDiv = document.getElementById('currentStatusInfo');
                if (response && response.length > 0) {
                    const record = response[0];
                    const checkInTime = record.CHECKINTIME ? new Date(record.CHECKINTIME).toLocaleTimeString('zh-CN', {hour12: false}) : '未签到';
                    const checkOutTime = record.CHECKOUTTIME ? new Date(record.CHECKOUTTIME).toLocaleTimeString('zh-CN', {hour12: false}) : '未签退';
                    const status = record.STATUS || '正常';
                    
                    statusDiv.innerHTML = `
                        <p><strong>签到时间:</strong> ${checkInTime}</p>
                        <p><strong>签退时间:</strong> ${checkOutTime}</p>
                        <p><strong>当前状态:</strong> <span class="status-badge status-${status === '正常' ? 'success' : 'warning'}">${status}</span></p>
                    `;
                } else {
                    statusDiv.innerHTML = '<p>今日暂无打卡记录</p>';
                }
            } catch (error) {
                console.error('更新状态失败:', error);
                document.getElementById('currentStatusInfo').innerHTML = '<p>状态获取失败</p>';
            }
        }

        // 更新今日排班信息显示
        async function updateTodaySchedule(staffId) {
            try {
                const today = new Date().getDay(); // 0=Sunday, 1=Monday, etc.
                const workDay = today === 0 ? 7 : today; // Convert to 1-7 format
                
                console.log('获取排班信息:', staffId, workDay);
                const response = await API.get(`/schedule/staff/${staffId}/${workDay}`);
                console.log('排班信息响应:', response);
                
                const scheduleDiv = document.getElementById('todayScheduleInfo');
                
                if (response && response.length > 0) {
                    const schedule = response[0];
                    console.log('排班详情:', schedule);
                    console.log('所有属性:', Object.keys(schedule));
                    
                    // 尝试多种可能的字段名
                    const startTime = schedule.STARTTIME || schedule.startTime || schedule.StartTime;
                    const endTime = schedule.ENDTIME || schedule.endTime || schedule.EndTime;
                    
                    console.log('解析时间:', { startTime, endTime });
                    console.log('开始时间类型:', typeof startTime, '值:', startTime);
                    console.log('结束时间类型:', typeof endTime, '值:', endTime);
                    
                    // 格式化时间显示
                    const formatTime = (time) => {
                        if (!time) return 'N/A';
                        
                        // 如果是字符串格式的TimeSpan (如 "08:00:00")
                        if (typeof time === 'string') {
                            // 如果包含冒号，可能是 HH:MM:SS 格式
                            if (time.includes(':')) {
                                const parts = time.split(':');
                                if (parts.length >= 2) {
                                    return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;
                                }
                            }
                            return time;
                        }
                        
                        // 如果是对象，可能是 TimeSpan 序列化后的格式
                        if (typeof time === 'object' && time !== null) {
                            // 检查是否有小时和分钟属性
                            if (time.hours !== undefined && time.minutes !== undefined) {
                                return `${String(time.hours).padStart(2, '0')}:${String(time.minutes).padStart(2, '0')}`;
                            }
                            // 检查是否有其他时间格式
                            if (time.totalSeconds !== undefined) {
                                const hours = Math.floor(time.totalSeconds / 3600);
                                const minutes = Math.floor((time.totalSeconds % 3600) / 60);
                                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                            }
                            return JSON.stringify(time);
                        }
                        
                        return time.toString();
                    };
                    
                    const formattedStartTime = formatTime(startTime);
                    const formattedEndTime = formatTime(endTime);
                    
                    console.log('格式化后时间:', { formattedStartTime, formattedEndTime });
                    
                    scheduleDiv.innerHTML = `
                        <p><strong>上班时间:</strong> ${formattedStartTime}</p>
                        <p><strong>下班时间:</strong> ${formattedEndTime}</p>
                        <p><strong>工作日:</strong> ${getWeekDayName(workDay)}</p>
                    `;
                } else {
                    scheduleDiv.innerHTML = '<p>今日无排班安排</p>';
                }
            } catch (error) {
                console.error('获取排班信息失败:', error);
                document.getElementById('todayScheduleInfo').innerHTML = '<p>排班信息获取失败</p>';
            }
        }

        // 员工选择变化处理
        document.addEventListener('DOMContentLoaded', function() {
            const quickCheckStaff = document.getElementById('quickCheckStaff');
            if (quickCheckStaff) {
                quickCheckStaff.addEventListener('change', function() {
                    const staffId = this.value;
                    if (staffId) {
                        updateTodaySchedule(staffId);
                        updateCurrentStatus(staffId);
                    } else {
                        document.getElementById('todayScheduleInfo').innerHTML = '<p>请先选择员工查看排班信息</p>';
                        document.getElementById('currentStatusInfo').innerHTML = '<p>暂无打卡记录</p>';
                    }
                });
            }

            // 员工姓名筛选实时搜索
            const staffNameFilter = document.getElementById('staffNameFilter');
            if (staffNameFilter) {
                staffNameFilter.addEventListener('input', function() {
                    // 延迟300ms后执行搜索，避免过于频繁的请求
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        loadAttendanceRecords();
                    }, 300);
                });
            }
        });

        // 增强的考勤记录加载功能
        async function loadAttendanceRecords() {
            try {
                const staffId = document.getElementById('attendanceStaffFilter').value;
                const startDate = document.getElementById('attendanceStartDate').value;
                const endDate = document.getElementById('attendanceEndDate').value;
                const statusFilter = document.getElementById('attendanceStatusFilter').value;
                const nameFilter = document.getElementById('staffNameFilter').value;

                let url = '/staff/attendance?';
                if (startDate) url += `startDate=${startDate}&`;
                if (endDate) url += `endDate=${endDate}&`;
                if (staffId) url += `staffId=${staffId}&`;
                if (statusFilter) url += `status=${encodeURIComponent(statusFilter)}&`;

                const response = await API.get(url);
                let attendanceRecords = response || [];

                // 客户端过滤员工姓名
                if (nameFilter) {
                    attendanceRecords = attendanceRecords.filter(record => {
                        const staffName = (record.STAFFNAME || record.staffName || '').toLowerCase();
                        return staffName.includes(nameFilter.toLowerCase());
                    });
                }

                // 存储所有记录用于分页
                allAttendanceRecords = attendanceRecords;
                attendanceCurrentPage = 1; // 重置到第一页
                renderAttendanceTable();

            } catch (error) {
                console.error('加载考勤记录失败:', error);
                Utils.showNotification('加载考勤记录失败: ' + (error.message || '网络错误'), 'error');
                allAttendanceRecords = [];
                renderAttendanceTable();
            }
        }

        // 渲染考勤表格
        function renderAttendanceTable() {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';

            // 更新总记录数
            attendanceTotalRecords = allAttendanceRecords.length;
            attendanceTotalPages = Math.ceil(attendanceTotalRecords / attendancePageSize);
            
            // 更新记录数量显示
            updateAttendanceRecordsCount();

            if (allAttendanceRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">暂无考勤记录</td></tr>';
                updateAttendancePaginationControls();
                return;
            }

            // 计算当前页的数据范围
            const startIndex = (attendanceCurrentPage - 1) * attendancePageSize;
            const endIndex = Math.min(startIndex + attendancePageSize, allAttendanceRecords.length);
            const pageData = allAttendanceRecords.slice(startIndex, endIndex);

            pageData.forEach(record => {
                const row = document.createElement('tr');
                
                // 处理Oracle数据库返回的大写字段名
                const status = record.STATUS || record.status || '正常';
                const statusInfo = getStatusInfo(status);
                
                // 格式化工作日期
                const workDate = record.WORKDATE || record.workDate;
                const formattedDate = workDate ? new Date(workDate).toLocaleDateString('zh-CN') : '-';
                
                // 格式化打卡时间
                const checkInTime = record.CHECKINTIME || record.checkInTime;
                const checkOutTime = record.CHECKOUTTIME || record.checkOutTime;
                const formattedCheckIn = checkInTime ? 
                    new Date(checkInTime).toLocaleTimeString('zh-CN', {hour12: false}) : '-';
                const formattedCheckOut = checkOutTime ? 
                    new Date(checkOutTime).toLocaleTimeString('zh-CN', {hour12: false}) : '-';
                
                // 格式化工作时长
                const workHours = record.ACTUALWORKHOURS || record.actualWorkHours || 
                                record.ActualWorkHours || record.WORKHOURS || record.workHours;
                
                // 修复工作时长显示逻辑
                let formattedWorkHours = '0h';
                if (workHours !== null && workHours !== undefined) {
                    const hours = parseFloat(workHours);
                    // 如果工作时长是正数且大于0，则显示实际时长，否则显示0h
                    if (!isNaN(hours) && hours > 0) {
                        formattedWorkHours = hours.toFixed(1) + 'h';
                    }
                }
                
                // 获取员工和部门信息
                const staffName = record.STAFFNAME || record.staffName || '未知员工';
                const departmentName = record.DEPARTMENTNAME || record.departmentName || '未知部门';
                const attendanceId = record.ATTENDANCEID || record.attendanceID;
                
                row.innerHTML = `
                    <td>${staffName}</td>
                    <td>${departmentName}</td>
                    <td>${formattedDate}</td>
                    <td>${formattedCheckIn}</td>
                    <td>${formattedCheckOut}</td>
                    <td>${formattedWorkHours}</td>
                    <td><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></td>
                    <td>
                        <button onclick="editAttendanceRecord(${attendanceId})" class="btn btn-sm btn-secondary">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // 更新分页控件
            updateAttendancePaginationControls();
        }

        // 更新考勤记录数量显示
        function updateAttendanceRecordsCount() {
            const countElement = document.getElementById('recordsCount');
            if (countElement) {
                countElement.textContent = `共 ${attendanceTotalRecords} 条记录`;
            }
        }

        // 更新考勤记录分页控件
        function updateAttendancePaginationControls() {
            // 更新分页信息
            const startIndex = (attendanceCurrentPage - 1) * attendancePageSize + 1;
            const endIndex = Math.min(attendanceCurrentPage * attendancePageSize, attendanceTotalRecords);
            const paginationInfo = document.getElementById('attendancePaginationInfo');
            if (paginationInfo) {
                paginationInfo.textContent = `显示第 ${startIndex}-${endIndex} 条，共 ${attendanceTotalRecords} 条记录`;
            }

            // 更新按钮状态
            const firstPageBtn = document.getElementById('attendanceFirstPageBtn');
            const prevPageBtn = document.getElementById('attendancePrevPageBtn');
            const nextPageBtn = document.getElementById('attendanceNextPageBtn');
            const lastPageBtn = document.getElementById('attendanceLastPageBtn');
            const pageJumpInput = document.getElementById('attendancePageJumpInput');

            if (firstPageBtn) firstPageBtn.disabled = attendanceCurrentPage === 1;
            if (prevPageBtn) prevPageBtn.disabled = attendanceCurrentPage === 1;
            if (nextPageBtn) nextPageBtn.disabled = attendanceCurrentPage === attendanceTotalPages || attendanceTotalPages === 0;
            if (lastPageBtn) lastPageBtn.disabled = attendanceCurrentPage === attendanceTotalPages || attendanceTotalPages === 0;
            if (pageJumpInput) pageJumpInput.max = attendanceTotalPages;

            // 生成页码按钮
            generateAttendancePageNumbers();
        }

        // 生成考勤记录页码按钮
        function generateAttendancePageNumbers() {
            const pageNumbers = document.getElementById('attendancePageNumbers');
            if (!pageNumbers) return;

            pageNumbers.innerHTML = '';

            if (attendanceTotalPages <= 1) return;

            // 计算显示的页码范围
            const maxVisiblePages = 5;
            let startPage = Math.max(1, attendanceCurrentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(attendanceTotalPages, startPage + maxVisiblePages - 1);

            // 调整开始页码
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // 添加页码按钮
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `btn btn-sm ${i === attendanceCurrentPage ? 'btn-primary' : 'btn-outline-secondary'}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToAttendancePage(i);
                pageNumbers.appendChild(pageBtn);
            }
        }

        // 考勤记录分页导航函数
        function goToAttendancePage(page) {
            if (page < 1 || page > attendanceTotalPages) return;
            attendanceCurrentPage = page;
            renderAttendanceTable();
        }

        function goToAttendanceFirstPage() {
            goToAttendancePage(1);
        }

        function goToAttendancePrevPage() {
            if (attendanceCurrentPage > 1) {
                attendanceCurrentPage--;
                renderAttendanceTable();
            }
        }

        function goToAttendanceNextPage() {
            if (attendanceCurrentPage < attendanceTotalPages) {
                attendanceCurrentPage++;
                renderAttendanceTable();
            }
        }

        function goToAttendanceLastPage() {
            attendanceCurrentPage = attendanceTotalPages;
            renderAttendanceTable();
        }

        function jumpToAttendancePage() {
            const pageInput = document.getElementById('attendancePageJumpInput');
            const page = parseInt(pageInput.value);
            if (page && page >= 1 && page <= attendanceTotalPages) {
                goToAttendancePage(page);
                pageInput.value = '';
            } else {
                Utils.showNotification('请输入有效的页码', 'warning');
            }
        }

        function changeAttendancePageSize() {
            const pageSizeSelect = document.getElementById('attendancePageSize');
            attendancePageSize = parseInt(pageSizeSelect.value);
            attendanceCurrentPage = 1; // 重置到第一页
            renderAttendanceTable();
        }

        // 更新记录数量显示（保持向后兼容）
        function updateRecordsCount(count) {
            updateAttendanceRecordsCount();
        }

        // 获取状态信息
        function getStatusInfo(status) {
            const statusMap = {
                '正常': { text: '正常', class: 'status-success' },
                '迟到': { text: '迟到', class: 'status-warning' },
                '早退': { text: '早退', class: 'status-orange' },
                '缺勤': { text: '缺勤', class: 'status-danger' }
            };
            return statusMap[status] || { text: status || '未知', class: 'status-secondary' };
        }

        // 增强的重置筛选功能
        function resetAttendanceFilter() {
            document.getElementById('attendanceStaffFilter').value = '';
            document.getElementById('attendanceStartDate').value = '';
            document.getElementById('attendanceEndDate').value = '';
            document.getElementById('attendanceStatusFilter').value = '';
            document.getElementById('staffNameFilter').value = '';
            
            // 设置默认日期（最近30天）
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            document.getElementById('attendanceStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('attendanceEndDate').value = today.toISOString().split('T')[0];
            
            loadAttendanceRecords();
        }

        // 获取星期名称
        function getWeekDayName(day) {
            const days = ['', '周一', '周二', '周三', '周四', '周五', '周六', '周日'];
            return days[day] || '未知';
        }

        // 编辑考勤记录
        async function editAttendanceRecord(attendanceId) {
            try {
                // 从所有考勤记录中找到要编辑的记录
                const record = allAttendanceRecords.find(r => 
                    (r.ATTENDANCEID || r.attendanceID || r.AttendanceID) == attendanceId
                );
                
                if (!record) {
                    console.error('未找到考勤记录:', attendanceId, '可用记录:', allAttendanceRecords);
                    Utils.showNotification('未找到考勤记录', 'error');
                    return;
                }
                
                console.log('找到考勤记录:', record);
                currentAttendanceId = attendanceId;
                
                // 填充表单数据
                const staffName = record.STAFFNAME || record.staffName || record.StaffName || '未知员工';
                const workDate = record.WORKDATE || record.workDate || record.WorkDate;
                const checkInTime = record.CHECKINTIME || record.checkInTime || record.CheckInTime;
                const checkOutTime = record.CHECKOUTTIME || record.checkOutTime || record.CheckOutTime;
                const status = record.STATUS || record.status || record.Status || '正常';
                const workHours = record.ACTUALWORKHOURS || record.actualWorkHours || record.ActualWorkHours || 0;
                
                document.getElementById('attendanceStaffName').value = staffName;
                
                // 格式化日期
                if (workDate) {
                    const date = new Date(workDate);
                    document.getElementById('attendanceWorkDate').value = date.toISOString().split('T')[0];
                }
                
                // 格式化时间 - 避免时区转换问题
                if (checkInTime) {
                    const checkIn = new Date(checkInTime);
                    const hours = checkIn.getHours().toString().padStart(2, '0');
                    const minutes = checkIn.getMinutes().toString().padStart(2, '0');
                    document.getElementById('attendanceCheckInTime').value = `${hours}:${minutes}`;
                }
                
                if (checkOutTime) {
                    const checkOut = new Date(checkOutTime);
                    const hours = checkOut.getHours().toString().padStart(2, '0');
                    const minutes = checkOut.getMinutes().toString().padStart(2, '0');
                    document.getElementById('attendanceCheckOutTime').value = `${hours}:${minutes}`;
                }
                
                document.getElementById('attendanceStatus').value = status;
                document.getElementById('attendanceWorkHours').value = parseFloat(workHours || 0).toFixed(1);
                
                Utils.showModal('editAttendanceModal');
                
            } catch (error) {
                console.error('编辑考勤记录失败:', error);
                Utils.showNotification('编辑考勤记录失败: ' + error.message, 'error');
            }
        }

        // 生成统计报表并导出为Excel
        async function generateStatistics() {
            try {
                // 切换到考勤统计Tab
                switchTab('statistics');
                
                // 显示加载提示
                Utils.showNotification('正在生成统计报表...', 'info');
                
                // 先加载统计数据到页面
                await loadAttendanceStatistics();
                
                // 获取考勤统计数据
                const startDate = document.getElementById('statsStartDate').value;
                const endDate = document.getElementById('statsEndDate').value;
                const departmentId = document.getElementById('statsDepartmentFilter').value;

                let url = '/staff/attendance/statistics?';
                const params = new URLSearchParams();
                
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (departmentId) params.append('departmentId', departmentId);
                
                url += params.toString();
                
                console.log('请求URL:', url);
                const statisticsData = await API.get(url);
                console.log('统计数据:', statisticsData);
                
                if (!statisticsData || statisticsData.length === 0) {
                    Utils.showNotification('没有找到统计数据', 'warning');
                    return;
                }
                
                // 调试：打印第一条记录的所有属性
                if (statisticsData.length > 0) {
                    console.log('第一条记录的所有属性:', Object.keys(statisticsData[0]));
                    console.log('第一条记录:', statisticsData[0]);
                }
                
                // 生成Excel文件
                generateExcelReport(statisticsData, startDate, endDate);
                
            } catch (error) {
                console.error('生成统计报表失败:', error);
                Utils.showNotification('生成统计报表失败: ' + error.message, 'error');
            }
        }
        
        // 生成Excel报表
        function generateExcelReport(data, startDate, endDate) {
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            
            // 准备数据
            const wsData = [
                // 表头
                ['员工姓名', '部门', '总打卡天数', '正常天数', '迟到天数', '早退天数', '缺勤天数', '总工时', '平均工时', '出勤率']
            ];
            
            // 添加数据行
            data.forEach(record => {
                wsData.push([
                    record.STAFFNAME || record.staffName || record.StaffName || '未知员工',
                    record.DEPARTMENTNAME || record.departmentName || record.DepartmentName || '未知部门',
                    record.TOTALDAYS || record.totalDays || record.TotalDays || 0,
                    record.NORMALDAYS || record.normalDays || record.NormalDays || 0,
                    record.LATEDAYS || record.lateDays || record.LateDays || 0,
                    record.EARLYLEAVEDAYS || record.earlyLeaveDays || record.EarlyLeaveDays || 0,
                    record.ABSENTDAYS || record.absentDays || record.AbsentDays || 0,
                    (record.TOTALWORKHOURS || record.totalWorkHours || record.TotalWorkHours || 0).toFixed(1) + 'h',
                    (record.AVGWORKHOURS || record.averageWorkHours || record.AverageWorkHours || 0).toFixed(1) + 'h',
                    (record.ATTENDANCERATE || record.attendanceRate || record.AttendanceRate || 0).toFixed(1) + '%'
                ]);
            });
            
            // 创建工作表
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // 设置列宽
            const colWidths = [
                { wch: 12 }, // 员工姓名
                { wch: 12 }, // 部门
                { wch: 12 }, // 总打卡天数
                { wch: 10 }, // 正常天数
                { wch: 10 }, // 迟到天数
                { wch: 10 }, // 早退天数
                { wch: 10 }, // 缺勤天数
                { wch: 10 }, // 总工时
                { wch: 10 }, // 平均工时
                { wch: 10 }  // 出勤率
            ];
            ws['!cols'] = colWidths;
            
            // 添加工作表到工作簿
            XLSX.utils.book_append_sheet(wb, ws, '考勤统计');
            
            // 生成文件名
            const dateRange = startDate && endDate ? `${startDate}_${endDate}` : new Date().toISOString().split('T')[0];
            const fileName = `考勤统计报表_${dateRange}.xlsx`;
            
            // 下载文件
            XLSX.writeFile(wb, fileName);
            
            Utils.showNotification('统计报表已生成并下载: ' + fileName, 'success');
        }

        // 加载考勤统计
        async function loadAttendanceStatistics() {
            try {
                const startDate = document.getElementById('statsStartDate').value;
                const endDate = document.getElementById('statsEndDate').value;
                const departmentId = document.getElementById('statsDepartmentFilter').value;

                let url = '/staff/attendance/statistics?';
                if (startDate) url += `startDate=${startDate}&`;
                if (endDate) url += `endDate=${endDate}&`;
                if (departmentId) url += `departmentId=${departmentId}&`;

                const statistics = await API.get(url);
                renderStatisticsTable(statistics);

            } catch (error) {
                console.error('加载考勤统计失败:', error);
                Utils.showNotification('加载考勤统计失败', 'error');
            }
        }

        // 渲染统计表格
        function renderStatisticsTable(statistics) {
            const tbody = document.getElementById('statisticsTableBody');
            tbody.innerHTML = '';

            if (statistics.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666;">暂无统计数据</td></tr>';
                return;
            }

            statistics.forEach(stat => {
                const row = document.createElement('tr');
                
                // 处理Oracle数据库返回的大写字段名
                const staffName = stat.STAFFNAME || stat.staffName || '未知员工';
                const departmentName = stat.DEPARTMENTNAME || stat.departmentName || '未知部门';
                const totalDays = stat.TOTALDAYS || stat.totalDays || 0;
                const normalDays = stat.NORMALDAYS || stat.normalDays || 0;
                const lateDays = stat.LATEDAYS || stat.lateDays || 0;
                const earlyLeaveDays = stat.EARLYLEAVEDAYS || stat.earlyLeaveDays || 0;
                const absentDays = stat.ABSENTDAYS || stat.absentDays || 0;
                const totalWorkHours = stat.TOTALWORKHOURS || stat.totalWorkHours || 0;
                const avgWorkHours = stat.AVGWORKHOURS || stat.avgWorkHours || 0;
                const attendanceRate = stat.ATTENDANCERATE || stat.attendanceRate || 0;
                
                // 计算出勤率样式
                let attendanceRateClass = 'attendance-rate ';
                if (attendanceRate >= 95) {
                    attendanceRateClass += 'excellent';
                } else if (attendanceRate >= 85) {
                    attendanceRateClass += 'good';
                } else {
                    attendanceRateClass += 'poor';
                }
                
                // 处理工作时长显示
                const totalWorkHoursNum = parseFloat(totalWorkHours) || 0;
                const avgWorkHoursNum = parseFloat(avgWorkHours) || 0;
                const formattedTotalHours = totalWorkHoursNum > 0 ? totalWorkHoursNum.toFixed(1) + 'h' : '0.0h';
                const formattedAvgHours = avgWorkHoursNum > 0 ? avgWorkHoursNum.toFixed(1) + 'h' : '0.0h';
                
                row.innerHTML = `
                    <td>${staffName}</td>
                    <td>${departmentName}</td>
                    <td>${totalDays}</td>
                    <td><span class="status-badge status-success">${normalDays}</span></td>
                    <td><span class="status-badge status-warning">${lateDays}</span></td>
                    <td><span class="status-badge status-orange">${earlyLeaveDays}</span></td>
                    <td><span class="status-badge status-danger">${absentDays}</span></td>
                    <td>${formattedTotalHours}</td>
                    <td>${formattedAvgHours}</td>
                    <td><span class="${attendanceRateClass}">${parseFloat(attendanceRate).toFixed(1)}%</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // 重置考勤筛选条件
        function resetAttendanceFilter() {
            document.getElementById('attendanceStaffFilter').value = '';
            document.getElementById('attendanceDateStart').value = '';
            document.getElementById('attendanceDateEnd').value = '';
            loadAttendanceRecords();
        }

        // 设置默认日期（最近30天）
        function setDefaultDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            document.getElementById('attendanceDateStart').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('attendanceDateEnd').value = today.toISOString().split('T')[0];
            
            document.getElementById('statsStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('statsEndDate').value = today.toISOString().split('T')[0];
        }

        function showScheduleTab(staffId) {
            switchTab('schedule');
            // 可扩展：在排班Tab内根据staffId加载该员工排班信息
            // 例如：document.getElementById('staffId').value = staffId;
        }

        async function deleteStaff(staffId) {
            // 先查找员工状态
            const staff = allStaff.find(s => (s.StaffID || s.staffID || s.STAFFID) === staffId);
            const status = staff ? (staff.Status || staff.status || staff.STATUS) : null;
            if (status === '在职') {
                alert('员工未离职，不能删除。请先将员工状态设置为离职。');
                return;
            }
            if (!confirm('确定要删除该员工吗？此操作不可恢复！')) return;
            try {
                const res = await fetch(`/api/staff/${staffId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.Success) {
                    alert('删除成功');
                    await loadStaff();
                } else {
                    alert(result.Message || '删除失败');
                }
            } catch (err) {
                alert('删除失败：' + err);
            }
        }
    </script>

    <style>
        /* Tab导航样式 */
        .tab-navigation {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .tab-btn:hover {
            color: #495057;
            background-color: #f8f9fa;
        }

        .tab-btn.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background-color: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 考勤状态样式 */
        .status-badge.status-success {
            background-color: #28a745;
            color: white;
        }

        .status-badge.status-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .status-badge.status-orange {
            background-color: #fd7e14;
            color: white;
        }

        .status-badge.status-danger {
            background-color: #dc3545;
            color: white;
        }

        .status-badge.status-secondary {
            background-color: #6c757d;
            color: white;
        }

        /* 出勤率样式 */
        .attendance-rate.excellent {
            color: #28a745;
            font-weight: bold;
        }

        .attendance-rate.good {
            color: #ffc107;
            font-weight: bold;
        }

        .attendance-rate.poor {
            color: #dc3545;
            font-weight: bold;
        }

        /* 当前时间显示 */
        .current-time {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .current-time i {
            color: #007bff;
            margin-right: 5px;
        }

        /* 统计卡片优化 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #e9ecef;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .tab-navigation {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                padding: 8px 16px;
                font-size: 13px;
                margin-bottom: 5px;
            }
            
            .search-filters {
                flex-direction: column;
            }
            
            .search-filters .form-group {
                margin-bottom: 1rem;
            }
        }

        /* 增强的考勤功能样式 */
        .filters-enhanced {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: #495057;
        }

        .filter-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 0.5rem;
            justify-content: flex-start;
            margin-top: 1rem;
        }

        .attendance-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .attendance-actions .btn {
            flex: 1;
            padding: 0.75rem;
            font-size: 1rem;
            border-radius: 8px;
        }

        .today-schedule, .current-status {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #dee2e6;
        }

        .today-schedule h4, .current-status h4 {
            margin: 0 0 0.75rem 0;
            color: #495057;
            font-size: 1rem;
            font-weight: 600;
        }

        .schedule-info, .status-info {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .schedule-info p, .status-info p {
            margin: 0.25rem 0;
        }

        .records-info {
            padding: 0.5rem 0;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #6c757d;
            border-bottom: 1px solid #dee2e6;
        }

        .text-center {
            text-align: center;
        }

        .btn i {
            margin-right: 0.25rem;
        }

        /* 增强的状态徽章 */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }

        /* 分页样式 */
        .staff-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 1rem;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-size-selector label {
            font-size: 0.9rem;
            color: #6c757d;
            margin: 0;
        }

        .page-size-selector select {
            width: auto;
            min-width: 80px;
            padding: 0.25rem 0.5rem;
            font-size: 0.9rem;
        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-top: 1px solid #dee2e6;
            margin-top: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .pagination-info {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-numbers {
            display: flex;
            gap: 0.25rem;
        }

        .page-numbers .btn {
            min-width: 40px;
        }

        .page-jump {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .page-jump input {
            width: 60px;
            padding: 0.25rem 0.5rem;
            text-align: center;
            font-size: 0.9rem;
        }

        /* 响应式优化 */
        @media (max-width: 992px) {
            .filters-enhanced {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .filters-enhanced {
                grid-template-columns: 1fr;
            }
            
            .attendance-actions {
                flex-direction: column;
            }
            
            .filter-actions {
                flex-direction: column;
            }

            .staff-info-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .pagination-container {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            .pagination-controls {
                justify-content: center;
                flex-wrap: wrap;
            }

            .page-jump {
                justify-content: center;
            }
        }
    </style>
</body>
</html>
